<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Qinng</title>
  <icon>https://www.gravatar.com/avatar/b0015a53e4c7f5def73fd76d56ecadf9</icon>
  <subtitle>Qinng</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://qinng.now.sh/"/>
  <updated>2021-03-02T09:52:05.799Z</updated>
  <id>https://qinng.now.sh/</id>
  
  <author>
    <name>Qinng</name>
    <email>isguory@gmail.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>golang zk大量disconnected event</title>
    <link href="https://qinng.now.sh/golang-zk-statedisconnected/"/>
    <id>https://qinng.now.sh/golang-zk-statedisconnected/</id>
    <published>2021-03-02T09:16:23.000Z</published>
    <updated>2021-03-02T09:52:05.799Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在容器平台上我们提供了<code>zk</code>做白名单功能，<code>Pod</code>启动时 sidecar会自动注册<code>zk</code>。昨天遇到<code>zk server</code>抖动，<code>sidecar</code>容器输出大量<code>StateDisconnected</code>事件，zk正常后仍无法恢复，由于大量日志造成<code>sidecar</code>容器 cpu占用过高，进而引发<code>dockerd</code>cpu占用过高，严重时影响dockerd正常调用。</p><h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><h3 id="问题复现"><a href="#问题复现" class="headerlink" title="问题复现"></a>问题复现</h3><p>正常情况下，<code>sidecar</code>启动后会去注册<code>zk</code>：</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># docker logs -f 01a1a4a74785</span>I0302 15:04:05.476463       1 manager.go:116<span class="token punctuation">]</span> start run plugin zk2021/03/02 15:04:05 Connected to 10.38.161.60:11000I0302 15:04:05.488006       1 zk.go:152<span class="token punctuation">]</span> zookeeper connect succeed: zk.srv:110002021/03/02 15:04:05 authenticated: id<span class="token operator">=</span>33746806328105493, timeout<span class="token operator">=</span>300002021/03/02 15:04:05 re-submitting <span class="token variable"><span class="token variable">`</span>0<span class="token variable">`</span></span> credentials after reconnectI0302 15:04:05.516446       1 zk.go:220<span class="token punctuation">]</span> watching zk node:<span class="token punctuation">[</span>/tasks/cluster.xxx_default_deployment.htool/10.46.12.72<span class="token punctuation">]</span> <span class="token keyword">in</span> cluster<span class="token punctuation">[</span>xxx<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">#注册成功，开始watch</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过<code>iptable</code>s来模拟异常，首先进入到容器<code>network namesapce</code></p><pre class="line-numbers language-bash"><code class="language-bash">pod<span class="token operator">=</span>htool-6875bcb898-w7llccontainerid<span class="token operator">=</span><span class="token punctuation">$(</span>docker <span class="token function">ps</span> <span class="token operator">|</span><span class="token function">grep</span> <span class="token variable">$pod</span><span class="token operator">|</span><span class="token function">awk</span> <span class="token string">'{print <span class="token variable">$1</span>}'</span><span class="token operator">|</span><span class="token function">head</span> -n 1<span class="token punctuation">)</span>pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>docker inspect -f <span class="token punctuation">{</span><span class="token punctuation">{</span>.State.Pid<span class="token punctuation">}</span><span class="token punctuation">}</span> $containerid<span class="token variable">)</span></span>nsenter -n --target <span class="token variable">$pid</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>使用<code>iptables</code> <code>drop</code>掉发往<code>zk</code>的请求(11000为zk server端口)</p><pre class="line-numbers language-bash"><code class="language-bash">iptables -A OUTPUT -p tcp -m tcp --dport 11000 -j DROP<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>zk client自动重试（1s一次），日志显示<code>Failed to connect to 10.38.161.54:11000: dial tcp 10.38.161.54:11000: i/o timeout</code></p><pre class="line-numbers language-bash"><code class="language-bash">I0302 15:04:05.516446       1 zk.go:220<span class="token punctuation">]</span> watching zk node:<span class="token punctuation">[</span>/tasks/cluster.xxx_default_deployment.htool/10.46.12.72<span class="token punctuation">]</span> <span class="token keyword">in</span> cluster<span class="token punctuation">[</span>xxx<span class="token punctuation">]</span>2021/03/02 15:08:55 recv loop terminated: err<span class="token operator">=</span>failed to <span class="token function">read</span> from connection: <span class="token function">read</span> tcp 10.46.12.72:36884-<span class="token operator">></span>10.38.161.60:11000: i/o <span class="token function">timeout</span>2021/03/02 15:08:55 send loop terminated: err<span class="token operator">=</span><span class="token operator">&lt;</span>nil<span class="token operator">></span>2021/03/02 15:08:56 Failed to connect to 10.38.161.54:11000: dial tcp 10.38.161.54:11000: i/o <span class="token function">timeout</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>网络恢复，删除<code>iptables</code></p><pre class="line-numbers language-bash"><code class="language-bash">iptables -D OUTPUT -p tcp -m tcp --dport 11000 -j DROP<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>出现大量<code>StateDisconnected</code>日志</p><pre class="line-numbers language-bash"><code class="language-bash">I0302 15:09:50.951897       1 zk.go:232<span class="token punctuation">]</span> Unknown zk event<span class="token punctuation">[</span>StateDisconnected<span class="token punctuation">]</span> <span class="token keyword">for</span> znode:<span class="token punctuation">[</span>/tasks/cluster.xxx_default_deployment.htool/10.46.12.72<span class="token punctuation">]</span>I0302 15:09:50.951893       1 zk.go:232<span class="token punctuation">]</span> Unknown zk event<span class="token punctuation">[</span>StateDisconnected<span class="token punctuation">]</span> <span class="token keyword">for</span> znode:<span class="token punctuation">[</span>/tasks/cluster.xxx_default_deployment.htool/10.46.12.72<span class="token punctuation">]</span><span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="问题分析-1"><a href="#问题分析-1" class="headerlink" title="问题分析"></a>问题分析</h3><p><code>sidecar</code>中zk watch代码如下：</p><pre class="line-numbers language-golang"><code class="language-golang">exist, _, eventCh, err := conn.ExistsW(node) //监听zk事件watcher:        for {                select {                case e := <-eventCh:                        switch e.State {                        case zk.StateExpired:                                return fmt.Errorf("node[%v] expired", node)                        case zk.StateConnected, zk.StateHasSession:                                return fmt.Errorf("Get zk event: %v ", e.State)                        default:                                klog.Infof("Get zk event[%v] for znode:[%v]", e.State, node) // 出错位置                        }                case <-ctx.Done():                        // we close the conn in caller                        break watcher                }        }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>ExistsW</code>函数由<code>github.com/samuel/go-zookeeper/zk</code>库提供，监听zk给定目录的事件</p><pre class="line-numbers language-golang"><code class="language-golang">func (c *Conn) ExistsW(path string) (bool, *Stat, <-chan Event, error) {    var ech <-chan Event    ...    ech = c.addWatcher(path, watchTypeData)    return exists, &res.Stat, ech, err}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当zk异常恢复后，<code>c.addWatcher</code>中的<code>channel</code>被<code>close</code>，即<code>sidecar</code>中<code>eventCh</code>关闭，进入死循环。</p><h3 id="修复验证"><a href="#修复验证" class="headerlink" title="修复验证"></a>修复验证</h3><p>知道了原因，修复很简单，判断下eventCh状态即可</p><pre class="line-numbers language-golang"><code class="language-golang">    for {        select {        case e, ok := <-eventCh:            if !ok {                return fmt.Errorf("event channel closed")            }            if e.Err != nil {                return fmt.Errorf("Get zk event: %v, err: %v", e.State, e.Err)            }            switch e.State {            case zk.StateExpired:                return fmt.Errorf("node[%v] expired", node)            case zk.StateConnected, zk.StateHasSession:                return fmt.Errorf("Get zk event: %v ", e.State)            default:                klog.Infof("Get zk event[%v] for znode:[%v]", e.State, node)            }        }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在修复代码后，再次验证可正常注册</p><pre class="line-numbers language-golang"><code class="language-golang">2021/03/02 15:13:40 Failed to connect to 10.38.161.60:11000: dial tcp 10.38.161.60:11000: i/o timeout2021/03/02 15:13:40 Connected to 10.38.161.55:110002021/03/02 15:13:40 authentication failed: zk: session has been expired by the serverW0302 15:13:40.222923       1 zk.go:300] meet error when watching node path: Get zk event: StateDisconnected, err: zk: session has been expired by the server2021/03/02 15:13:40 Connected to 10.38.161.54:110002021/03/02 15:13:40 authenticated: id=177861994644216038, timeout=300002021/03/02 15:13:40 re-submitting `1` credentials after reconnectI0302 15:13:41.238524       1 zk.go:220] watching zk node:[/tasks/cluster.xxx_default_deployment.htool/10.46.12.72] in cluster[xxx]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这个问题其实与<code>zk</code>没关系，是由于没有判断<code>channel</code>状态，陷入死循环。通常情况下大部分应用只有退出时才会关闭<code>channel</code>，不需要特殊处理。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;在容器平台上我们提供了&lt;code&gt;zk&lt;/code&gt;做白名单功能，&lt;code&gt;Pod&lt;/code&gt;启动时 sidecar会自动注册&lt;code
      
    
    </summary>
    
      <category term="coding" scheme="https://qinng.now.sh/categories/coding/"/>
    
    
      <category term="golang" scheme="https://qinng.now.sh/tags/golang/"/>
    
      <category term="zk" scheme="https://qinng.now.sh/tags/zk/"/>
    
  </entry>
  
  <entry>
    <title>k8s中shell脚本启动如何传递信号</title>
    <link href="https://qinng.now.sh/docker-shell-signal/"/>
    <id>https://qinng.now.sh/docker-shell-signal/</id>
    <published>2021-02-03T07:13:10.000Z</published>
    <updated>2021-02-04T07:39:19.543Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在k8s或docker中，有时候我们需要通过shell来启动程序，但是默认shell不会传递信号（sigterm）给子进程，当在pod终止时应用无法优雅退出，直到最大时间时间后强制退出（<code>kill -9</code>）。</p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>普通情况下，大多业务的启动命令如下</p><pre class="line-numbers language-bash"><code class="language-bash">command: <span class="token punctuation">[</span><span class="token string">"binary"</span>, <span class="token string">"-flags"</span>, <span class="token punctuation">..</span>.<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>主进程做为1号进程会收到<code>sigterm</code>信号，优雅退出(需要程序捕获信号); 而通过脚本启动时，<code>shell</code>作为1号进程，不会显示传递信号给子进程，造成子进程无法优雅退出，直到最大退出时间后强制终止。</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="exec"><a href="#exec" class="headerlink" title="exec"></a>exec</h3><p>如何只需一个进程收到信号，可通过<code>exec</code>，<code>exec</code>会替换当前shell进程，即<code>pid</code>不变</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token shebang important">#! /bin/bash</span><span class="token comment" spellcheck="true"># do something</span><span class="token function">exec</span> binay -flags <span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>正常情况测试命令如下，使用sleep来模拟应用<code>sh -c &#39;echo &quot;start&quot;; sleep 100&#39;</code>：<br><code>pstree</code>展示如下，<code>sleep</code>进程会生成一个子进程</p><pre><code>bash(28701)───sh(24588)───sleep(24589)</code></pre><p>通过<code>exec</code>运行后，命令<code>sh -c &#39;echo &quot;start&quot;; exec sleep 100&#39;</code></p><pre><code>bash(28701)───sleep(24664)</code></pre><p>加入<code>exec</code>后，<code>sleep</code>进程替换了shell进程，没有生成子进程</p><p>此种方式可以收到信号，但只适用于一个子进程的情况</p><h3 id="trap"><a href="#trap" class="headerlink" title="trap"></a>trap</h3><p>在shell中可以显示通过<code>trap</code>捕捉信号传递给子进程</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token keyword">echo</span> <span class="token string">"start"</span>binary -flags<span class="token punctuation">..</span>. <span class="token operator">&amp;</span>pid<span class="token operator">=</span><span class="token string">"<span class="token variable">$!</span>"</span>_kill<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">echo</span> <span class="token string">"receive sigterm"</span>  <span class="token function">kill</span> <span class="token variable">$pid</span> <span class="token comment" spellcheck="true">#传递给子进程</span>  <span class="token function">wait</span> <span class="token variable">$pid</span>  <span class="token keyword">exit</span> 0<span class="token punctuation">}</span><span class="token function">trap</span> _kill SIGTERM <span class="token comment" spellcheck="true">#捕获信号</span><span class="token function">wait</span> <span class="token comment" spellcheck="true">#等待子进程退出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此种方式需要改动启动脚本，显示传递信号给子进程</p><h2 id="docker-init"><a href="#docker-init" class="headerlink" title="docker-init"></a>docker-init</h2><p><a href="https://docs.docker.com/engine/reference/run/#specify-an-init-process" target="_blank" rel="noopener">docker-init</a>即在docker启动时加入<code>--init</code>参数，docker-int会作为一号进程，会向子进程传递信号并且会回收僵尸进程。</p><p>遗憾的是k8s并不支持<code>--init</code>参数，用户可在镜像中声明init进程，更多可参考<a href="./container-init.md">container-init</a></p><pre class="line-numbers language-Dockerfile"><code class="language-Dockerfile">RUN wget -O /usr/bin/dumb-init https://github.com/Yelp/dumb-init/releases/download/v1.2.2/dumb-init_1.2.2_amd64RUN chmod +x /usr/bin/dumb-initENTRYPOINT ["/usr/bin/dumb-init", "-v", "--"]CMD ["nginx", "-g", "daemon off;"]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;在k8s或docker中，有时候我们需要通过shell来启动程序，但是默认shell不会传递信号（sigterm）给子进程，当在pod终止时
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="docker" scheme="https://qinng.now.sh/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>优化Kubernetes集群内DNS</title>
    <link href="https://qinng.now.sh/k8s-dns-optimize/"/>
    <id>https://qinng.now.sh/k8s-dns-optimize/</id>
    <published>2021-02-01T02:17:40.000Z</published>
    <updated>2021-02-03T07:13:09.478Z</updated>
    
    <content type="html"><![CDATA[<p>kubernetes集群内置的dns插件<code>kubedns/coredns</code>在高并发情况下可能遇到性能瓶颈，以下从配置与本地缓存方面说明如何减少dns查询失败率，提高性能。</p><h2 id="配置优化"><a href="#配置优化" class="headerlink" title="配置优化"></a>配置优化</h2><h3 id="dnsPolicy"><a href="#dnsPolicy" class="headerlink" title="dnsPolicy"></a>dnsPolicy</h3><p>k8s 默认的 <code>dnsPolicy</code> 是<code>ClusterFirst</code>，因为 <code>ndots</code> 和 <code>serach domain</code> 在访问外部 dns 会有额外的查询次数。</p><pre class="line-numbers language-bash"><code class="language-bash">/ <span class="token comment" spellcheck="true"># cat /etc/resolv.conf </span>nameserver 10.254.0.2search default.svc.cluster.local svc.cluster.local cluster.localoptions ndots:5/ <span class="token comment" spellcheck="true"># </span>/ <span class="token comment" spellcheck="true"># </span>/ <span class="token comment" spellcheck="true">#  host -v mi.com</span>Trying <span class="token string">"mi.com.default.svc.cluster.local"</span>Trying <span class="token string">"mi.com.svc.cluster.local"</span>Trying <span class="token string">"mi.com.cluster.local"</span>Trying <span class="token string">"mi.com"</span><span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">>></span>HEADER<span class="token operator">&lt;&lt;</span>- opcode: QUERY, status: NOERROR, id: 38967<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr rd ra<span class="token punctuation">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:<span class="token punctuation">;</span>mi.com.                                IN        A<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:mi.com.                        30        IN        A        58.83.160.156<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果不访问service，调整<code>dnsPolicy</code>为<code>Default</code>，直接走宿主机的dns</p><h3 id="ndots"><a href="#ndots" class="headerlink" title="ndots"></a>ndots</h3><p>如需访问service，尽量减少<code>ndots</code>（默认5）即域名中点的个数小于<code>ndots</code>会按照search域（mi.com.default.svc.cluster.local）依次查询，若查询不到再查询原始域名，总共进行8次dns查询（4次ipv4, 4次ipv6）</p><p>设置<code>ndots</code>为1后，只有两次查询（1次ipv4, ipv6）</p><pre class="line-numbers language-bash"><code class="language-bash">/ <span class="token comment" spellcheck="true">#  host -v mi.com</span>Trying <span class="token string">"mi.com"</span><span class="token punctuation">;</span><span class="token punctuation">;</span> -<span class="token operator">>></span>HEADER<span class="token operator">&lt;&lt;</span>- opcode: QUERY, status: NOERROR, id: 23894<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr rd ra<span class="token punctuation">;</span> QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:<span class="token punctuation">;</span>mi.com.                                IN        A<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:mi.com.                        30        IN        A        58.83.160.156<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>但此种方式service域名分割大于等于<code>ndots</code>，则解析不到，需要业务自行判断合适的<code>ndots</code>值</p><pre class="line-numbers language-bash"><code class="language-bash">/ <span class="token comment" spellcheck="true">#  host -v prometheus.kube-system</span>Trying <span class="token string">"prometheus.kube-system"</span>Host prometheus.kube-system not found: 3<span class="token punctuation">(</span>NXDOMAIN<span class="token punctuation">)</span>Received 115 bytes from 10.254.0.2<span class="token comment" spellcheck="true">#53 in 8 ms</span>Received 115 bytes from 10.254.0.2<span class="token comment" spellcheck="true">#53 in 8 ms</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="coredns优化"><a href="#coredns优化" class="headerlink" title="coredns优化"></a>coredns优化</h3><p>调整合理的副本数，阿里建议<code>coredns:node=1:8</code>，启动<code>AutoPath</code>插件减少查询次数，见<a href="2">DNS性能优化</a></p><h2 id="DNS缓存"><a href="#DNS缓存" class="headerlink" title="DNS缓存"></a>DNS缓存</h2><h3 id="NodeLocalDNS"><a href="#NodeLocalDNS" class="headerlink" title="NodeLocalDNS"></a>NodeLocalDNS</h3><p>NodeLocal DNSCache 通过在集群节点上作为 DaemonSet 运行 dns 缓存代理来提高集群 DNS 性能，<br>借助这种新架构，Pods 将可以访问在同一节点上运行的 dns 缓存代理，从而避免了 iptables DNAT 规则和连接跟踪。</p><p>架构如下:<br><img src="https://d33wubrfki0l68.cloudfront.net/bf8e5eaac697bac89c5b36a0edb8855c860bfb45/6944f/images/docs/nodelocaldns.svg" alt="local-dns"></p><p>NodeLocalDNS的设计提案见（<a href="3">nodelocal-dns-cache</a>）</p><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><p>官方安装方式见<a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/nodelocaldns" target="_blank" rel="noopener">nodelocaldns</a>，需要自行替换变量</p><p>可通过如下脚本，一键安装（注意设置kubedns svc ClusterIP）</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token function">wget</span> https://raw.githubusercontent.com/kubernetes/kubernetes/master/cluster/addons/dns/nodelocaldns/nodelocaldns.yaml<span class="token comment" spellcheck="true"># registery</span>docker_registery<span class="token operator">=</span>k8s.gcr.io/dns/k8s-dns-node-cache<span class="token comment" spellcheck="true"># kube-dns svc clusterip</span>kubedns_svc<span class="token operator">=</span>10.254.0.2<span class="token comment" spellcheck="true"># nodelocaldns ip</span>nodelocaldns_ip<span class="token operator">=</span>169.254.20.10<span class="token comment" spellcheck="true"># kube-proxy mode, iptables or ipvs</span>kubeproxy_mode<span class="token operator">=</span>iptablesresult<span class="token operator">=</span>result.yaml<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">${kubeproxy_mode}</span> <span class="token operator">==</span> <span class="token string">"ipvs"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token function">sed</span> -e <span class="token string">"s|k8s.gcr.io/dns/k8s-dns-node-cache|<span class="token variable">$docker_registery</span>|g"</span> \        -e <span class="token string">"s/__PILLAR__CLUSTER__DNS__/<span class="token variable">$kubedns_svc</span>/g"</span> \        -e <span class="token string">"s/__PILLAR__LOCAL__DNS__/<span class="token variable">$nodelocaldns_ip</span>/g"</span> \        -e <span class="token string">'s/[ |,]__PILLAR__DNS__SERVER__//g'</span> \        -e <span class="token string">"s/__PILLAR__DNS__DOMAIN__/cluster.local/g"</span> nodelocaldns.yaml <span class="token operator">></span><span class="token variable">$result</span><span class="token keyword">else</span>    <span class="token function">sed</span> -e <span class="token string">"s|k8s.gcr.io/dns/k8s-dns-node-cache|<span class="token variable">$docker_registery</span>|g"</span> \        -e <span class="token string">"s/__PILLAR__DNS__SERVER__/<span class="token variable">$kubedns_svc</span>/g"</span> \        -e <span class="token string">"s/__PILLAR__LOCAL__DNS__/<span class="token variable">$nodelocaldns_ip</span>/g"</span> \        -e <span class="token string">"s/__PILLAR__DNS__DOMAIN__/cluster.local/g"</span> nodelocaldns.yaml <span class="token operator">></span><span class="token variable">$result</span><span class="token keyword">fi</span>kubectl apply -f <span class="token variable">$result</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建完成后，每个节点运行一个pod，查看pod(个别节点ingress-nginx占用8080端口，导致nodelocaldns启动失败)</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># kubectl  get po -n kube-system -l k8s-app=node-local-dns -o wide</span>NAME                   READY   STATUS             RESTARTS   AGE    IP              NODE                            NOMINATED NODE   READINESS GATESnode-local-dns-2fvxb   0/1     CrashLoopBackOff   4          103s   10.38.200.195   node04          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>node-local-dns-4zmcd   1/1     Running            0          54d    10.38.201.55    node06   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>node-local-dns-55tzg   1/1     Running            0          60d    10.38.200.186   node02          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>node-local-dns-cctg7   1/1     Running            0          54d    10.38.200.242   node07   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>node-local-dns-khgmm   1/1     Running            0          54d    10.38.201.36    node08   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>node-local-dns-mbr64   1/1     Running            0          60d    10.38.200.187   node05          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>node-local-dns-t67vw   1/1     Running            0          60d    10.38.200.188   node03          <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span>node-local-dns-tmm92   1/1     Running            14         54d    10.38.200.57    node09   <span class="token operator">&lt;</span>none<span class="token operator">></span>           <span class="token operator">&lt;</span>none<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>默认配置如下：</p><pre class="line-numbers language-bash"><code class="language-bash">cluster.local:53 <span class="token punctuation">{</span>    errors    cache <span class="token punctuation">{</span>            success 9984 30 <span class="token comment" spellcheck="true"># 默认成功缓存30s</span>            denial 9984 5 <span class="token comment" spellcheck="true">#失败缓存5s</span>    <span class="token punctuation">}</span>    reload    loop    bind 169.254.20.10 10.254.0.2 <span class="token comment" spellcheck="true">#本地监听ip</span>    forward <span class="token keyword">.</span> 10.254.132.95 <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">#转发到kubedns-upstream</span>            force_tcp    <span class="token punctuation">}</span>    prometheus :9253 <span class="token comment" spellcheck="true">#监控接口</span>    health 169.254.20.10:8080 <span class="token comment" spellcheck="true">#健康检测端口</span>    <span class="token punctuation">}</span>in-addr.arpa:53 <span class="token punctuation">{</span>    errors    cache 30    reload    loop    bind 169.254.20.10 10.254.0.2    forward <span class="token keyword">.</span> 10.254.132.95 <span class="token punctuation">{</span>            force_tcp    <span class="token punctuation">}</span>    prometheus :9253    <span class="token punctuation">}</span>ip6.arpa:53 <span class="token punctuation">{</span>    errors    cache 30    reload    loop    bind 169.254.20.10 10.254.0.2    forward <span class="token keyword">.</span> 10.254.132.95 <span class="token punctuation">{</span>            force_tcp    <span class="token punctuation">}</span>    prometheus :9253    <span class="token punctuation">}</span>.:53 <span class="token punctuation">{</span>    errors    cache 30    reload    loop    bind 169.254.20.10 10.254.0.2    forward <span class="token keyword">.</span> /etc/resolv.conf    prometheus :9253    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>节点上查看localdns的网卡，本地将监听<code>169.254.20.10</code>与<code>10.254.0.2</code>两个地址，拦截kubedns((默认<code>10.254.0.2</code>)的请求，命中后直接返回，若未命中转发到kubedns(对应service <code>kube-dns-upstream</code>，kube-dns-upstream由localdns创建绑定kubedns pod)</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># ip addr show nodelocaldns</span>182232: nodelocaldns: <span class="token operator">&lt;</span>BROADCAST,NOARP<span class="token operator">></span> mtu 1500 qdisc noop state DOWN     link/ether 4e:62:1c:fd:56:12 brd ff:ff:ff:ff:ff:ff    inet 169.254.20.10/32 brd 169.254.20.10 scope global nodelocaldns       valid_lft forever preferred_lft forever    inet 10.254.0.2/32 brd 10.254.0.2 scope global nodelocaldns       valid_lft forever preferred_lft forever<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>iptables规则，使用<code>NOTRACK</code>跳过其它表处理</p><pre class="line-numbers language-bash"><code class="language-bash">iptables-save <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">"10.254.0.2|169.254.20.10"</span>-A PREROUTING -d 10.254.0.2/32 -p udp -m udp --dport 53 -j NOTRACK-A PREROUTING -d 10.254.0.2/32 -p tcp -m tcp --dport 53 -j NOTRACK-A PREROUTING -d 169.254.20.10/32 -p udp -m udp --dport 53 -j NOTRACK-A PREROUTING -d 169.254.20.10/32 -p tcp -m tcp --dport 53 -j NOTRACK-A OUTPUT -d 10.254.0.2/32 -p udp -m udp --dport 53 -j NOTRACK-A OUTPUT -d 10.254.0.2/32 -p tcp -m tcp --dport 53 -j NOTRACK-A INPUT -d 10.254.0.2/32 -p udp -m udp --dport 53 -j ACCEPT-A INPUT -d 10.254.0.2/32 -p tcp -m tcp --dport 53 -j ACCEPT-A OUTPUT -s 10.254.0.2/32 -p udp -m udp --sport 53 -j ACCEPT-A OUTPUT -s 10.254.0.2/32 -p tcp -m tcp --sport 53 -j ACCEPT<span class="token punctuation">..</span>.-A KUBE-SERVICES -d 10.254.0.2/32 -p tcp -m comment --comment <span class="token string">"kube-system/kube-dns:dns-tcp cluster IP"</span> -m tcp --dport 53 -j KUBE-SVC-ERIFXISQEP7F7OF4-A KUBE-SERVICES -d 10.254.0.2/32 -p tcp -m comment --comment <span class="token string">"kube-system/kube-dns:metrics cluster IP"</span> -m tcp --dport 9153 -j KUBE-SVC-JD5MR3NA4I4DYORP-A KUBE-SERVICES -d 10.254.0.2/32 -p udp -m comment --comment <span class="token string">"kube-system/kube-dns:dns cluster IP"</span> -m udp --dport 53 -j KUBE-SVC-TCOU7JCQXEZGVUNU<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在pod通过localdns解析域名</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># kubectl  exec -it dns-perf-client-64cfb49f9-9c5hg sh</span>/ <span class="token comment" spellcheck="true"># nslookup kubernetes 169.254.20.10</span>Server:                169.254.20.10Address:        169.254.20.10<span class="token comment" spellcheck="true">#53</span>Name:        kubernetes.default.svc.cluster.localAddress: 10.254.0.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="压测"><a href="#压测" class="headerlink" title="压测"></a>压测</h4><p>通过<code>dnsperf</code>进行压测</p><p>测试域名列表如下</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat records.txt </span>mi.com Agithub.com Awww.microsoft.com Awww.aliyun.com Akubernetes.io Anginx Anginx.default Akubernetes Akubernetes.default.svc.cluster.local Akube-dns.kube-system.svc.cluster.local A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试命令</p><pre class="line-numbers language-bash"><code class="language-bash">dnsperf -l 120 -s 10.254.0.2 -d records.txt<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>结果如下<br>| |client number|qps|avg-lantency(ms)|stddev(ms)|lost| |<br>|:—-|:—-|:—-|:—-|:—-|:—-|:—-|<br>|kubedns(1 pod)|1|53910|1.83|6.07|0%| |<br>|kubedns(2 pod)|2|110000|1.83|1.94|9%| |<br>|kubedns(4 pod)|4|120000|3.2|0.8|24%| |<br>|nodelocaldns|1|71494|1.39|1.66|0%| |<br>|nodelocaldns|2|142000|1.37|1.55|0%| |</p><p>相比<code>nodelocaldns</code>，<code>localdns</code>查询性能提高了33%，而且延时相对更小，由于<code>localdns</code>是分布式的整体qps相对kubedns有较大优势。当前测试相对简单，大部分请求会命中缓存，完整的测试结果待进一步验证。</p><h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><p>优点：</p><ul><li>大幅减少dns查询延时</li><li>提高dns qps</li><li>不经过<code>iptables</code>与<code>conntrack</code></li><li>默认使用tcp查询dns，避免 dns 5秒延时</li></ul><p>缺点：</p><ul><li>单点故障（OOM/Evicted/Config Error/Upgrade），社区通过起一个探测daemonset监听localdns状态，如果localdns异常将去掉iptables规则</li><li><code>hostnetwork</code>, 占用多个端口（8080, 9253等）</li><li>ipvs模式下，需要改动kubelet默认dns配置（<code>NOTRACK</code>将对<code>ipvs</code>无效，除非service后端实例为0）</li></ul><p>注意事项</p><ul><li>低版本dns存在tcp请求内存泄露</li><li>安装时<code>iptables</code>与<code>ipvs</code>配置不同</li></ul><h4 id="HA"><a href="#HA" class="headerlink" title="HA"></a>HA</h4><ul><li>社区提案将<code>iptables</code>写入规则从<code>nodelocaldns</code>拆分为单独的daemonset，通过监听<code>localdns</code>地址来判断是否写入或删除<code>iptables</code>规则（ipvs默认下无效）</li><li>在<code>/etc/resolv.conf</code>配置多个<code>nameservers</code>(不推荐，不同基础库表现不同，如<code>glibc 2.16+</code>查询dns时会向多个<code>nameservers</code>发送请求，反而造成了请求激增)</li></ul><h4 id="灰度方式"><a href="#灰度方式" class="headerlink" title="灰度方式"></a>灰度方式</h4><ul><li>通过<code>dnsConfi</code>g配置Pod级别dns（需要配置启动参数localip）</li><li>通过设置<code>nodeselector</code>灰度Node级别dns策略</li></ul><h3 id="本地DNS缓存"><a href="#本地DNS缓存" class="headerlink" title="本地DNS缓存"></a>本地DNS缓存</h3><p>除了nodelocaldns，用户还可以在容器内或者添加sidecar来启用dns缓存</p><ol><li><p>通过在镜像中加入nscd进程，缓存dns，如下：</p><pre class="line-numbers language-bash"><code class="language-bash"> FROM ubuntu RUN <span class="token function">apt-get</span> update <span class="token operator">&amp;&amp;</span> <span class="token function">apt-get</span> <span class="token function">install</span> -y nscd <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -rf /var/lib/apt/lists/* CMD <span class="token function">service</span> nscd start<span class="token punctuation">;</span> <span class="token function">bash</span> -c <span class="token string">"sleep 3600"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p> 此种方式需要用户改动镜像，或者加入额外脚本配置<code>nscd</code></p></li><li><p>另外可以配置可配置dns缓存 sidecar（如<code>coredns</code>, <code>dnsmasq</code>）来提高性能，此种方式灵活性高，但需要改动pod配置，而且较<code>nodelocaldns</code>浪费资源</p></li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/nodelocaldns/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/tasks/administer-cluster/nodelocaldns/</a><br>[2] <a href="https://help.aliyun.com/document_detail/172339.html" target="_blank" rel="noopener">https://help.aliyun.com/document_detail/172339.html</a><br>[3] <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-network/0030-nodelocal-dns-cache.md" target="_blank" rel="noopener">https://github.com/kubernetes/enhancements/blob/master/keps/sig-network/0030-nodelocal-dns-cache.md</a><br>[4] <a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-network/1024-nodelocal-cache-dns/README.md" target="_blank" rel="noopener">https://github.com/kubernetes/enhancements/blob/master/keps/sig-network/1024-nodelocal-cache-dns/README.md</a><br>[5] <a href="https://lework.github.io/2020/11/09/node-local-dns/" target="_blank" rel="noopener">https://lework.github.io/2020/11/09/node-local-dns/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;kubernetes集群内置的dns插件&lt;code&gt;kubedns/coredns&lt;/code&gt;在高并发情况下可能遇到性能瓶颈，以下从配置与本地缓存方面说明如何减少dns查询失败率，提高性能。&lt;/p&gt;
&lt;h2 id=&quot;配置优化&quot;&gt;&lt;a href=&quot;#配置优化&quot; class=
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="dns" scheme="https://qinng.now.sh/tags/dns/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes apiserver限流方案</title>
    <link href="https://qinng.now.sh/k8s-rate-limit/"/>
    <id>https://qinng.now.sh/k8s-rate-limit/</id>
    <published>2020-11-11T05:17:00.000Z</published>
    <updated>2020-11-11T06:23:53.575Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>为了防止突发流量影响apiserver可用性，k8s支持多种限流配置，包括：</p><ul><li>MaxInFlightLimit，server级别整体限流</li><li>Client限流</li><li>EventRateLimit, 限制event</li><li>APF，更细力度的限制配置</li></ul><h3 id="MaxInFlightLimit"><a href="#MaxInFlightLimit" class="headerlink" title="MaxInFlightLimit"></a>MaxInFlightLimit</h3><p>MaxInFlightLimit限流，apiserver默认可设置最大并发量（集群级别，区分只读与修改操作），通过参数<code>--max-requests-inflight</code>和 <code>--max-mutating-requests-inflight</code>， 可以简单实现限流。</p><h3 id="Client限流"><a href="#Client限流" class="headerlink" title="Client限流"></a>Client限流</h3><p>例如client-go默认的qps为5，但是只支持客户端限流，集群管理员无法控制用户行为。</p><h3 id="EventRateLimit"><a href="#EventRateLimit" class="headerlink" title="EventRateLimit"></a>EventRateLimit</h3><p>EventRateLimit在1.13之后支持，只限制event请求，集成在apiserver内部webhoook中，可配置某个用户、namespace、server等event操作限制，通过webhook形式实现。</p><p>具体原理可以参考<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/admission-controllers/#eventratelimit" target="_blank" rel="noopener">提案</a>，每个eventratelimit 配置使用一个单独的令牌桶限速器，每次event操作，遍历每个匹配的限速器检查是否能获取令牌，如果可以允许请求，否则返回<code>429</code>。</p><p><strong>优点</strong></p><ul><li>实现简单，允许一定量的并发</li><li>可支持server/namespace/user等级别的限流</li></ul><p><strong>缺点</strong></p><ul><li>仅支持event，通过webhook实现只能拦截修改类请求</li><li>所有namespace的限流相同，没有优先级</li></ul><h3 id="API-优先级和公平性"><a href="#API-优先级和公平性" class="headerlink" title="API 优先级和公平性"></a>API 优先级和公平性</h3><p>apiserver默认的限流方式太过简单，一个错误的客户端发送大量请求可能造成其他客户端请求异常，也不支持突发流量。</p><p>API 优先级和公平性（APF）是MaxInFlightLimit限流的一种替代方案，设计文档见<a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/1040-priority-and-fairness" target="_blank" rel="noopener">提案</a>。</p><p>API 优先级和公平性（1.15以上，alpha版本）， 以更细粒度（byUser，byNamespace）对请求进行分类和隔离。 支持突发流量，通过使用公平排队技术从队列中分发请求从而避免饥饿。</p><p>APF限流通过两种资源，<code>PriorityLevelConfigurations</code>定义隔离类型和可处理的并发预算量，还可以调整排队行为。 <code>FlowSchemas</code>用于对每个入站请求进行分类，并与一个 <code>PriorityLevelConfigurations</code>相匹配。</p><p>可对用户或用户组或全局进行某些资源某些请求的限制，如限制default namespace写services put/patch请求。</p><p><strong>优点</strong></p><ul><li>考虑情况较全面，支持优先级，白名单等</li><li>可支持server/namespace/user/resource等细粒度级别的限流</li></ul><p><strong>缺点</strong></p><ul><li>配置复杂，不直观，需要对APF原理深入了解</li><li>功能较新，缺少生产环境验证</li></ul><p><strong>APF测试</strong><br>开启APF，需要在apiserver配置<code>--feature-gates=APIPriorityAndFairness=true --runtime-config=flowcontrol.apiserver.k8s.io/v1alpha1=true</code></p><p>开启后，获取默认的FlowSchemas</p><pre class="line-numbers language-bash"><code class="language-bash">$ kubectl get flowschemas.flowcontrol.apiserver.k8s.io NAME                           PRIORITYLEVEL     MATCHINGPRECEDENCE   DISTINGUISHERMETHOD   AGE    MISSINGPLsystem-leader-election         leader-election   100                  ByUser                152m   Falseworkload-leader-election       leader-election   200                  ByUser                152m   Falsesystem-nodes                   system            500                  ByUser                152m   Falsekube-controller-manager        workload-high     800                  ByNamespace           152m   Falsekube-scheduler                 workload-high     800                  ByNamespace           152m   Falsekube-system-service-accounts   workload-high     900                  ByNamespace           152m   Falsehealth-for-strangers           exempt            1000                 <span class="token operator">&lt;</span>none<span class="token operator">></span>                151m   Falseservice-accounts               workload-low      9000                 ByUser                152m   Falseglobal-default                 global-default    9900                 ByUser                152m   Falsecatch-all                      catch-all         10000                ByUser                152m   False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>FlowShema配置</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> flowcontrol.apiserver.k8s.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> FlowSchema<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> health<span class="token punctuation">-</span>for<span class="token punctuation">-</span>strangers<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">matchingPrecedence</span><span class="token punctuation">:</span> <span class="token number">1000 </span><span class="token comment" spellcheck="true">#匹配优先级，1~1000，越小优先级越高</span>  <span class="token key atrule">priorityLevelConfiguration</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#关联的PriorityLevelConfigurations</span>    <span class="token key atrule">name</span><span class="token punctuation">:</span> exempt <span class="token comment" spellcheck="true">#排除rules，即不限制当前flowshema的rules</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#请求规则</span>  <span class="token punctuation">-</span> <span class="token key atrule">nonResourceRules</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#非资源</span>    <span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"/healthz"</span>      <span class="token punctuation">-</span> <span class="token string">"/livez"</span>      <span class="token punctuation">-</span> <span class="token string">"/readyz"</span>      <span class="token key atrule">verbs</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token string">"*"</span>    <span class="token key atrule">subjects</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#对应的用户或用户组</span>    <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> Group      <span class="token key atrule">group</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>unauthenticated<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>PriorityLevelConfiguration配置</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> flowcontrol.apiserver.k8s.io/v1alpha1<span class="token key atrule">kind</span><span class="token punctuation">:</span> PriorityLevelConfiguration<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>election<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">limited</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#限制策略</span>    <span class="token key atrule">assuredConcurrencyShares</span><span class="token punctuation">:</span> <span class="token number">10 </span>    <span class="token key atrule">limitResponse</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#如何处理被限制的请求</span>      <span class="token key atrule">queuing</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true">#类型为Queue时，列队的设置</span>        <span class="token key atrule">handSize</span><span class="token punctuation">:</span> <span class="token number">4 </span><span class="token comment" spellcheck="true">#队列</span>        <span class="token key atrule">queueLengthLimit</span><span class="token punctuation">:</span> <span class="token number">50 </span><span class="token comment" spellcheck="true">#队列长度</span>        <span class="token key atrule">queues</span><span class="token punctuation">:</span> <span class="token number">16 </span><span class="token comment" spellcheck="true">#队列数</span>      <span class="token key atrule">type</span><span class="token punctuation">:</span> Queue <span class="token comment" spellcheck="true">#Queue或者Reject，Reject直接返回429，Queue将请求加入队列</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> Limited <span class="token comment" spellcheck="true">#类型，Limited或Exempt， Exempt即不限制</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上是k8s相关的限流策略，通过多种策略来保证集群的稳定性。</p><p>目前MaxInFlightLimit可以轻松开启，但是限制策略不精细，而APF功能较新，实现较复杂，在充分验证后，可通过APF对全集群进行限流。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;为了防止突发流量影响apiserver可用性，k8s支持多种限流配置，包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MaxInFlightLimit，s
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="apiserver" scheme="https://qinng.now.sh/tags/apiserver/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetes中Sidecar生命周期管理</title>
    <link href="https://qinng.now.sh/k8s-sideccar-lifecycle/"/>
    <id>https://qinng.now.sh/k8s-sideccar-lifecycle/</id>
    <published>2020-09-21T03:45:00.000Z</published>
    <updated>2020-09-21T06:30:50.643Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在多个容器的Pod中，通常业务容器需要依赖sidecar。启动时sidecar需要先启动，退出时sidecar需要在业务容器退出后再退出。k8s目前对于sidecar的生命周期比较有争议，见<a href="https://github.com/kubernetes/enhancements/issues/753" target="_blank" rel="noopener">issue</a>、<a href="https://github.com/kubernetes/enhancements/blob/master/keps/sig-node/0753-sidecarcontainers.md" target="_blank" rel="noopener">sidecarcontainers</a>。</p><p>Kubernetes Pod 内有两种容器: 初始化容器(init container)和应用容器(app container)。</p><p>其中初始化容器的执行先于应用容器，按顺序启动，执行成功启动下一个：</p><pre class="line-numbers language-go"><code class="language-go">    <span class="token keyword">if</span> container <span class="token operator">:=</span> podContainerChanges<span class="token punctuation">.</span>NextInitContainerToStart<span class="token punctuation">;</span> container <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// Start the next init container.</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"init container"</span><span class="token punctuation">,</span> <span class="token function">containerStartSpec</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// Successfully started the container; clear the entry in the failure</span>        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Completed init container %q for pod %q"</span><span class="token punctuation">,</span> container<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> format<span class="token punctuation">.</span><span class="token function">Pod</span><span class="token punctuation">(</span>pod<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>而对于应用容器，无法保证容器ready顺序，启动代码如下:</p><pre class="line-numbers language-go"><code class="language-go">    <span class="token comment" spellcheck="true">// Step 7: start containers in podContainerChanges.ContainersToStart.</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> idx <span class="token operator">:=</span> <span class="token keyword">range</span> podContainerChanges<span class="token punctuation">.</span>ContainersToStart <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// start函数向docker发请求启动容器，这里没有检测函数返回而且不确定ENTRYPOINT是否成功</span>        <span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"container"</span><span class="token punctuation">,</span> <span class="token function">containerStartSpec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pod<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Containers<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在删除时，同样无法保证删除顺序，代码如下</p><pre class="line-numbers language-go"><code class="language-go">    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> container <span class="token operator">:=</span> <span class="token keyword">range</span> runningPod<span class="token punctuation">.</span>Containers <span class="token punctuation">{</span>        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>container <span class="token operator">*</span>kubecontainer<span class="token punctuation">.</span>Container<span class="token punctuation">)</span> <span class="token punctuation">{</span>            killContainerResult <span class="token operator">:=</span> kubecontainer<span class="token punctuation">.</span><span class="token function">NewSyncResult</span><span class="token punctuation">(</span>kubecontainer<span class="token punctuation">.</span>KillContainer<span class="token punctuation">,</span> container<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 每一个容器起goroutine执行删除</span>            <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">killContainer</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> container<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> container<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> gracePeriodOverride<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>               <span class="token operator">...</span>            <span class="token punctuation">}</span>            containerResults <span class="token operator">&lt;-</span> killContainerResult        <span class="token punctuation">}</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="启动顺序"><a href="#启动顺序" class="headerlink" title="启动顺序"></a>启动顺序</h2><p>k8s原生方式，对于pod中一个容器依赖另一个容器，目前需要业务进程判断依赖服务是否启动或者sleep 10s，这种方式可以工作，但不太优雅。需要业务更改启动脚本。</p><p>那么，有没有其他的解决办法？</p><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>在启动时，start函数调用startContainer来创建容器，主要代码如下：</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>kubeGenericRuntimeManager<span class="token punctuation">)</span> <span class="token function">startContainer</span><span class="token punctuation">(</span>podSandboxID <span class="token builtin">string</span><span class="token punctuation">,</span> podSandboxConfig <span class="token operator">*</span>runtimeapi<span class="token punctuation">.</span>PodSandboxConfig<span class="token punctuation">,</span> spec <span class="token operator">*</span>startSpec<span class="token punctuation">,</span> pod <span class="token operator">*</span>v1<span class="token punctuation">.</span>Pod<span class="token punctuation">,</span> podStatus <span class="token operator">*</span>kubecontainer<span class="token punctuation">.</span>PodStatus<span class="token punctuation">,</span> pullSecrets <span class="token punctuation">[</span><span class="token punctuation">]</span>v1<span class="token punctuation">.</span>Secret<span class="token punctuation">,</span> podIP <span class="token builtin">string</span><span class="token punctuation">,</span> podIPs <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    container <span class="token operator">:=</span> spec<span class="token punctuation">.</span>container    <span class="token comment" spellcheck="true">// Step 1: 拉镜像.</span>    imageRef<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>imagePuller<span class="token punctuation">.</span><span class="token function">EnsureImageExists</span><span class="token punctuation">(</span>pod<span class="token punctuation">,</span> container<span class="token punctuation">,</span> pullSecrets<span class="token punctuation">,</span> podSandboxConfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token operator">...</span>     <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Step 2: 调用cri创建容器</span>    <span class="token comment" spellcheck="true">// For a new container, the RestartCount should be 0</span>    containerID<span class="token punctuation">,</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">CreateContainer</span><span class="token punctuation">(</span>podSandboxID<span class="token punctuation">,</span> containerConfig<span class="token punctuation">,</span> podSandboxConfig<span class="token punctuation">)</span>   <span class="token operator">...</span>    <span class="token comment" spellcheck="true">// Step 3: 启动容器</span>    err <span class="token operator">=</span> m<span class="token punctuation">.</span>runtimeService<span class="token punctuation">.</span><span class="token function">StartContainer</span><span class="token punctuation">(</span>containerID<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// Step 4: 执行 post start hook.</span>    <span class="token keyword">if</span> container<span class="token punctuation">.</span>Lifecycle <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> container<span class="token punctuation">.</span>Lifecycle<span class="token punctuation">.</span>PostStart <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        kubeContainerID <span class="token operator">:=</span> kubecontainer<span class="token punctuation">.</span>ContainerID<span class="token punctuation">{</span>            Type<span class="token punctuation">:</span> m<span class="token punctuation">.</span>runtimeName<span class="token punctuation">,</span>            ID<span class="token punctuation">:</span>   containerID<span class="token punctuation">,</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 调用Run来执行hook</span>        msg<span class="token punctuation">,</span> handlerErr <span class="token operator">:=</span> m<span class="token punctuation">.</span>runner<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>kubeContainerID<span class="token punctuation">,</span> pod<span class="token punctuation">,</span> container<span class="token punctuation">,</span> container<span class="token punctuation">.</span>Lifecycle<span class="token punctuation">.</span>PostStart<span class="token punctuation">)</span>        <span class="token operator">...</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>步骤如下：</p><ol><li>拉取镜像</li><li>创建容器</li><li>启动容器</li><li>执行hook</li></ol><p>一个Pod中容器的启动是有顺序的，排在前面容器的先启动。同时第一个容器执行完ENTRYPOINT和PostStart之后（异步执行，无法确定顺序），k8s才会创建第二个容器（这样的话就可以保证第一个容器创建多长时间后再启动第二个容器）</p><p>如果我们PostStart阶段去检测容器是否ready，那么只有在ready后才去执行下一个容器。</p><p><img src="/img/blogImg/sidecar-lifecycle.png" alt="sidecar-lifecycle"></p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>配置如下，sidecar模拟需要依赖的容器，main为业务容器</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>start<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sidecar    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 3600"</span><span class="token punctuation">]</span>    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>        <span class="token key atrule">exec</span><span class="token punctuation">:</span>          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 20"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 3600"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>得到结果如下，可以看到sidecar启动21s后才开始启动main容器，满足需求</p><pre class="line-numbers language-bash"><code class="language-bash">Events:  Type    Reason     Age   From                                          Message  ----    ------     ----  ----                                          -------  Normal  Scheduled  54s   default-scheduler                             Successfully assigned default/test-start to tj1-staging-k8s-slave95-202008.kscn  Normal  Pulling    53s   kubelet, tj1-staging-k8s-slave95-202008.kscn  Pulling image <span class="token string">"busybox"</span>  Normal  Pulled     44s   kubelet, tj1-staging-k8s-slave95-202008.kscn  Successfully pulled image <span class="token string">"busybox"</span>  Normal  Created    44s   kubelet, tj1-staging-k8s-slave95-202008.kscn  Created container sidecar  Normal  Started    44s   kubelet, tj1-staging-k8s-slave95-202008.kscn  Started container sidecar  Normal  Pulling    23s   kubelet, tj1-staging-k8s-slave95-202008.kscn  Pulling image <span class="token string">"busybox"</span>  Normal  Pulled     19s   kubelet, tj1-staging-k8s-slave95-202008.kscn  Successfully pulled image <span class="token string">"busybox"</span>  Normal  Created    18s   kubelet, tj1-staging-k8s-slave95-202008.kscn  Created container main  Normal  Started    18s   kubelet, tj1-staging-k8s-slave95-202008.kscn  Started container main<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>此方案可能存在的缺点：</p><ol><li>如果sidecar启动失败或者hook失败，其他容器会立即启动</li></ol><h2 id="退出顺序"><a href="#退出顺序" class="headerlink" title="退出顺序"></a>退出顺序</h2><p>容器启动顺序比较好解决，退出顺序则是按照相反的顺序，业务容器先退出，之后sidecar再退出。</p><p>目前，在kubelet删除pod步骤如下;</p><ol><li>遍历容器，每个容器起一个goroutine删除</li><li>删除时，先执行pre stop hook，得到gracePeriod=DeletionGracePeriodSeconds-period(stophook)</li><li>再调用cri删除接口m.runtimeService.StopContainer(containerID.ID, gracePeriod)</li></ol><p>如果在sidecar的pre stop hook检测业务容器状态，那么可以延迟退出。</p><h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p>业务容器main退出时，创建文件；sidecar通过post-stop检测到文件后，执行退出</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>stop<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> sidecar    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">command</span><span class="token punctuation">:</span>     <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">      trap "touch /lifecycle/sidecar-terminated" 15      until [ -f "/lifecycle/sidecar-terminated" ];do        date        sleep 1      done      sleep 5      cat /lifecycle/main-terminated      t=$(date)      echo "sidecar exit at $t"</span>    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>      <span class="token key atrule">preStop</span><span class="token punctuation">:</span>        <span class="token key atrule">exec</span><span class="token punctuation">:</span>          <span class="token key atrule">command</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>          <span class="token punctuation">-</span> <span class="token string">"-c"</span>          <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">            until [ -f "/lifecycle/main-terminated" ];do              sleep 1            done            t=$(date)            echo "main exit at $t" > /lifecycle/main-terminated</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /lifecycle  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> main    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox    <span class="token key atrule">command</span><span class="token punctuation">:</span>     <span class="token punctuation">-</span> <span class="token string">"/bin/sh"</span>    <span class="token punctuation">-</span> <span class="token string">"-c"</span>    <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">      trap "touch /lifecycle/main-terminated" 15      until [ -f "/lifecycle/main-terminated" ];do        date        sleep 1      done</span>    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /lifecycle  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在日志中看到，main容器先结束，sidecar检测到main-terminated文件后，执行完post-stop-hook，sidecar主进程开始退出</p><pre class="line-numbers language-bash"><code class="language-bash">$ kubectl  logs -f test-stop main<span class="token punctuation">..</span>.Tue Sep  8 03:14:20 UTC 2020Tue Sep  8 03:14:21 UTC 2020Tue Sep  8 03:14:22 UTC 2020$ kubectl  logs -f test-stop sidecarTue Sep  8 03:14:22 UTC 2020Tue Sep  8 03:14:23 UTC 2020<span class="token comment" spellcheck="true"># post stop hook 检测到main容器退出，记录日志</span>main <span class="token keyword">exit</span> at Tue Sep  8 03:14:23 UTC 2020<span class="token comment" spellcheck="true"># sidecar主进程退出</span>sidecar <span class="token keyword">exit</span> at Tue Sep  8 03:14:29 UTC 2020<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过测试，使用postStopHook可以达到sidecar延迟退出的目的，但这种方式也有一些缺点</p><ol><li>配置复杂，多个sidecar都需要配置postStop监听业务容器状态</li><li>业务容器需要有可观察性（提供特定形式的健康检测）</li><li>poststop执行异常，会等到最大优雅退出时间（默认30s）后才终止</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>目前对于sidecar生命周期的支持方案对比如下：</p><table><thead><tr><th>方案</th><th>启动顺序</th><th>退出顺序</th><th>job sidecar</th><th>是否需要用户修改代码</th><th>是否需要修改k8s代码</th><th>缺点</th><th>备注</th></tr></thead><tbody><tr><td>用户控制</td><td>支持</td><td>不支持</td><td>不支持</td><td>需要</td><td>不需要</td><td>需要用户更改启动脚本;退出支持难度大，需要同时修改业务容器与sidecar启动脚本；大部分情况不支持</td><td>启动时需要检测sidecar服务状态</td></tr><tr><td>Lifecycle Hooks</td><td>支持</td><td>支持</td><td>不支持</td><td>不需要</td><td>不需要</td><td>配置hook复杂度高;在hook执行异常情况下不能确保顺序</td><td></td></tr><tr><td>富容器</td><td>支持</td><td>部分支持</td><td>部分支持</td><td>不需要</td><td>需要（更改镜像或启动命令）</td><td>所有功能集成在一个容器中，对于外部sidecar如istio envoy等，不可控;</td><td></td></tr><tr><td>修改源码</td><td>支持</td><td>支持</td><td>支持</td><td>不需要</td><td>需要</td><td>需要满足各种情况，实现难度较大</td><td>社区有计划支持</td></tr></tbody></table><p>在k8s提供此类功能前，目前没有完善的方案。Lifecycle Hooks不需要更改用户启动代码以及k8s相关代码，相对于其他方式不失为一种解决思路。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;在多个容器的Pod中，通常业务容器需要依赖sidecar。启动时sidecar需要先启动，退出时sidecar需要在业务容器退出后再退出。k
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="container" scheme="https://qinng.now.sh/tags/container/"/>
    
  </entry>
  
  <entry>
    <title>开启shareProcessNamespace后容器异常</title>
    <link href="https://qinng.now.sh/cotainer-init/"/>
    <id>https://qinng.now.sh/cotainer-init/</id>
    <published>2020-07-28T09:35:49.000Z</published>
    <updated>2020-08-03T15:16:27.546Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>目前k8s不支持容器启动顺序，部分业务通过开启<code>shareProcessNamespace</code>监控某些进程状态。当开启共享pid后，有用户反馈某个容器主进程退出，但是容器并没有重启，执行<code>exec</code>会卡住，现象参考<a href="3">issue</a></p><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><ol><li><p>创建deployment</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span><span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token key atrule">spec</span><span class="token punctuation">:</span><span class="token key atrule">selector</span><span class="token punctuation">:</span> <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>   <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>   <span class="token key atrule">labels</span><span class="token punctuation">:</span>     <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx   <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token key atrule">spec</span><span class="token punctuation">:</span>   <span class="token key atrule">shareProcessNamespace</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token key atrule">containers</span><span class="token punctuation">:</span>   <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>alpine     <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>查看进程信息<br>由于开启了<code>shareProcessNamespace</code>, <code>pause</code>变为<code>pid 1</code>, <code>nginx daemon</code>pid为<code>6</code>, ppid为<code>containerd-shim</code></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查看容器内进程</span>/ <span class="token comment" spellcheck="true"># ps -efo "pid,ppid,comm,args"</span>PID   PPID  COMMAND          COMMAND 1     0 pause            /pause 6     0 nginx            nginx: master process nginx -g daemon off<span class="token punctuation">;</span>11     6 nginx            nginx: worker process12     6 nginx            nginx: worker process13     6 nginx            nginx: worker process14     6 nginx            nginx: worker process15     0 sh               sh47    15 <span class="token function">ps</span>               <span class="token function">ps</span> -efo pid,ppid,comm,args<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>删除主进程<br>子进程被<code>pid 1</code>回收, 有时也会被<code>containerd-shim</code>回收</p><pre class="line-numbers language-bash"><code class="language-bash">/ <span class="token comment" spellcheck="true"># kill -9 6</span>/ <span class="token comment" spellcheck="true"># </span>/ <span class="token comment" spellcheck="true"># ps -efo "pid,ppid,comm,args"</span>PID   PPID  COMMAND          COMMAND 1     0 pause            /pause11     1 nginx            nginx: worker process12     1 nginx            nginx: worker process13     1 nginx            nginx: worker process14     1 nginx            nginx: worker process15     0 sh               sh48    15 <span class="token function">ps</span>               <span class="token function">ps</span> -efo pid,ppid,comm,args<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>docker hang<br>此时对此容器执行docker命令(<code>inspect, logs, exec</code>)将卡住， 同样通过<code>kubectl</code>执行会超时。</p></li></ol><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>在未开启<code>shareProcessNamespace</code>的容器中，主进程退出<code>pid 1</code>, 此pid namespace销毁，系统会<code>kill</code>其下的所有进程。开启后，<code>pid 1</code>为<code>pause</code>进程，容器主进程退出，由于共享pid namespace，其他进程没有退出变成孤儿进程。此时调用docker相关接口去操作容器，docker首先去找主进程，但主进程已经不存在了，导致异常(待确认)。</p><p>清理掉这些孤儿进程容器便会正常退出，可以<code>kill</code>掉这些进程或者<code>kill</code>pause进程，即可恢复。</p><h2 id="方案"><a href="#方案" class="headerlink" title="方案"></a>方案</h2><p>有没有优雅的方式解决此种问题，如果主进程退出子进程也一起退出便符合预期，这就需要进程管理工具来实现，在宿主机中有<code>systemd</code>、<code>god</code>，容器中也有类似的工具即<code>init进程</code>(传递信息，回收子进程)，常见的有</p><ol><li><code>docker init</code>, docker自带的init进程(即<code>tini</code>)</li><li><a href="https://github.com/krallin/tini" target="_blank" rel="noopener"><code>tini</code></a>, 可回收孤儿进程/僵尸进程，<code>kill</code>进程组等</li><li><a href="https://github.com/Yelp/dumb-init" target="_blank" rel="noopener"><code>dumb-init</code></a>, 可管理进程，重写信号等</li></ol><p>经过测试，<code>tini</code>进程只能回收前台程序，对于后台程序则无能为力(例如<code>nohup</code>, <code>&amp;</code>启动的程序)，<code>dumb-init</code>在主进程退出时，会传递信号给子进程，符合预期。</p><p>开启<code>dumb-init</code>进程的<code>dockerfile</code>如下，<code>tini</code>也类似</p><pre class="line-numbers language-Dockerfile"><code class="language-Dockerfile">FROM nginx:alpine# tini# RUN apk add --no-cache tini# ENTRYPOINT ["/sbin/tini", "-s", "-g", "--"]# dumb-initRUN wget -O /usr/bin/dumb-init https://github.com/Yelp/dumb-init/releases/download/v1.2.2/dumb-init_1.2.2_amd64RUN chmod +x /usr/bin/dumb-initENTRYPOINT ["/usr/bin/dumb-init", "-v", "--"]CMD ["nginx", "-g", "daemon off;"]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>init方式对于此问题是一种临时的解决方案，需要docker从根本上解决此种情况。容器推荐单进程运行，但某些情况必须要运行多进程，如果不想处理处理传递回收进程等，可以通过<code>init</code>进程，无需更改代码即可实现。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://github.com/Yelp/dumb-init" target="_blank" rel="noopener">https://github.com/Yelp/dumb-init</a><br>[2] <a href="https://github.com/krallin/tini" target="_blank" rel="noopener">https://github.com/krallin/tini</a><br>[3] <a href="https://github.com/kubernetes/kubernetes/issues/92214" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/issues/92214</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;目前k8s不支持容器启动顺序，部分业务通过开启&lt;code&gt;shareProcessNamespace&lt;/code&gt;监控某些进程状态。当开启共
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="docker" scheme="https://qinng.now.sh/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>Prometheus最佳实践-聚合函数</title>
    <link href="https://qinng.now.sh/prometheus-best-practice-operation/"/>
    <id>https://qinng.now.sh/prometheus-best-practice-operation/</id>
    <published>2020-07-16T07:28:39.000Z</published>
    <updated>2020-08-03T15:21:47.826Z</updated>
    
    <content type="html"><![CDATA[<h2 id="rate"><a href="#rate" class="headerlink" title="rate"></a>rate</h2><p>prometheus中<code>rate</code>只能用于<code>counter</code>类型，对于需要聚合的数据需要先<code>rate</code>再<code>sum</code>，而不是<code>rate(sum)</code></p><h2 id="数据准确性"><a href="#数据准确性" class="headerlink" title="数据准确性"></a>数据准确性</h2><p><code>rate/increase/delta</code>等操作对于原始值进行了外推（类似线性插件），得到的不是准确值</p><p>如<code>rate(http_requests_total[2m])</code>指两分钟内每秒平均请求量，通过<code>2m</code>内首尾两个数据外推得到差值，比120s得到；<br>同理<code>increase(http_requests_total[2m])</code>指的不是首尾两个值的增长量，而是外推后计算出<code>2m</code>内的增长量。</p><h2 id="absent"><a href="#absent" class="headerlink" title="absent"></a>absent</h2><p>通常报警中，我们需要对某个对象是不是有数据进行监控（即<code>nodata</code>监控），<code>absent</code>用来验证指标是不是有数据很有用</p><h2 id="predict-linear"><a href="#predict-linear" class="headerlink" title="predict_linear"></a>predict_linear</h2><p>线性回归预测，适合线性数据的预测，如预测etcd的未来4小时文件描述符使用量</p><pre><code>predict_linear(cluster:etcd:fd_utilization[1h], 3600 * 4)</code></pre><h2 id="quantile-over-time"><a href="#quantile-over-time" class="headerlink" title="quantile_over_time"></a>quantile_over_time</h2><p>一段时间内统计分位数</p><pre><code>quantile_over_time(0.9, http_requests_total[1d]) # 一天内请求量的90分位</code></pre><h2 id="bool"><a href="#bool" class="headerlink" title="bool"></a>bool</h2><p>某些情况的需要比较两个标量（通常用来报警），可以使用bool</p><pre><code>http_requests_total &gt; bool 100 </code></pre>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;rate&quot;&gt;&lt;a href=&quot;#rate&quot; class=&quot;headerlink&quot; title=&quot;rate&quot;&gt;&lt;/a&gt;rate&lt;/h2&gt;&lt;p&gt;prometheus中&lt;code&gt;rate&lt;/code&gt;只能用于&lt;code&gt;counter&lt;/code&gt;类型，对于需要聚合的
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="prometheus" scheme="https://qinng.now.sh/tags/prometheus/"/>
    
      <category term="monitor" scheme="https://qinng.now.sh/tags/monitor/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes相关开源项目</title>
    <link href="https://qinng.now.sh/kubernetes-opensource-project/"/>
    <id>https://qinng.now.sh/kubernetes-opensource-project/</id>
    <published>2020-07-14T03:12:20.000Z</published>
    <updated>2020-07-14T06:26:46.358Z</updated>
    
    <content type="html"><![CDATA[<p>总结下项目中可参考k8s相关开源项目，不断更新中…</p><h2 id="cncf"><a href="#cncf" class="headerlink" title="cncf"></a>cncf</h2><ul><li><a href="https://www.cncf.io/projects/" target="_blank" rel="noopener">project</a></li><li><a href="https://www.cncf.io/sandbox-projects/" target="_blank" rel="noopener">sandbox</a></li></ul><h2 id="阿里"><a href="#阿里" class="headerlink" title="阿里"></a>阿里</h2><ul><li><a href="https://github.com/openkruise/kruise" target="_blank" rel="noopener">kruise</a>: 各种自定义app，包括增强deployment/statefulset等</li><li><a href="https://github.com/AliyunContainerService/kubernetes-cronhpa-controller" target="_blank" rel="noopener">kubernetes-cronhpa-controller</a>: 定时扩缩</li><li><a href="https://github.com/AliyunContainerService/kube-eventer" target="_blank" rel="noopener">kube-eventer</a>: event收集</li><li><a href="https://github.com/AliyunContainerService/gpushare-scheduler-extender" target="_blank" rel="noopener">gpushare-scheduler-extender</a>: 共享GPU</li><li><a href="https://github.com/AliyunContainerService/log-pilot" target="_blank" rel="noopener">log-pilot</a>: docker日志收集工具</li></ul><h2 id="腾讯"><a href="#腾讯" class="headerlink" title="腾讯"></a>腾讯</h2><ul><li><a href="https://github.com/tkestack/tapp" target="_blank" rel="noopener">tapp</a>: 增强版deployment/statefulset</li><li><a href="https://github.com/tkestack/cron-hpa" target="_blank" rel="noopener">cron-hpa</a>: 定时扩缩</li><li><a href="https://github.com/tkestack/lb-controlling-framework" target="_blank" rel="noopener">lb-controlling-framework</a>: lb扩展，可自定义接口</li><li><a href="https://github.com/Tencent/tke-kms-plugin" target="_blank" rel="noopener">tke-kms-plugin</a>: 实现kms,可参考</li></ul><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul><li><a href="https://github.com/stakater" target="_blank" rel="noopener">stakater</a>: 提供多种controller, 白名单、reloader等工具</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;总结下项目中可参考k8s相关开源项目，不断更新中…&lt;/p&gt;
&lt;h2 id=&quot;cncf&quot;&gt;&lt;a href=&quot;#cncf&quot; class=&quot;headerlink&quot; title=&quot;cncf&quot;&gt;&lt;/a&gt;cncf&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.cn
      
    
    </summary>
    
      <category term="k8s" scheme="https://qinng.now.sh/categories/k8s/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="crd" scheme="https://qinng.now.sh/tags/crd/"/>
    
  </entry>
  
  <entry>
    <title>k8s如何优雅升级应用</title>
    <link href="https://qinng.now.sh/k8s-graceful-update-app/"/>
    <id>https://qinng.now.sh/k8s-graceful-update-app/</id>
    <published>2020-06-19T10:28:50.000Z</published>
    <updated>2020-07-20T05:30:15.365Z</updated>
    
    <content type="html"><![CDATA[<p>在k8s中通常用户通过<code>ingress</code>接入流量，转发到后端实例(<code>ingress → pod</code>)，在后端应用更新过程中，<code>ingress</code>是否能做到优雅升级，本文将通过分析升级流程与实验验证，说明在k8s中如何实现优化升级。</p><h2 id="Ingress原理"><a href="#Ingress原理" class="headerlink" title="Ingress原理"></a>Ingress原理</h2><p>用户创建ingress资源后，<code>ingress-nginx</code>通过<code>service</code>获取到对应的<code>endpoint</code>，监听到<code>endpoint</code>变化后将动态更新<code>upstream</code>。</p><p><code>endpoint</code>每次变化后会通过<code>selector</code>匹配的<code>pod</code>列表中<code>ready pod</code>（不包括待删除的<code>pod</code>, 及<code>DeletionTimestamp</code>不为空）</p><pre class="line-numbers language-bash"><code class="language-bash">pod ready <span class="token operator">=</span> 所有container ready<span class="token punctuation">(</span>启动成功, 健康检查通过<span class="token punctuation">)</span> + 所有rediness gateway执行成功<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>那么<code>endpoint</code>在什么状况下会发生变化：</p><ul><li>service变化（一般不会）</li><li>扩缩容</li><li>升级</li><li>删除pod</li></ul><p>不管是什么操作，可归结于启动、删除、退出</p><ul><li><strong>启动</strong>，只要确保<code>pod ready</code>时能服务能正常接受流量，不会影响影响服务</li><li><strong>退出</strong>, 如果是应用异常退出，不能处理已接受的流量，此种状况是应用本身行为，不在讨论范围</li><li><strong>删除</strong>, 由于k8s所有组件都采用监听机制，无法保证<code>pod</code>删除时<code>ingress-nginx</code>的后端已经更新</li></ul><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 大约在2s内</span>ingress-nginx 生效时间 <span class="token operator">=</span> endpoint 生效时间 + upstream更新时间<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果要保证pod删除时不丢流量，需要做到</p><ul><li>已接受的请求需要处理完，可监听TERM信号，处理完再退出， 可参考<a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods</a></li><li>删除时不接受新的请求，这部分无法保证，只能保证#1</li></ul><h2 id="ingress-nginx-重试机制"><a href="#ingress-nginx-重试机制" class="headerlink" title="ingress-nginx 重试机制"></a>ingress-nginx 重试机制</h2><p>ingress-nginx默认开启了proxy_next_upstream，配置如下</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># In case of errors try the next upstream server before returning an error</span>proxy_next_upstream error <span class="token function">timeout</span><span class="token punctuation">;</span>proxy_next_upstream_timeout 0<span class="token punctuation">;</span>proxy_next_upstream_tries 3<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>如果一次请求中，<code>upstream server</code> 出错或超时将通过rr算法重试下一个server，最多尝试三次。如果后端大于三个实例，一个实例异常不会影响服务。</p><h2 id="升级策略"><a href="#升级策略" class="headerlink" title="升级策略"></a>升级策略</h2><p>对于<code>Deployment</code>有两种升级策略， <code>Recreate</code>与<code>RollingUpdate</code></p><ul><li><strong>Recreate</strong>, 先将旧版缩到0再将新版扩到期望值，不建议使用</li><li><strong>RollingUpdate</strong>，默认策略，滚动更新</li></ul><p>在滚动升级时主要依据<code>maxSurge</code>与<code>maxUnavailable</code>对新旧版本进行扩缩</p><ul><li><strong>maxSurge</strong>， 升级中最多有多少pod超过期望值</li><li><strong>maxUnavailable</strong>， 此值用来计算升级中最小可用的实例数，最大不可用的实例数表示不准确</li></ul><p>举个例子，比如10个副本的Deployment， 采用默认值<code>maxSurge</code>与<code>maxUnavaiable</code>都为25%</p><pre class="line-numbers language-bash"><code class="language-bash">// 向上取整为 3 maxSurge <span class="token operator">=</span> replicas * deployment.spec.strategy.rollingUpdate.maxSurge<span class="token punctuation">(</span>25%<span class="token punctuation">)</span><span class="token operator">=</span> 2.5// 向下取整为 2 maxUnavailable <span class="token operator">=</span> replicas * deployment.spec.strategy.rollingUpdate.maxUnavailable<span class="token punctuation">(</span>25%<span class="token punctuation">)</span><span class="token operator">=</span> 2.5maxAvailable <span class="token operator">=</span> replicas<span class="token punctuation">(</span>10<span class="token punctuation">)</span> + MaxSurge（3） <span class="token operator">=</span> 13minAvailable :<span class="token operator">=</span> *<span class="token punctuation">(</span>deployment.Spec.Replicas<span class="token punctuation">)</span>（10） - maxUnavailable（2）<span class="token operator">=</span> 8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在升级过程中，首先创建 newRS，然后为其设定 replicas，此时计算出 replicas 结果为 3。等到下一个 syncLoop 时，所有 rs 的 replicas 已经达到最大值 10 + 3 = 13，此时需要 scale down oldRSs 了，scale down 的数量是通过以下公式得到的：</p><pre class="line-numbers language-bash"><code class="language-bash">// 13 <span class="token operator">=</span> 10 + 3 allPodsCount :<span class="token operator">=</span> newRS<span class="token punctuation">(</span>10<span class="token punctuation">)</span> + oldRS<span class="token punctuation">(</span>3<span class="token punctuation">)</span>// ??? newRSUnavailablePodCount :<span class="token operator">=</span> *<span class="token punctuation">(</span>newRS.Spec.Replicas<span class="token punctuation">)</span> - newRS.Status.AvailableReplicas// 13 - 8 - ??? maxScaledDown :<span class="token operator">=</span> allPodsCount - minAvailable - newRSUnavailablePodCountnewRSUnavailablePodCount 此时不确定，但是值在 <span class="token punctuation">[</span>0,3<span class="token punctuation">]</span> 中，此时假设 newRS 的三个 pod 还处于 containerCreating 状态，则newRSUnavailablePodCount 为 3，根据以上公式计算所知 maxScaledDown 为 2。如果有个新版本pod已经ready，则maxScaledDown 为 4。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>特殊情况，当只有一个副本，<code>maxSurge</code>与<code>maxUnavaiable</code>都为1时，按照以上公式，先扩容1个新版pod，再缩一个旧版的，如果旧版已经删除了而新版还没有起来可能会丟流量，可以将<code>maxUnavaiable</code>设置为0可避免以上情况。</p><h2 id="实验验证"><a href="#实验验证" class="headerlink" title="实验验证"></a>实验验证</h2><p>滚动升级终于也是通过扩缩新旧版本来实现的，我们只需要分析扩缩容过程中会不会丢流量即可。</p><h3 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h3><p>image: nginx<br>tool:  <code>wrk -c 2 -d 120 -H &quot;Connection:Close&quot; http://my.nginx.svc</code></p><h3 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h3><p>1) 从1扩到10个</p><p>不丢流量，nginx启动很快不需要额外的初始化工作，正常情况需要配置健康检查</p><h3 id="缩容"><a href="#缩容" class="headerlink" title="缩容"></a>缩容</h3><p><strong>1) 10 → 1</strong></p><p>缩容时会有502错误</p><pre class="line-numbers language-bash"><code class="language-bash">Running 2m <span class="token function">test</span> @ http://my.nginx.svc  2 threads and 2 connections  Thread Stats   Avg      Stdev     Max   +/- Stdev    Latency    11.73ms   27.02ms 229.17ms   95.14%    Req/Sec   162.91     45.77   232.00     74.13%  8969 requests <span class="token keyword">in</span> 28.24s, 2.40MB <span class="token function">read</span>  Non-2xx or 3xx responses: 366Requests/sec:    317.62Transfer/sec:     86.93KB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看ingress日志</p><pre class="line-numbers language-bash"><code class="language-bash">2020/06/19 08:12:28 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> 9533<span class="token comment" spellcheck="true">#9533: *197916788 connect() failed (111: Connection refused) while connecting to upstream, client: 10.232.41.102, server: my.nginx.svc, request: "GET / HTTP/1.1", upstream: "http://10.126.110.3:80/", host: "my.nginx.svc"</span>2020/06/19 08:12:33 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> 8935<span class="token comment" spellcheck="true">#8935: *197916707 upstream timed out (110: Operation timed out) while connecting to upstream, client: 10.232.41.102, server: my.nginx.svc, request: "GET / HTTP/1.1", upstream: "http://10.126.69.136:80/", host: "my.nginx.svc"</span>2020/06/19 08:12:33 <span class="token punctuation">[</span>error<span class="token punctuation">]</span> 9533<span class="token comment" spellcheck="true">#9533: *197916788 upstream timed out (110: Operation timed out) while connecting to upstream, client: 10.232.41.102, server: my.nginx.svc, request: "GET / HTTP/1.1", upstream: "http://10.126.69.136:80/", host: "my.nginx.svc</span>10.232.41.102 - - <span class="token punctuation">[</span>18/Jun/2020:09:14:35 +0000<span class="token punctuation">]</span> <span class="token string">"GET / HTTP/1.1"</span> 502 157 <span class="token string">"-"</span> <span class="token string">"-"</span> 38 0.001 <span class="token punctuation">[</span>default-my-nginx-80<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> 10.46.12.80:80, 10.46.12.79:80, 10.46.12.80:80 0, 0, 0 0.000, 0.000, 0.000 502, 502, 502 5cfc063dbe7daf1db953a0e16891f100<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p><strong>2) 4→1</strong></p><p>会丟流量</p><p><strong>3）3→1</strong></p><p>测试多次，偶现过丢流量的情况，这与ingress重试算法有关系</p><p><strong>4） 10→1</strong>, 忽略term信号, 不丢流量</p><pre class="line-numbers language-bash"><code class="language-bash">Running 2m <span class="token function">test</span> @ http://my.nginx.svc  2 threads and 2 connectionsThread Stats   Avg      Stdev     Max   +/- Stdev    Latency    12.12ms   16.66ms 214.89ms   88.39%    Req/Sec   129.75     74.05   250.00     62.35%  8811 requests <span class="token keyword">in</span> 34.24s, 2.35MB <span class="token function">read</span>Requests/sec:    257.35Transfer/sec:     70.41KB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过分析及实验，在pod启动时可配置健康检查避免请求异常；同一时刻大于2个pod终止可能会丢失流量，通过监听退出信号可避免此种情况。综上，应用的优化升级需要做到以下几点：</p><ul><li>健康检测，<code>pod ready</code>时能够正常接受流量</li><li>优雅停止，保证处理完请求再退出，在这段时间内实例ip可从ingress后端摘除</li><li>滚动升级配置，若只有1个实例需设置maxsurge=0，更建议副本数设置多个</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;在k8s中通常用户通过&lt;code&gt;ingress&lt;/code&gt;接入流量，转发到后端实例(&lt;code&gt;ingress → pod&lt;/code&gt;)，在后端应用更新过程中，&lt;code&gt;ingress&lt;/code&gt;是否能做到优雅升级，本文将通过分析升级流程与实验验证，说明在k8s中
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="ingress" scheme="https://qinng.now.sh/tags/ingress/"/>
    
      <category term="nginx" scheme="https://qinng.now.sh/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Ingress获取真实IP</title>
    <link href="https://qinng.now.sh/ingress-real-ip/"/>
    <id>https://qinng.now.sh/ingress-real-ip/</id>
    <published>2020-06-05T06:40:08.000Z</published>
    <updated>2020-07-20T05:39:48.878Z</updated>
    
    <content type="html"><![CDATA[<p>一般情况下，经过ingress的请求会携带header<code>X-Real-IP</code>，用户可根据header解析出真实访问IP。</p><p>特殊情况，用户请求可能经过多个nginx才达到ingress, 通过上述方法得到的并不是用户的真实IP。</p><blockquote><p>request -&gt; nginx -&gt; … -&gt; ingress-nginx -&gt; backend</p></blockquote><h2 id="方案1-use-forwarded-headers"><a href="#方案1-use-forwarded-headers" class="headerlink" title="方案1 use-forwarded-headers"></a>方案1 use-forwarded-headers</h2><p>nginx-ingress官方的建议是开启<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#forwarded-for-header" target="_blank" rel="noopener">use-forwarded-headers</a>, 配置如下：</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>configuration<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">compute-full-forwarded-for</span><span class="token punctuation">:</span> <span class="token string">'true'</span>  <span class="token key atrule">use-forwarded-headers</span><span class="token punctuation">:</span> <span class="token string">'true'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="方案2-real-ip-header"><a href="#方案2-real-ip-header" class="headerlink" title="方案2 real_ip_header"></a>方案2 real_ip_header</h2><p>这种方式确实可以起作用，但是有用户反馈开启后访问ingres后端服务一直报<code>308</code>，检查了ingress的代码开启<code>use-forwarded-headers</code>后会同时开启<code>ssl-redirect</code>导致308。</p><p>那么我们只需要开启nginx配置中的相关real-ip的配置，如下在<code>http-snippet</code>添加<code>real_ip_header X-Forwarded-For;</code></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>configuration<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">http-snippet</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">    real_ip_header X-Forwarded-For;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="golang中获取真实ip"><a href="#golang中获取真实ip" class="headerlink" title="golang中获取真实ip"></a>golang中获取真实ip</h2><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">RemoteIP</span><span class="token punctuation">(</span>r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>  <span class="token comment" spellcheck="true">// ingress 行为，将真实ip放到header `X-Original-Forwarded-For`, 普通nginx可去掉此条</span>    ip <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-Original-Forwarded-For"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> ip <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> ip    <span class="token punctuation">}</span>    ip <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">Split</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-Forwarded-For"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> ip <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> ip    <span class="token punctuation">}</span>    ip <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Header<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"X-Real-Ip"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> ip <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> ip    <span class="token punctuation">}</span>    <span class="token keyword">if</span> ip<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">SplitHostPort</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>RemoteAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> ip    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>nginx-ingress configmap中的配置会是全局生效的，上线前需要严格测试。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;一般情况下，经过ingress的请求会携带header&lt;code&gt;X-Real-IP&lt;/code&gt;，用户可根据header解析出真实访问IP。&lt;/p&gt;
&lt;p&gt;特殊情况，用户请求可能经过多个nginx才达到ingress, 通过上述方法得到的并不是用户的真实IP。&lt;/p&gt;
&lt;
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="ingress" scheme="https://qinng.now.sh/tags/ingress/"/>
    
      <category term="nginx" scheme="https://qinng.now.sh/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Ingress Header Too Large</title>
    <link href="https://qinng.now.sh/ingress-header-too-large/"/>
    <id>https://qinng.now.sh/ingress-header-too-large/</id>
    <published>2020-06-05T06:17:08.000Z</published>
    <updated>2020-06-05T06:36:20.704Z</updated>
    
    <content type="html"><![CDATA[<p>线上遇到多次由ingress header过大引起的请求失败, 可能返回502/400，解决方案如下。</p><h2 id="502-–-too-big-header"><a href="#502-–-too-big-header" class="headerlink" title="502 – too big header"></a>502 – too big header</h2><p>502错误一般是后端服务不可用，但这里是nginx-ingress返回的，在nginx-ingress可看到如下日志：<br><code>upstream sent too big header while reading response header from upstream, client...</code></p><p>需要在ingress配置如下参数</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-buffer-size</span><span class="token punctuation">:</span> 128k <span class="token comment" spellcheck="true">#根据实际情况配置</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-buffering</span><span class="token punctuation">:</span> <span class="token string">"on"</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/server-snippet</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">      large_client_header_buffers 16 128K;      client_header_buffer_size 128k;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="431-400-–-too-big-header"><a href="#431-400-–-too-big-header" class="headerlink" title="431/400 – too big header"></a>431/400 – too big header</h2><p>http header过大也有可能返回400/431, 可按照上述调整，如果还是有问题需要检查后端服务的header设置，比如golang http header默认是<code>1M</code>;<br>springboot应用需要在<code>application.properties</code>加上<code>server.max-http-header-size=32KB</code>等</p><h2 id="413-–-too-large-body"><a href="#413-–-too-large-body" class="headerlink" title="413 – too large body"></a>413 – too large body</h2><p>如果返回413，则超过了body size的限制（默认<code>1M</code>）, 可在ingress annotation添加<br><code>nginx.ingress.kubernetes.io/proxy-body-size: 8m</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;线上遇到多次由ingress header过大引起的请求失败, 可能返回502/400，解决方案如下。&lt;/p&gt;
&lt;h2 id=&quot;502-–-too-big-header&quot;&gt;&lt;a href=&quot;#502-–-too-big-header&quot; class=&quot;headerlink&quot; 
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="ingress" scheme="https://qinng.now.sh/tags/ingress/"/>
    
      <category term="nginx" scheme="https://qinng.now.sh/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>ingress nginx benchmark</title>
    <link href="https://qinng.now.sh/ingress-benchmark/"/>
    <id>https://qinng.now.sh/ingress-benchmark/</id>
    <published>2020-05-21T11:16:04.000Z</published>
    <updated>2020-05-22T12:53:21.669Z</updated>
    
    <content type="html"><![CDATA[<p>Ingress是目前Kubernetes集群流量接入的重要入口，了解其性能指标有助于用户选用合适的网络方案。</p><h2 id="测试方案"><a href="#测试方案" class="headerlink" title="测试方案"></a>测试方案</h2><p>通过wrk压测后端nginx服务，对比ingress-nginx, 原生nginx，以及直连后端性能的差异，如下图:<br><img src="/img/blogImg/ingress-benchmark1.png" alt></p><ul><li>方案1，经过ingress</li><li>方案2，经过nginx</li><li>方案3，直连ip</li></ul><h3 id="硬件环境"><a href="#硬件环境" class="headerlink" title="硬件环境"></a>硬件环境</h3><ul><li>CPU： 2x  Intel(R) Xeon(R) CPU E5-2620 v4 @ 2.10GHz, 32 cores</li><li>Network： 10-Gigabit</li><li>Memory： 128 GB</li></ul><h3 id="测试工具"><a href="#测试工具" class="headerlink" title="测试工具"></a>测试工具</h3><ul><li>wrk, 4.1.0, 在k8s master测试，减少网络影响</li><li>ingress-nginx, 0.30.0, <a href="https://github.com/kubernetes/ingress-nginx" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx</a></li><li>nginx, 1.13.5 </li><li>k8s, v1.14.9 </li><li>centos, 7.3.1611(Linux 4.9.2)</li></ul><h3 id="测试方法"><a href="#测试方法" class="headerlink" title="测试方法"></a>测试方法</h3><p>ingress-nginx主要工作是转发请求到后端pod, 我们着重对其RPS（每秒请求量）进行测试</p><p>通过以下命令</p><pre class="line-numbers language-yaml"><code class="language-yaml">wrk <span class="token punctuation">-</span>t4 <span class="token punctuation">-</span>c1000 <span class="token punctuation">-</span>d120s <span class="token punctuation">-</span><span class="token punctuation">-</span>latency http<span class="token punctuation">:</span>//my.nginx.svc/1kb.bin<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h2><h3 id="不同cpu下的性能"><a href="#不同cpu下的性能" class="headerlink" title="不同cpu下的性能"></a>不同cpu下的性能</h3><p>对比不同ingress-nginx启动不同worker数量的性能差异，以下测试ingress-nginx开启了keepalive等特性</p><table><thead><tr><th>CPU</th><th>RPS</th></tr></thead><tbody><tr><td>1</td><td>5534</td></tr><tr><td>2</td><td>11203</td></tr><tr><td>4</td><td>22890</td></tr><tr><td>8</td><td>47025</td></tr><tr><td>16</td><td>93644</td></tr><tr><td>24</td><td>125990</td></tr><tr><td>32</td><td>153473</td></tr></tbody></table><p><img src="/img/blogImg/ingress-benchmark2.png" alt></p><p>如图所示，不同cpu下，ingress的rps与cpu成正比，cpu在16核之后增长趋势放缓。</p><h3 id="不同方案的性能对比"><a href="#不同方案的性能对比" class="headerlink" title="不同方案的性能对比"></a>不同方案的性能对比</h3><table><thead><tr><th>方案</th><th>RPS</th><th>备注</th></tr></thead><tbody><tr><td>ingress-nginx(原始)</td><td>69171</td><td></td></tr><tr><td>ingress-nginx(配置优化)</td><td>153473</td><td>调整worker，access-log, keepalive等</td></tr><tr><td>nginx</td><td>336769</td><td>开启keepalive, 关闭log</td></tr><tr><td>直连ip</td><td>340748</td><td>测试中的pod ip为真实ip</td></tr></tbody></table><p>通过实验可以看到，使用nginx代理和直连ip，rps相差不大；原始ingress-nginx rps很低，优化后rps提升一倍，但对比nginx还是有较大的性能差异。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>默认ingress-nginx性能较差，配置优化后也只有15w RPS，对比原生nginx（33W) 差距较大。经过分析主要瓶颈在于ingress-nginx的lua过滤脚本，具体原因需要进一步分析。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol><li><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#upstream-keepalive-connections" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#upstream-keepalive-connections</a></li><li><a href="https://www.nginx.com/blog/testing-performance-nginx-ingress-controller-kubernetes/" target="_blank" rel="noopener">https://www.nginx.com/blog/testing-performance-nginx-ingress-controller-kubernetes/</a></li></ol><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>本测试所有配置见<a href="https://github.com/qingwave/ingress-nginx-benchmark" target="_blank" rel="noopener">qingwave/ingress-nginx-benchmark</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Ingress是目前Kubernetes集群流量接入的重要入口，了解其性能指标有助于用户选用合适的网络方案。&lt;/p&gt;
&lt;h2 id=&quot;测试方案&quot;&gt;&lt;a href=&quot;#测试方案&quot; class=&quot;headerlink&quot; title=&quot;测试方案&quot;&gt;&lt;/a&gt;测试方案&lt;/h2&gt;&lt;p&gt;
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="ingress" scheme="https://qinng.now.sh/tags/ingress/"/>
    
      <category term="nginx" scheme="https://qinng.now.sh/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>可能是史上最全的Kubernetes证书解析</title>
    <link href="https://qinng.now.sh/k8s-tls/"/>
    <id>https://qinng.now.sh/k8s-tls/</id>
    <published>2020-04-25T00:53:03.000Z</published>
    <updated>2020-06-05T10:49:19.967Z</updated>
    
    <content type="html"><![CDATA[<p>为了避免广告法，题目还是加个可能吧。</p><p>想要安全就必须复杂起来，证书是少不了的。在Kubernetes中提供了非常丰富的证书类型，满足各种不同场景的需求，今天我们就来看一看Kubernetes中的证书。</p><h2 id="k8s证书分类"><a href="#k8s证书分类" class="headerlink" title="k8s证书分类"></a>k8s证书分类</h2><p>在说证书之前，先想想作为集群的入口apiserver需要提供那些服务，与那些组件通信，通信的两方可能需要配置证书。<br>与apiserver通信的组件大体可以分为以下几类：</p><ul><li>client(kubectl，restapi等)：普通用户与apiserver之间的通信，对各类资源进行操作</li><li>kubelet，kubeproxy：master与node之间的通信</li><li>etcd：k8s的存储库</li><li>webhook：这里指apiserver提供的admission-webhook，在数据持久化前调用webhook</li><li>aggregation layer：扩展apiserver, 需要将自定义的api注册到k8s中，相比CRD性能更新</li><li>pod: 在pod中调用apiserver(一般调用为10.254.0.1:433)</li></ul><p>居然有这么多种，除了在pod中通过serviceacount认证（当然pod需要认证apiserver的证书），其他几种都需要配置证书。</p><p>其他集群内组件与apiserver通信的，kubelet/etcd/kube-proxy对应的也可以配置证书。</p><h2 id="apiserver证书"><a href="#apiserver证书" class="headerlink" title="apiserver证书"></a>apiserver证书</h2><p>简单列举下apiserver证书相关的启动参数</p><pre><code>--cert-dir string                           The directory where the TLS certs are located. If --tls-cert-file and --tls-private-key-file are provided, this flag will be ignored. (default &quot;/var/run/kubernetes&quot;)--client-ca-file string                     If set, any request presenting a client certificate signed by one of the authorities in the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.--etcd-certfile string                      SSL certification file used to secure etcd communication.--etcd-keyfile string                       SSL key file used to secure etcd communication.--kubelet-certificate-authority string      Path to a cert file for the certificate authority.--kubelet-client-certificate string         Path to a client cert file for TLS.--kubelet-client-key string                 Path to a client key file for TLS.--proxy-client-cert-file string             Client certificate used to prove the identity of the aggregator or kube-apiserver when it must call out during a request. This includes proxying requests to a user api-server and calling out to webhook admission plugins. It is expected that this cert includes a signature from the CA in the --requestheader-client-ca-file flag. That CA is published in the &#39;extension-apiserver-authentication&#39; configmap in the kube-system namespace. Components recieving calls from kube-aggregator should use that CA to perform their half of the mutual TLS verification.--proxy-client-key-file string              Private key for the client certificate used to prove the identity of the aggregator or kube-apiserver when it must call out during a request. This includes proxying requests to a user api-server and calling out to webhook admission plugins.--requestheader-allowed-names stringSlice   List of client certificate common names to allow to provide usernames in headers specified by --requestheader-username-headers. If empty, any client certificate validated by the authorities in --requestheader-client-ca-file is allowed.--requestheader-client-ca-file string       Root certificate bundle to use to verify client certificates on incoming requests before trusting usernames in headers specified by --requestheader-username-headers--service-account-key-file stringArray      File containing PEM-encoded x509 RSA or ECDSA private or public keys, used to verify ServiceAccount tokens. If unspecified, --tls-private-key-file is used. The specified file can contain multiple keys, and the flag can be specified multiple times with different files.--ssh-keyfile string                        If non-empty, use secure SSH proxy to the nodes, using this user keyfile--tls-ca-file string                        If set, this certificate authority will used for secure access from Admission Controllers. This must be a valid PEM-encoded CA bundle. Alternatively, the certificate authority can be appended to the certificate provided by --tls-cert-file.--tls-cert-file string                      File containing the default x509 Certificate for HTTPS. (CA cert, if any, concatenated after server cert). If HTTPS serving is enabled, and --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to /var/run/kubernetes.--tls-private-key-file string               File containing the default x509 private key matching --tls-cert-file.--tls-sni-cert-key namedCertKey             A pair of x509 certificate and private key file paths, optionally suffixed with a list of domain patterns which are fully qualified domain names, possibly with prefixed wildcard segments. If no domain patterns are provided, the names of the certificate are extracted. Non-wildcard matches trump over wildcard matches, explicit domain patterns trump over extracted names. For multiple key/certificate pairs, use the --tls-sni-cert-key multiple times. Examples: &quot;example.crt,example.key&quot; or &quot;foo.crt,foo.key:*.foo.com,foo.com&quot;. (default [])--oidc-ca-file string                       If set, the OpenID server&#39;s certificate will be verified by one of the authorities in the oidc-ca-file, otherwise the host&#39;s root CA set will be used.--tls-sni-cert-key namedCertKey             A pair of x509 certificate and private key file paths, optionally suffixed with a list of domain patterns which are fully qualified domain names, possibly with prefixed wildcard segments. If no domain patterns are provided, the names of the certificate are extracted. Non-wildcard matches trump over wildcard matches, explicit domain patterns trump over extracted names. For multiple key/certificate pairs, use the --tls-sni-cert-key multiple times. Examples: &quot;example.crt,example.key&quot; or &quot;foo.crt,foo.key:*.foo.com,foo.com&quot;. (default [])</code></pre><p>不要害怕，咱们一个个看。</p><h3 id="tls证书"><a href="#tls证书" class="headerlink" title="tls证书"></a>tls证书</h3><p>首先，apiserver本身是一个http服务器，需要tls证书</p><pre><code>--tls-cert-file string    File containing the default x509 Certificate for HTTPS. (CA cert, if any, concatenated after server cert). If HTTPS serving is enabled, and --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to the directory specified by --cert-dir.--tls-private-key-file string    File containing the default x509 private key matching --tls-cert-file.其他client验证apiserver时可以通过签署这两个证书的CA，我们称为`tls-ca`</code></pre><h3 id="client证书"><a href="#client证书" class="headerlink" title="client证书"></a>client证书</h3><p>apiserver提供了tls证书，同样也需要验证client的配置，但是client太多了(kubectl,各种restapi调用的), 这些client需要统一用一个CA签发，我们称为<code>client-ca</code>。</p><pre><code>--client-ca-file string    If set, any request presenting a client certificate signed by one of the authorities in the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.</code></pre><p>需要注意的是，在apiserver认证中，通过<code>CN</code>和<code>O</code>来识别用户，开启RBAC的用户要配置<code>CN</code>和<code>O</code>做一些授权：</p><ul><li>CN：Common Name，kube-apiserver 从证书中提取作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li><li>O：Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)</li></ul><p>如kube-proxy的证书申请, User为<code>system:kube-proxy</code>, Group为<code>k8s</code></p><pre class="line-numbers language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"CN"</span><span class="token operator">:</span> <span class="token string">"system:kube-proxy"</span><span class="token punctuation">,</span>  <span class="token property">"hosts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"key"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"algo"</span><span class="token operator">:</span> <span class="token string">"rsa"</span><span class="token punctuation">,</span>    <span class="token property">"size"</span><span class="token operator">:</span> <span class="token number">2048</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"names"</span><span class="token operator">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>      <span class="token property">"C"</span><span class="token operator">:</span> <span class="token string">"CN"</span><span class="token punctuation">,</span>      <span class="token property">"ST"</span><span class="token operator">:</span> <span class="token string">"BeiJing"</span><span class="token punctuation">,</span>      <span class="token property">"L"</span><span class="token operator">:</span> <span class="token string">"BeiJing"</span><span class="token punctuation">,</span>      <span class="token property">"O"</span><span class="token operator">:</span> <span class="token string">"k8s"</span><span class="token punctuation">,</span>      <span class="token property">"OU"</span><span class="token operator">:</span> <span class="token string">"System"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">]</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="requestheader证书"><a href="#requestheader证书" class="headerlink" title="requestheader证书"></a>requestheader证书</h3><p>apiserver可以使用HTTP请求头中的指定字段来进行认证，相关配置如下:</p><pre><code>--requestheader-allowed-names stringSlice    List of client certificate common names to allow to provide usernames in headers specified by --requestheader-username-headers. If empty, any client certificate validated by the authorities in --requestheader-client-ca-file is allowed.--requestheader-client-ca-file string    Root certificate bundle to use to verify client certificates on incoming requests before trusting usernames in headers specified by --requestheader-username-headers. WARNING: generally do not depend on authorization being already done for incoming requests.--requestheader-extra-headers-prefix strings            List of request header prefixes to inspect. X-Remote-Extra- is suggested.--requestheader-group-headers strings                   List of request headers to inspect for groups. X-Remote-Group is suggested.--requestheader-username-headers strings                List of request headers to inspect for usernames. X-Remote-User is common.</code></pre><p>收到请求时，apiserver会首先认证<code>requsetheader-ca</code>，验证成功并且<code>CN</code>在<code>requestheader-allowed-names</code>（默认全部需求）中，然后通过Http header中的<code>X-Remote-User, X-Remote-Group</code>去得到用户；如果匹配不成功回去验证<code>client-ca</code>。</p><p>如上，<code>requestheader</code>证书与<code>client-ca</code>不能是同一个。</p><h3 id="proxy证书"><a href="#proxy证书" class="headerlink" title="proxy证书"></a>proxy证书</h3><p>k8s提供了丰富的扩展机制，CRD与[API Aggregation][<a href="https://kubernetes.io/zh/docs/tasks/access-kubernetes-api/configure-aggregation-layer/]。" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/tasks/access-kubernetes-api/configure-aggregation-layer/]。</a><br>对于API Aggregation(例如metrics-server提供了metrics.k8s.io api), apiserver接受到请求后经过一系列验证过滤，会将请求转发到扩展API，这里apisever作为代理服务器，需要配置配置证书。</p><pre><code>--proxy-client-cert-file string                 Client certificate used to prove the identity of the aggregator or kube-apiserver when it must call out during a request. This includes proxying requests to a user api-server and calling out to webhook admission plugins. It is expected that this cert includes a signature from the CA in the --requestheader-client-ca-file flag. That CA is published in the &#39;extension-apiserver-authentication&#39; configmap in the kube-system namespace. Components recieving calls from kube-aggregator should use that CA to perform their half of the mutual TLS verification.--proxy-client-key-file string                  Private key for the client certificate used to prove the identity of the aggregator or kube-apiserver when it must call out during a request. This includes proxying requests to a user api-server and calling out to webhook admission plugins.</code></pre><p>需要注意的是对证书需要通过<code>requestheader-ca</code>签发，扩展api会通过requestheader证书去验证，具体流程后面会写一篇，下图为官方提供的流程<br><img src="https://d33wubrfki0l68.cloudfront.net/3c5428678a95c3715894011d8dd4812d2cf229b9/e745c/images/docs/aggregation-api-auth-flow.png" alt="aggregation-api"></p><h3 id="kubelet证书"><a href="#kubelet证书" class="headerlink" title="kubelet证书"></a>kubelet证书</h3><p>对于kubelet，apiserver单独提供了证书配置选项，同时kubelet组件也提供了反向设置的相关选项:</p><pre><code># API Server--kubelet-certificate-authority string    Path to a cert file for the certificate authority.--kubelet-client-certificate string    Path to a client cert file for TLS.--kubelet-client-key string    Path to a client key file for TLS.# kubelet--client-ca-file string    If set, any request presenting a client certificate signed by one of the authorities in the client-ca-file is authenticated with an identity corresponding to the CommonName of the client certificate.--tls-cert-file string     File containing x509 Certificate used for serving HTTPS (with intermediate certs, if any, concatenated after server cert). If --tls-cert-file and --tls-private-key-file are not provided, a self-signed certificate and key are generated for the public address and saved to the directory passed to --cert-dir.--tls-private-key-file string    File containing x509 private key matching --tls-cert-file.</code></pre><p>kubelet也是即作为server也作为client, 需要提供tls证书和client-ca, 我们称这个CA为<code>kubelet-ca</code>, 可以是单独的CA。</p><h3 id="etcd证书"><a href="#etcd证书" class="headerlink" title="etcd证书"></a>etcd证书</h3><p>这个也不用多说，用来连接etcd，由<code>etcd-ca</code>签发</p><pre><code>--etcd-certfile string                      SSL certification file used to secure etcd communication.--etcd-keyfile string                       SSL key file used to secure etcd communication.</code></pre><h3 id="serviceaccount证书"><a href="#serviceaccount证书" class="headerlink" title="serviceaccount证书"></a>serviceaccount证书</h3><p>在k8s中，通过<code>JWT</code>认证<code>serviecaccount</code>，同样有两个证书配置:</p><pre><code># apiserver--service-account-key-file stringArray # 用于验证sa    File containing PEM-encoded x509 RSA or ECDSA private or public keys, used to verify ServiceAccount tokens. The specified file can contain multiple keys, and the flag can be specified multiple times with different files. If unspecified, --tls-private-key-file is used. Must be specified when --service-account-signing-key is provided--service-account-signing-key-file string    Path to the file that contains the current private key of the service account token issuer. The issuer will sign issued ID tokens with this private key. (Requires the &#39;TokenRequest&#39; feature gate.)# controller-manager–service-account-private-key-file #用于签署sa</code></pre><p>这两个配置描述了对<code>serviceaccount</code>进行签名验证时所使用的证书；可以是单独的生成，我们称为<code>sa-key</code>。</p><h2 id="其他证书"><a href="#其他证书" class="headerlink" title="其他证书"></a>其他证书</h2><p>其他还有<code>oidc</code>证书，用于OpenID认证；<code>ssh</code>证书，用来连接node，目前以及废弃。</p><p>etcd与kubelet证书上面已经提过了，需要双方都配置。</p><p>k8s中也支持证书申请，用户可以创建<code>CertificateSigningRequest</code>来申请证书，需要在controller-manager配置下面的证书，用于签发证书称为<code>sing-ca</code>，多用于webhook的证书配置。</p><pre><code>--cluster-signing-cert-file string          Filename containing a PEM-encoded X509 CA certificate used to issue cluster-scoped certificates (default &quot;/etc/kubernetes/ca/ca.pem&quot;)--cluster-signing-key-file string           Filename containing a PEM-encoded RSA or ECDSA private key used to sign cluster-scoped certificates (default &quot;/etc/kubernetes/ca/ca.key&quot;)</code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>k8s提供了强大的功能，需要考虑到各个场景的安全问题，上面我们梳理了遍目前常用的证书</p><ul><li>tls-ca</li><li>client-ca</li><li>requestheader-ca</li><li>proxy-ca</li><li>kubelet-ca</li><li>etcd-ca</li><li>sa-key</li><li>sign-ca</li></ul><p>上面除了<code>proxy-ca</code>必须使用<code>requestheader-ca</code>签发，其他所有的都可以是单独的CA，可以根据安全性评估是使用一个CA还是多个CA，我们建议下面的CA尽量是独立的</p><ul><li>client-ca</li><li>requestheader-ca</li><li>etcd-ca</li><li>kubelet-ca</li><li>sign-ca</li></ul><p>终于理完了，可以起床啦。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;为了避免广告法，题目还是加个可能吧。&lt;/p&gt;
&lt;p&gt;想要安全就必须复杂起来，证书是少不了的。在Kubernetes中提供了非常丰富的证书类型，满足各种不同场景的需求，今天我们就来看一看Kubernetes中的证书。&lt;/p&gt;
&lt;h2 id=&quot;k8s证书分类&quot;&gt;&lt;a href=
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="apiserver" scheme="https://qinng.now.sh/tags/apiserver/"/>
    
      <category term="tls" scheme="https://qinng.now.sh/tags/tls/"/>
    
  </entry>
  
  <entry>
    <title>kubernetes扩展apiserver实现分析</title>
    <link href="https://qinng.now.sh/kube-apiserver-aggretation-api/"/>
    <id>https://qinng.now.sh/kube-apiserver-aggretation-api/</id>
    <published>2020-04-24T07:28:16.000Z</published>
    <updated>2020-04-28T02:13:33.259Z</updated>
    
    <content type="html"><![CDATA[<p>Kubernetes提供了丰富的扩展功能，实现自定义资源有两种方式<code>CRD</code>与<code>Aggregation API</code>。相对于<code>CRD</code>，扩展API功能更丰富，可以实现单独的存储。今天来聊一聊，k8s是如是实现扩展api的，它与apiserver之间又是如何协作的</p><h2 id="AggregationApiserver介绍"><a href="#AggregationApiserver介绍" class="headerlink" title="AggregationApiserver介绍"></a>AggregationApiserver介绍</h2><p><code>Aggregator</code>类似于一个七层负载均衡，将来自用户的请求拦截转发给其他服务器，并且负责整个 APIServer 的 Discovery 功能。</p><p>通过<code>APIServices</code>对象关联到某个<code>Service</code>来进行请求的转发，其关联的<code>Service</code>类型进一步决定了请求转发形式。<code>Aggregator</code>包括一个<code>GenericAPIServer</code>和维护自身状态的<code>Controller</code>。其中 <code>GenericAPIServer</code>主要处理<code>apiregistration.k8s.io</code>组下的<code>APIService</code>资源请求。</p><p>主要controller包括：</p><ol><li>apiserviceRegistrationController：负责<code>APIServices</code>中资源的注册与删除；</li><li>availableConditionController：维护<code>APIServices</code>的可用状态，包括其引用<code>Service</code>是否可用等；</li><li>autoRegistrationController：用于保持API中存在的一组特定的<code>APIServices</code>；</li><li>crdRegistrationController：负责将<code>CRD GroupVersions</code>自动注册到<code>APIServices</code>中；</li><li>openAPIAggregationController：将<code>APIServices</code>资源的变化同步至提供的<code>OpenAPI</code>文档；</li></ol><p>在 kube-apiserver 中需要增加以下配置来开启 API Aggregation：</p><pre><code>--proxy-client-cert-file=/etc/kubernetes/certs/proxy.crt--proxy-client-key-file=/etc/kubernetes/certs/proxy.key--requestheader-client-ca-file=/etc/kubernetes/certs/proxy-ca.crt--requestheader-extra-headers-prefix=X-Remote-Extra---requestheader-group-headers=X-Remote-Group--requestheader-username-headers=X-Remote-User</code></pre><p>如果 kube-proxy 没有和 API server 运行在同一台主机上，那么需要确保启用了如下 apiserver 标记：</p><pre><code>--enable-aggregator-routing=true</code></pre><p>在<a href="./kube-apiserver-start.md">apiserver启动流程</a>中，分析了<code>AggregationApiserver</code>的初始化流程, 需要了解的可以回去看下。</p><h2 id="AggregationApiserver认证流程"><a href="#AggregationApiserver认证流程" class="headerlink" title="AggregationApiserver认证流程"></a>AggregationApiserver认证流程</h2><p>与自定义资源定义（CRD）不同，除标准的 Kubernetes apiserver 外，Aggregation API 还涉及另一个服务器：扩展 apiserver。Kubernetes apiserver 将需要与您的扩展 apiserver 通信，并且您的扩展 apiserver 也需要与 Kubernetes apiserver 通信。为了确保此通信的安全，Kubernetes apiserver 使用 x509 证书向扩展 apiserver 认证。</p><p>AggregationApi的请求链路如下：</p><pre><code>defaultHandlerChain-&gt;aggregator-&gt;aggregation-apiserver-&gt;aggregator-&gt;user</code></pre><p>大致流程如下：</p><ol><li>Kubernetes apiserver：对发出请求的用户身份认证，并对请求的 API 路径执行鉴权。</li><li>Kubernetes apiserver：将请求转发到扩展 apiserver</li><li>扩展 apiserver：认证来自 Kubernetes apiserver 的请求</li><li>扩展 apiserver：对来自原始用户的请求鉴权</li><li>扩展 apiserver：执行对应操作返回</li></ol><p>如图所示：<br><a href="https://d33wubrfki0l68.cloudfront.net/3c5428678a95c3715894011d8dd4812d2cf229b9/e745c/images/docs/aggregation-api-auth-flow.png" target="_blank" rel="noopener">aggregation-apiserver-auth</a></p><p>apiserver与扩展apiserver通过证书认证,</p><ul><li>apiserver配置<code>porxy-client</code>证书(使用requestheader根证书签发)，扩展apiserver配置<code>reqeustheader</code>根证书，如果没配置，会默认从configmap <code>kube-system/extension-apiserver-authentication</code> 去找</li><li>扩展apiserver通过<code>extension-apiserver-authentication</code>获取apiserver的<code>client-ca</code>，生成证书对，apiserver可以使用<code>client-ca</code>验证它</li><li>由于apiserver-&gt;扩展apiserver通过<code>reqeustheader</code>方式认证，apiserver会将接受到的请求经过认证，转换为header，扩展apiserver通过header获取用户，再通过apiserver接口做权限校验。</li></ul><p>有同学有疑问，为什么这里需要做两次认证，两次鉴权。这是由于扩展apiserveer是一个单独的服务器，如果接受非apiserver的请求也是需要做认证鉴权的。那能不能认证是apiserver后就不做鉴权了呢，这得需要apiserver在转发请求时加入鉴权信息就行。</p><h2 id="AggregationApiserver处理流程"><a href="#AggregationApiserver处理流程" class="headerlink" title="AggregationApiserver处理流程"></a>AggregationApiserver处理流程</h2><h3 id="apiserver处理逻辑"><a href="#apiserver处理逻辑" class="headerlink" title="apiserver处理逻辑"></a>apiserver处理逻辑</h3><p>在apiserver认证时，认证接受会将认证信息删除, 可参考前面的[apiserver认证源码分析]</p><p>处理逻辑如下：</p><ol><li>通过<code>context</code>获取user信息</li><li>构造请求，删除reqeustheader信息，通过user重新填充</li><li>通过<code>proxyRoundTripper</code>转发请求</li></ol><p>(kube-apiserver-authentication-code.md)<br>aggregation的<a href="https://github.com/kubernetes/kubernetes/blob/df9b4e92e84849e2b9fdb5b4849c9c4ebfae8040/staging/src/k8s.io/kube-aggregator/pkg/apiserver/handler_proxy.go#L109" target="_blank" rel="noopener">hander</a>的实现：</p><pre class="line-numbers language-golang"><code class="language-golang">// 通过context获取user    user, ok := genericapirequest.UserFrom(req.Context())    if !ok {        proxyError(w, req, "missing user", http.StatusInternalServerError)        return  }  // 构造请求url,通过apiservice配置的service/namespace随机得到某个endpoint后端  location := &url.URL{}    location.Scheme = "https"    rloc, err := r.serviceResolver.ResolveEndpoint(handlingInfo.serviceNamespace, handlingInfo.serviceName, handlingInfo.servicePort)    if err != nil {        klog.Errorf("error resolving %s/%s: %v", handlingInfo.serviceNamespace, handlingInfo.serviceName, err)        proxyError(w, req, "service unavailable", http.StatusServiceUnavailable)        return    }    location.Host = rloc.Host    location.Path = req.URL.Path  location.RawQuery = req.URL.Query().Encode()  // we need to wrap the roundtripper in another roundtripper which will apply the front proxy headers  // 包裹请求信息，将user信息放到header中    proxyRoundTripper, upgrade, err := maybeWrapForConnectionUpgrades(handlingInfo.restConfig, handlingInfo.proxyRoundTripper, req)    if err != nil {        proxyError(w, req, err.Error(), http.StatusInternalServerError)        return    }  proxyRoundTripper = transport.NewAuthProxyRoundTripper(user.GetName(), user.GetGroups(), user.GetExtra(), proxyRoundTripper)  // 调用后端  handler := proxy.NewUpgradeAwareHandler(location, proxyRoundTripper, true, upgrade, &responder{w: w})    handler.ServeHTTP(w, newReq)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据扩展apiserver找到后端时通过service获取对应endpoint列表，随机选择某个endpoint、<br>实现如下：</p><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ResourceLocation returns a URL to which one can send traffic for the specified service.</span><span class="token keyword">func</span> <span class="token function">ResolveEndpoint</span><span class="token punctuation">(</span>services listersv1<span class="token punctuation">.</span>ServiceLister<span class="token punctuation">,</span> endpoints listersv1<span class="token punctuation">.</span>EndpointsLister<span class="token punctuation">,</span> namespace<span class="token punctuation">,</span> id <span class="token builtin">string</span><span class="token punctuation">,</span> port <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    svc<span class="token punctuation">,</span> err <span class="token operator">:=</span> services<span class="token punctuation">.</span><span class="token function">Services</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    svcPort<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">findServicePort</span><span class="token punctuation">(</span>svc<span class="token punctuation">,</span> port<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">switch</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Type <span class="token operator">==</span> v1<span class="token punctuation">.</span>ServiceTypeClusterIP<span class="token punctuation">,</span> svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Type <span class="token operator">==</span> v1<span class="token punctuation">.</span>ServiceTypeLoadBalancer<span class="token punctuation">,</span> svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Type <span class="token operator">==</span> v1<span class="token punctuation">.</span>ServiceTypeNodePort<span class="token punctuation">:</span>        <span class="token comment" spellcheck="true">// these are fine</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unsupported service type %q"</span><span class="token punctuation">,</span> svc<span class="token punctuation">.</span>Spec<span class="token punctuation">.</span>Type<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    eps<span class="token punctuation">,</span> err <span class="token operator">:=</span> endpoints<span class="token punctuation">.</span><span class="token function">Endpoints</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>svc<span class="token punctuation">.</span>Name<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>eps<span class="token punctuation">.</span>Subsets<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">NewServiceUnavailable</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"no endpoints available for service %q"</span><span class="token punctuation">,</span> svc<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Pick a random Subset to start searching from.</span>    ssSeed <span class="token operator">:=</span> rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>eps<span class="token punctuation">.</span>Subsets<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// Find a Subset that has the port.</span>    <span class="token keyword">for</span> ssi <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> ssi <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>eps<span class="token punctuation">.</span>Subsets<span class="token punctuation">)</span><span class="token punctuation">;</span> ssi<span class="token operator">++</span> <span class="token punctuation">{</span>        ss <span class="token operator">:=</span> <span class="token operator">&amp;</span>eps<span class="token punctuation">.</span>Subsets<span class="token punctuation">[</span><span class="token punctuation">(</span>ssSeed<span class="token operator">+</span>ssi<span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">len</span><span class="token punctuation">(</span>eps<span class="token punctuation">.</span>Subsets<span class="token punctuation">)</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">.</span>Addresses<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> ss<span class="token punctuation">.</span>Ports <span class="token punctuation">{</span>            <span class="token keyword">if</span> ss<span class="token punctuation">.</span>Ports<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Name <span class="token operator">==</span> svcPort<span class="token punctuation">.</span>Name <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// Pick a random address.</span>                <span class="token comment" spellcheck="true">// 核心，随机选择endpoint</span>                ip <span class="token operator">:=</span> ss<span class="token punctuation">.</span>Addresses<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">.</span>Addresses<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>IP                port <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>ss<span class="token punctuation">.</span>Ports<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Port<span class="token punctuation">)</span>                <span class="token keyword">return</span> <span class="token operator">&amp;</span>url<span class="token punctuation">.</span>URL<span class="token punctuation">{</span>                    Scheme<span class="token punctuation">:</span> <span class="token string">"https"</span><span class="token punctuation">,</span>                    Host<span class="token punctuation">:</span>   net<span class="token punctuation">.</span><span class="token function">JoinHostPort</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">NewServiceUnavailable</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"no endpoints available for service %q"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ProxyRoundTripper创建在<a href="https://github.com/kubernetes/kubernetes/blob/a42e029e6905bee5b9d5489610c4fbe5988eeac6/staging/src/k8s.io/client-go/transport/round_trippers.go#L101" target="_blank" rel="noopener">round_trippers.go</a></p><pre class="line-numbers language-golang"><code class="language-golang">func NewAuthProxyRoundTripper(username string, groups []string, extra map[string][]string, rt http.RoundTripper) http.RoundTripper {    return &authProxyRoundTripper{        username: username,        groups:   groups,        extra:    extra,        rt:       rt,    }}func (rt *authProxyRoundTripper) RoundTrip(req *http.Request) (*http.Response, error) {  req = utilnet.CloneRequest(req)  // 包裹user信息    SetAuthProxyHeaders(req, rt.username, rt.groups, rt.extra)    return rt.rt.RoundTrip(req)}// SetAuthProxyHeaders stomps the auth proxy header fields.  It mutates its argument.func SetAuthProxyHeaders(req *http.Request, username string, groups []string, extra map[string][]string) {  // 清楚原始url的requestheader信息    req.Header.Del("X-Remote-User")    req.Header.Del("X-Remote-Group")    for key := range req.Header {        if strings.HasPrefix(strings.ToLower(key), strings.ToLower("X-Remote-Extra-")) {            req.Header.Del(key)        }    }  // 通过user重新填充信息    req.Header.Set("X-Remote-User", username)    for _, group := range groups {        req.Header.Add("X-Remote-Group", group)    }    for key, values := range extra {        for _, value := range values {            req.Header.Add("X-Remote-Extra-"+headerKeyEscape(key), value)        }    }}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="扩展apiserver处理逻辑"><a href="#扩展apiserver处理逻辑" class="headerlink" title="扩展apiserver处理逻辑"></a>扩展apiserver处理逻辑</h3><p>下以metrics-server为例说明扩展apiserver在收到apiserver请求后的处理</p><p>与apiserver初始化相同，metrics-server也需要初始化生成<code>genericServer</code>, 然后注册apigroup<br><code>pkg/metrics-server/config.go</code></p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c Config<span class="token punctuation">)</span> <span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>MetricsServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    informer<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">informer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    kubeletClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">kubeletClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    addressResolver <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">addressResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 创建scraper，负责抓取监控数据</span>    scrape <span class="token operator">:=</span> scraper<span class="token punctuation">.</span><span class="token function">NewScraper</span><span class="token punctuation">(</span>informer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kubeletClient<span class="token punctuation">,</span> addressResolver<span class="token punctuation">,</span> c<span class="token punctuation">.</span>ScrapeTimeout<span class="token punctuation">)</span>    scraper<span class="token punctuation">.</span><span class="token function">RegisterScraperMetrics</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ScrapeTimeout<span class="token punctuation">)</span>    <span class="token function">RegisterServerMetrics</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>MetricResolution<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 生成genericServer, 包裹有 DefaultBuildHandlerChain</span>    genericServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span>Apiserver<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span>informer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"metrics-server"</span><span class="token punctuation">,</span> genericapiserver<span class="token punctuation">.</span><span class="token function">NewEmptyDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    store <span class="token operator">:=</span> storage<span class="token punctuation">.</span><span class="token function">NewStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 注册api</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">Install</span><span class="token punctuation">(</span>store<span class="token punctuation">,</span> informer<span class="token punctuation">.</span><span class="token function">Core</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> genericServer<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>MetricsServer<span class="token punctuation">{</span>        GenericAPIServer<span class="token punctuation">:</span> genericServer<span class="token punctuation">,</span>        storage<span class="token punctuation">:</span>          store<span class="token punctuation">,</span>        scraper<span class="token punctuation">:</span>          scrape<span class="token punctuation">,</span>        resolution<span class="token punctuation">:</span>       c<span class="token punctuation">.</span>MetricResolution<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>api注册代码，通过<code>Build</code>生成apigroup，调用<code>InstallAPIGroup</code>进行注册<br><code>pkg/api/install.go</code></p><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// InstallStorage builds the metrics for the metrics.k8s.io API, and then installs it into the given API metrics-server.</span><span class="token keyword">func</span> <span class="token function">Install</span><span class="token punctuation">(</span>metrics MetricsGetter<span class="token punctuation">,</span> informers coreinf<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> server <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    info <span class="token operator">:=</span> <span class="token function">Build</span><span class="token punctuation">(</span>metrics<span class="token punctuation">,</span> informers<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 注册apigroup</span>    <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">InstallAPIGroup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Build constructs APIGroupInfo the metrics.k8s.io API group using the given getters.</span><span class="token keyword">func</span> <span class="token function">Build</span><span class="token punctuation">(</span>m MetricsGetter<span class="token punctuation">,</span> informers coreinf<span class="token punctuation">.</span>Interface<span class="token punctuation">)</span> genericapiserver<span class="token punctuation">.</span>APIGroupInfo <span class="token punctuation">{</span>    apiGroupInfo <span class="token operator">:=</span> genericapiserver<span class="token punctuation">.</span><span class="token function">NewDefaultAPIGroupInfo</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span>GroupName<span class="token punctuation">,</span> Scheme<span class="token punctuation">,</span> metav1<span class="token punctuation">.</span>ParameterCodec<span class="token punctuation">,</span> Codecs<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 注册metrics相关api</span>    node <span class="token operator">:=</span> <span class="token function">newNodeMetrics</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"nodemetrics"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">,</span> informers<span class="token punctuation">.</span><span class="token function">Nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    pod <span class="token operator">:=</span> <span class="token function">newPodMetrics</span><span class="token punctuation">(</span>metrics<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token string">"podmetrics"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">,</span> informers<span class="token punctuation">.</span><span class="token function">Pods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Lister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    metricsServerResources <span class="token operator">:=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>rest<span class="token punctuation">.</span>Storage<span class="token punctuation">{</span>        <span class="token string">"nodes"</span><span class="token punctuation">:</span> node<span class="token punctuation">,</span>        <span class="token string">"pods"</span><span class="token punctuation">:</span>  pod<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    apiGroupInfo<span class="token punctuation">.</span>VersionedResourcesStorageMap<span class="token punctuation">[</span>v1beta1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">.</span>Version<span class="token punctuation">]</span> <span class="token operator">=</span> metricsServerResources    <span class="token keyword">return</span> apiGroupInfo<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同apiserver，metrics-server收到请求后会经过<code>DefaultBuildHandlerChain</code></p><ul><li>认证，从apiserver转发来的请求是<code>reqeustheader</code>形式，metrics-server会使用<code>requestheader-ca</code>验证证书</li><li>鉴权，同apiserver一样</li></ul><blockquote><p>注意, 如果apiserver未配置<code>proxy-client</code>证书，metrics-server认证不通过，即使apiserver认证通过，metrics-server也会认为是匿名用户<code>system:anonymous</code></p></blockquote><p>最后，metrics-server执行具体逻辑，返回结果。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>扩容apiserver的创建，处理流程与apiserver完全一样，可以直接调用apiserver的库，扩展apiserver直接处理请求，不需要经过webhook，性能更好，更强大的是完全不使用etcd，替换成时序数据库或者其他数据库。后续可以分析下CRD与扩展apiserver的区别以及使用场景。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Kubernetes提供了丰富的扩展功能，实现自定义资源有两种方式&lt;code&gt;CRD&lt;/code&gt;与&lt;code&gt;Aggregation API&lt;/code&gt;。相对于&lt;code&gt;CRD&lt;/code&gt;，扩展API功能更丰富，可以实现单独的存储。今天来聊一聊，k8s是如是实现扩展
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="apiserver" scheme="https://qinng.now.sh/tags/apiserver/"/>
    
  </entry>
  
  <entry>
    <title>kube-apiserver启动流程分析</title>
    <link href="https://qinng.now.sh/kube-apiserver-start/"/>
    <id>https://qinng.now.sh/kube-apiserver-start/</id>
    <published>2020-04-24T07:28:16.000Z</published>
    <updated>2020-04-25T12:32:58.748Z</updated>
    
    <content type="html"><![CDATA[<p>kube-apiserver 共由 3 个组件构成（Aggregator. KubeAPIServer. APIExtensionServer），这些组件依次通过 Delegation 处理请求：</p><ul><li>Aggregator：暴露的功能类似于一个七层负载均衡，将来自用户的请求拦截转发给其他服务器，并且负责整个 APIServer 的 Discovery 功能；也负责处理ApiService，注册对应的扩展api。</li><li>KubeAPIServer ：负责对请求的一些通用处理，认证. 鉴权等，以及处理各个内建资源的 REST 服务；</li><li>APIExtensionServer：主要处理 CustomResourceDefinition（CRD）和 CustomResource（CR）的 REST 请求，也是 Delegation 的最后一环，如果对应 CR 不能被处理的话则会返回 404。</li></ul><h2 id="kube-apiserver启动流程"><a href="#kube-apiserver启动流程" class="headerlink" title="kube-apiserver启动流程"></a>kube-apiserver启动流程</h2><p>Apiserver通过<code>Run</code>方法启动, 主要逻辑为：</p><ol><li>调用<code>CreateServerChain</code>构建服务调用链并判断是否启动非安全的<code>httpserver</code>，<code>httpserver</code>链中包含 apiserver要启动的三个server，以及为每个server注册对应资源的路由；</li><li>调用<code>server.PrepareRun</code>进行服务运行前的准备，该方法主要完成了健康检查. 存活检查和OpenAPI路由的注册工作；</li><li><p>调用<code>prepared.Run</code>启动server；</p><pre class="line-numbers language-golang"><code class="language-golang">// Run runs the specified APIServer.  This should never exit.func Run(completeOptions completedServerRunOptions, stopCh <-chan struct{}) error { // To help debugging, immediately log version klog.Infof("Version: %+v", version.Get())// 创建调用链 server, err := CreateServerChain(completeOptions, stopCh) if err != nil {     return err }// 进行一些准备工作， 注册一些hander，执行hook等 prepared, err := server.PrepareRun() if err != nil {     return err }// 开始执行 return prepared.Run(stopCh)}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>执行具体的<code>Run</code>方法</p><pre class="line-numbers language-golang"><code class="language-golang">// Run spawns the secure http server. It only returns if stopCh is closed// or the secure port cannot be listened on initially.func (s preparedGenericAPIServer) Run(stopCh <-chan struct{}) error {    delayedStopCh := make(chan struct{})    go func() {        defer close(delayedStopCh)        <-stopCh        // As soon as shutdown is initiated, /readyz should start returning failure.        // This gives the load balancer a window defined by ShutdownDelayDuration to detect that /readyz is red        // and stop sending traffic to this server.        // 当终止时，关闭readiness        close(s.readinessStopCh)        time.Sleep(s.ShutdownDelayDuration)    }()    // 执行非阻塞Run    // close socket after delayed stopCh    err := s.NonBlockingRun(delayedStopCh)    if err != nil {        return err    }    <-stopCh    // run shutdown hooks directly. This includes deregistering from the kubernetes endpoint in case of kube-apiserver.    // 关闭前执行一些hook操作    err = s.RunPreShutdownHooks()    if err != nil {        return err    }    // wait for the delayed stopCh before closing the handler chain (it rejects everything after Wait has been called).    <-delayedStopCh    // 等待所有请求执行完    // Wait for all requests to finish, which are bounded by the RequestTimeout variable.    s.HandlerChainWaitGroup.Wait()    return nil}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行<code>NonBlockingRun</code><br><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go:351</code></p><pre class="line-numbers language-golang"><code class="language-golang">func (s preparedGenericAPIServer) NonBlockingRun(stopCh <-chan struct{}) error {    auditStopCh := make(chan struct{})    // 1. 判断是否要启动审计日志    if s.AuditBackend != nil {        if err := s.AuditBackend.Run(auditStopCh); err != nil {            return fmt.Errorf("failed to run the audit backend: %v", err)        }    }    // 2. 启动 https server    internalStopCh := make(chan struct{})    var stoppedCh <-chan struct{}    if s.SecureServingInfo != nil && s.Handler != nil {        var err error        stoppedCh, err = s.SecureServingInfo.Serve(s.Handler, s.ShutdownTimeout, internalStopCh)        if err != nil {            close(internalStopCh)            close(auditStopCh)            return err        }    }    go func() {        <-stopCh        close(s.readinessStopCh)        close(internalStopCh)        if stoppedCh != nil {            <-stoppedCh        }        s.HandlerChainWaitGroup.Wait()        close(auditStopCh)    }()    // 3. 执行 postStartHooks    s.RunPostStartHooks(stopCh)    // 4. 向 systemd 发送 ready 信号    if _, err := systemd.SdNotify(true, "READY=1\n"); err != nil {        klog.Errorf("Unable to send systemd daemon successful start message: %v\n", err)    }    return nil}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="调用链分析"><a href="#调用链分析" class="headerlink" title="调用链分析"></a>调用链分析</h2><p>上一节简单分析了Apiserver的启动流程，通过初始化各种配置，封装调用链，启动Server。这节主要分析调用链。</p><p>初始化阶段, 通过<code>CreateServerChain</code>创建调用链， 代码在<a href="https://github.com/kubernetes/kubernetes/blob/1d057da2f73118893b5cc27c15d59ff03beb271e/cmd/kube-apiserver/app/server.go#L169" target="_blank" rel="noopener">server.go</a></p><pre class="line-numbers language-golang"><code class="language-golang">// CreateServerChain creates the apiservers connected via delegation.func CreateServerChain(completedOptions completedServerRunOptions, stopCh <-chan struct{}) (*aggregatorapiserver.APIAggregator, error) {  // nodetunneler与node通信，proxy实现代理功能，转发请求给其他apiservice  // apiserver到cluster的通信可以通过三种方法  // apiserver到kubelet的endpoint，用于logs功能，exec功能，port-forward功能  // HTTP连接，即使可以用HTTPS也不做任何其他校验，并不安全  // ssh tunnel，不推荐使用  nodeTunneler, proxyTransport, err := CreateNodeDialer(completedOptions)    // 1. 为 kubeAPIServer 创建配置    kubeAPIServerConfig, insecureServingInfo, serviceResolver, pluginInitializer, admissionPostStartHook, err :=                                         CreateKubeAPIServerConfig(completedOptions, nodeTunneler, proxyTransport)    if err != nil {        return nil, err    }    // 2. 判断是否配置了 APIExtensionsServer，创建 apiExtensionsConfig     apiExtensionsConfig, err := createAPIExtensionsConfig(*kubeAPIServerConfig.GenericConfig, kubeAPIServerConfig.ExtraConfig.VersionedInformers,        pluginInitializer, completedOptions.ServerRunOptions, completedOptions.MasterCount,vc        serviceResolver, webhook.NewDefaultAuthenticationInfoResolverWrapper(proxyTransport, kubeAPIServerConfig.GenericConfig.LoopbackClientConfig))    if err != nil {        return nil, err    }    // 3. 初始化 APIExtensionsServer, 通过一个空的delegate初始化    apiExtensionsServer, err := createAPIExtensionsServer(apiExtensionsConfig, genericapiserver.NewEmptyDelegate())    if err != nil {        return nil, err    }    // 4. 初始化 KubeAPIServer    kubeAPIServer, err := CreateKubeAPIServer(kubeAPIServerConfig, apiExtensionsServer.GenericAPIServer, admissionPostStartHook)    if err != nil {        return nil, err    }    // 5. 创建 AggregatorConfig    aggregatorConfig, err := createAggregatorConfig(*kubeAPIServerConfig.GenericConfig, completedOptions.ServerRunOptions, kubeAPIServerConfig.          ExtraConfig.VersionedInformers, serviceResolver, proxyTransport, pluginInitializer)    if err != nil {        return nil, err    }    // 6. 初始化 AggregatorServer    aggregatorServer, err := createAggregatorServer(aggregatorConfig, kubeAPIServer.GenericAPIServer, apiExtensionsServer.Informers)    if err != nil {        return nil, err    }    // 7. 判断是否启动非安全端口的 http server    if insecureServingInfo != nil {        insecureHandlerChain := kubeserver.BuildInsecureHandlerChain(aggregatorServer.GenericAPIServer.UnprotectedHandler(), kubeAPIServerConfig.GenericConfig)        if err := insecureServingInfo.Serve(insecureHandlerChain, kubeAPIServerConfig.GenericConfig.RequestTimeout, stopCh); err != nil {            return nil, err        }    }    return aggregatorServer, nil}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建过程主要有以下步骤：</p><ol><li>根据配置构造apiserver的配置，调用方法<code>CreateKubeAPIServerConfig</code></li><li>根据配置构造扩展的apiserver的配置，调用方法为<code>createAPIExtensionsConfig</code></li><li>创建server，包括扩展的apiserver和原生的apiserver，调用方法为<code>createAPIExtensionsServer</code>和<code>CreateKubeAPIServer</code>。主要就是将各个handler的路由方法注册到Container中去，完全遵循go-restful的设计模式，即将处理方法注册到Route中去，同一个根路径下的Route注册到WebService中去，WebService注册到Container中，Container负责分发。访问的过程为<code>Container--&gt;WebService--&gt;Route</code></li><li>聚合server的配置和和创建。主要就是将原生的apiserver和扩展的apiserver的访问进行整合，添加后续的一些处理接口。调用方法为<code>createAggregatorConfig</code>和<code>createAggregatorServer</code></li><li>创建完成，返回配置的server信息</li></ol><p>以上几个步骤，最核心的就是apiserver如何创建，即如何按照go-restful的模式，添加路由和相应的处理方法。</p><h3 id="配置初始化"><a href="#配置初始化" class="headerlink" title="配置初始化"></a>配置初始化</h3><p>先看apiserver配置的创建<code>CreateKubeAPIServerConfig-&gt;buildGenericConfig-&gt;genericapiserver.NewConfig</code></p><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// BuildGenericConfig takes the master server options and produces the genericapiserver.Config associated with it</span><span class="token keyword">func</span> <span class="token function">buildGenericConfig</span><span class="token punctuation">(</span>    s <span class="token operator">*</span>options<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span>    proxyTransport <span class="token operator">*</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>    genericConfig <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">,</span>    versionedInformers clientgoinformers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">,</span>    insecureServingInfo <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>DeprecatedInsecureServingInfo<span class="token punctuation">,</span>    serviceResolver aggregatorapiserver<span class="token punctuation">.</span>ServiceResolver<span class="token punctuation">,</span>    pluginInitializers <span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">,</span>    admissionPostStartHook genericapiserver<span class="token punctuation">.</span>PostStartHookFunc<span class="token punctuation">,</span>    storageFactory <span class="token operator">*</span>serverstorage<span class="token punctuation">.</span>DefaultStorageFactory<span class="token punctuation">,</span>    lastErr <span class="token builtin">error</span><span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 创建genericConfig,其中包括DefaultBuildHandlerChain，一系列认证授权的中间件</span>    genericConfig <span class="token operator">=</span> genericapiserver<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span>legacyscheme<span class="token punctuation">.</span>Codecs<span class="token punctuation">)</span>    genericConfig<span class="token punctuation">.</span>MergedResourceConfig <span class="token operator">=</span> master<span class="token punctuation">.</span><span class="token function">DefaultAPIResourceConfigSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 初始化各种配置</span>    <span class="token keyword">if</span> lastErr <span class="token operator">=</span> s<span class="token punctuation">.</span>GenericServerRunOptions<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>genericConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> lastErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>    genericConfig<span class="token punctuation">.</span>OpenAPIConfig <span class="token operator">=</span> genericapiserver<span class="token punctuation">.</span><span class="token function">DefaultOpenAPIConfig</span><span class="token punctuation">(</span>generatedopenapi<span class="token punctuation">.</span>GetOpenAPIDefinitions<span class="token punctuation">,</span> openapinamer<span class="token punctuation">.</span><span class="token function">NewDefinitionNamer</span><span class="token punctuation">(</span>legacyscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> extensionsapiserver<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> aggregatorscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>    genericConfig<span class="token punctuation">.</span>OpenAPIConfig<span class="token punctuation">.</span>Info<span class="token punctuation">.</span>Title <span class="token operator">=</span> <span class="token string">"Kubernetes"</span>    <span class="token comment" spellcheck="true">// 长连接请求</span>    genericConfig<span class="token punctuation">.</span>LongRunningFunc <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">BasicLongRunningRequestCheck</span><span class="token punctuation">(</span>        sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span><span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"proxy"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span><span class="token string">"attach"</span><span class="token punctuation">,</span> <span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token string">"proxy"</span><span class="token punctuation">,</span> <span class="token string">"log"</span><span class="token punctuation">,</span> <span class="token string">"portforward"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    kubeVersion <span class="token operator">:=</span> version<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    genericConfig<span class="token punctuation">.</span>Version <span class="token operator">=</span> <span class="token operator">&amp;</span>kubeVersion    <span class="token comment" spellcheck="true">// 初始化storageFactory， 用来连接etcd</span>    storageFactoryConfig <span class="token operator">:=</span> kubeapiserver<span class="token punctuation">.</span><span class="token function">NewStorageFactoryConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    storageFactoryConfig<span class="token punctuation">.</span>APIResourceConfig <span class="token operator">=</span> genericConfig<span class="token punctuation">.</span>MergedResourceConfig    completedStorageFactoryConfig<span class="token punctuation">,</span> err <span class="token operator">:=</span> storageFactoryConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Etcd<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        lastErr <span class="token operator">=</span> err        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    storageFactory<span class="token punctuation">,</span> lastErr <span class="token operator">=</span> completedStorageFactoryConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> lastErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> genericConfig<span class="token punctuation">.</span>EgressSelector <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        storageFactory<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Transport<span class="token punctuation">.</span>EgressLookup <span class="token operator">=</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">.</span>Lookup    <span class="token punctuation">}</span>    <span class="token keyword">if</span> lastErr <span class="token operator">=</span> s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span><span class="token function">ApplyWithStorageFactoryTo</span><span class="token punctuation">(</span>storageFactory<span class="token punctuation">,</span> genericConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> lastErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// Use protobufs for self-communication.</span>    <span class="token comment" spellcheck="true">// Since not every generic apiserver has to support protobufs, we</span>    <span class="token comment" spellcheck="true">// cannot default to it in generic apiserver and need to explicitly</span>    <span class="token comment" spellcheck="true">// set it in kube-apiserver.</span>    <span class="token comment" spellcheck="true">// 内部使用protobufs通信</span>    genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">.</span>ContentConfig<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"application/vnd.kubernetes.protobuf"</span>    <span class="token comment" spellcheck="true">// Disable compression for self-communication, since we are going to be</span>    <span class="token comment" spellcheck="true">// on a fast local network</span>    genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">.</span>DisableCompression <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token comment" spellcheck="true">// clientset初始化</span>    kubeClientConfig <span class="token operator">:=</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig    clientgoExternalClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientgoclientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>kubeClientConfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create real external clientset: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    versionedInformers <span class="token operator">=</span> clientgoinformers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>clientgoExternalClient<span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 初始化认证实例，支持多种认证方式：requestheader,token, tls等</span>    genericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>OpenAPIConfig<span class="token punctuation">.</span>SecurityDefinitions<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">BuildAuthenticator</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> clientgoExternalClient<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid authentication config: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 初始化鉴权配置</span>    genericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">BuildAuthorizer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid authorization config: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token operator">!</span>sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Modes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>modes<span class="token punctuation">.</span>ModeRBAC<span class="token punctuation">)</span> <span class="token punctuation">{</span>        genericConfig<span class="token punctuation">.</span>DisabledPostStartHooks<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>rbacrest<span class="token punctuation">.</span>PostStartHookName<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 初始化admission webhook的配置</span>    admissionConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>kubeapiserveradmission<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>        ExternalInformers<span class="token punctuation">:</span>    versionedInformers<span class="token punctuation">,</span>        LoopbackClientConfig<span class="token punctuation">:</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>        CloudConfigFile<span class="token punctuation">:</span>      s<span class="token punctuation">.</span>CloudProvider<span class="token punctuation">.</span>CloudConfigFile<span class="token punctuation">,</span>    <span class="token punctuation">}</span>    serviceResolver <span class="token operator">=</span> <span class="token function">buildServiceResolver</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>EnableAggregatorRouting<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>    authInfoResolverWrapper <span class="token operator">:=</span> webhook<span class="token punctuation">.</span><span class="token function">NewDefaultAuthenticationInfoResolverWrapper</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>    lastErr <span class="token operator">=</span> s<span class="token punctuation">.</span>Audit<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>        genericConfig<span class="token punctuation">,</span>        genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>        versionedInformers<span class="token punctuation">,</span>        serveroptions<span class="token punctuation">.</span><span class="token function">NewProcessInfo</span><span class="token punctuation">(</span><span class="token string">"kube-apiserver"</span><span class="token punctuation">,</span> <span class="token string">"kube-system"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span>serveroptions<span class="token punctuation">.</span>WebhookOptions<span class="token punctuation">{</span>            AuthInfoResolverWrapper<span class="token punctuation">:</span> authInfoResolverWrapper<span class="token punctuation">,</span>            ServiceResolver<span class="token punctuation">:</span>         serviceResolver<span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token keyword">if</span> lastErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 初始化注入插件</span>    pluginInitializers<span class="token punctuation">,</span> admissionPostStartHook<span class="token punctuation">,</span> err <span class="token operator">=</span> admissionConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create admission plugin initializer: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    err <span class="token operator">=</span> s<span class="token punctuation">.</span>Admission<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>        genericConfig<span class="token punctuation">,</span>        versionedInformers<span class="token punctuation">,</span>        kubeClientConfig<span class="token punctuation">,</span>        feature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">,</span>        pluginInitializers<span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to initialize admission: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>genericfeatures<span class="token punctuation">.</span>APIPriorityAndFairness<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>GenericServerRunOptions<span class="token punctuation">.</span>EnablePriorityAndFairness <span class="token punctuation">{</span>        genericConfig<span class="token punctuation">.</span>FlowControl <span class="token operator">=</span> <span class="token function">BuildPriorityAndFairness</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> clientgoExternalClient<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="APIExtensionsServer初始化"><a href="#APIExtensionsServer初始化" class="headerlink" title="APIExtensionsServer初始化"></a>APIExtensionsServer初始化</h3><p><code>APIExtensionsServer</code>最先初始化，在调用链的末尾, 处理CR、CRD相关资源.</p><p>其中包含的 controller 以及功能如下所示：</p><ol><li>openapiController：将 crd 资源的变化同步至提供的 OpenAPI 文档，可通过访问 /openapi/v2 进行查看；</li><li>crdController：负责将 crd 信息注册到 apiVersions 和 apiResources 中，两者的信息可通过 $ kubectl api-versions 和 $ kubectl api-resources 查看；</li><li>namingController：检查 crd obj 中是否有命名冲突，可在 crd .status.conditions 中查看；</li><li>establishingController：检查 crd 是否处于正常状态，可在 crd .status.conditions 中查看；</li><li>nonStructuralSchemaController：检查 crd obj 结构是否正常，可在 crd .status.conditions 中查看；</li><li>apiApprovalController：检查 crd 是否遵循 kubernetes API 声明策略，可在 crd .status.conditions 中查看；</li><li>finalizingController：类似于 finalizes 的功能，与 CRs 的删除有关；</li></ol><p><code>createAPIExtensionsServer</code>调用<code>apiextensionsConfig.Complete().New(delegateAPIServer)</code></p><p><code>k8s.io/kubernetes/staging/src/k8s.io/apiextensions-apiserver/pkg/apiserver/apiserver.go:132</code></p><pre class="line-numbers language-golang"><code class="language-golang">/ New returns a new instance of CustomResourceDefinitions from the given config.func (c completedConfig) New(delegationTarget genericapiserver.DelegationTarget) (*CustomResourceDefinitions, error) {    // 初始化 genericServer    genericServer, err := c.GenericConfig.New("apiextensions-apiserver", delegationTarget)    if err != nil {        return nil, err    }    s := &CustomResourceDefinitions{        GenericAPIServer: genericServer,    }    // 初始化apigroup, 即需要暴露的api，这里extension apiserver只注册了cr于crd相关的    apiResourceConfig := c.GenericConfig.MergedResourceConfig    apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(apiextensions.GroupName, Scheme, metav1.ParameterCodec, Codecs)    if apiResourceConfig.VersionEnabled(v1beta1.SchemeGroupVersion) {        storage := map[string]rest.Storage{}        // customresourcedefinitions        customResourceDefintionStorage := customresourcedefinition.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)        storage["customresourcedefinitions"] = customResourceDefintionStorage        storage["customresourcedefinitions/status"] = customresourcedefinition.NewStatusREST(Scheme, customResourceDefintionStorage)        apiGroupInfo.VersionedResourcesStorageMap[v1beta1.SchemeGroupVersion.Version] = storage    }    if apiResourceConfig.VersionEnabled(v1.SchemeGroupVersion) {        storage := map[string]rest.Storage{}        // customresourcedefinitions        customResourceDefintionStorage := customresourcedefinition.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)        storage["customresourcedefinitions"] = customResourceDefintionStorage        storage["customresourcedefinitions/status"] = customresourcedefinition.NewStatusREST(Scheme, customResourceDefintionStorage)        apiGroupInfo.VersionedResourcesStorageMap[v1.SchemeGroupVersion.Version] = storage    }    // 注册apigroup    if err := s.GenericAPIServer.InstallAPIGroup(&apiGroupInfo); err != nil {        return nil, err    }    // clientset创建    crdClient, err := clientset.NewForConfig(s.GenericAPIServer.LoopbackClientConfig)    if err != nil {        // it's really bad that this is leaking here, but until we can fix the test (which I'm pretty sure isn't even testing what it wants to test),        // we need to be able to move forward        return nil, fmt.Errorf("failed to create clientset: %v", err)    }    s.Informers = externalinformers.NewSharedInformerFactory(crdClient, 5*time.Minute)    // 创建各种handler    delegateHandler := delegationTarget.UnprotectedHandler()    if delegateHandler == nil {        delegateHandler = http.NotFoundHandler()    }    versionDiscoveryHandler := &versionDiscoveryHandler{        discovery: map[schema.GroupVersion]*discovery.APIVersionHandler{},        delegate:  delegateHandler,    }    groupDiscoveryHandler := &groupDiscoveryHandler{        discovery: map[string]*discovery.APIGroupHandler{},        delegate:  delegateHandler,    }    establishingController := establish.NewEstablishingController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())    crdHandler, err := NewCustomResourceDefinitionHandler(        versionDiscoveryHandler,        groupDiscoveryHandler,        s.Informers.Apiextensions().V1().CustomResourceDefinitions(),        delegateHandler,        c.ExtraConfig.CRDRESTOptionsGetter,        c.GenericConfig.AdmissionControl,        establishingController,        c.ExtraConfig.ServiceResolver,        c.ExtraConfig.AuthResolverWrapper,        c.ExtraConfig.MasterCount,        s.GenericAPIServer.Authorizer,        c.GenericConfig.RequestTimeout,        time.Duration(c.GenericConfig.MinRequestTimeout)*time.Second,        apiGroupInfo.StaticOpenAPISpec,        c.GenericConfig.MaxRequestBodyBytes,    )    if err != nil {        return nil, err    }    s.GenericAPIServer.Handler.NonGoRestfulMux.Handle("/apis", crdHandler)    s.GenericAPIServer.Handler.NonGoRestfulMux.HandlePrefix("/apis/", crdHandler)    discoveryController := NewDiscoveryController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), versionDiscoveryHandler, groupDiscoveryHandler)    namingController := status.NewNamingConditionController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())    nonStructuralSchemaController := nonstructuralschema.NewConditionController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())    apiApprovalController := apiapproval.NewKubernetesAPIApprovalPolicyConformantConditionController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())    finalizingController := finalizer.NewCRDFinalizer(        s.Informers.Apiextensions().V1().CustomResourceDefinitions(),        crdClient.ApiextensionsV1(),        crdHandler,    )    openapiController := openapicontroller.NewController(s.Informers.Apiextensions().V1().CustomResourceDefinitions())    // 加入到启动hook中    s.GenericAPIServer.AddPostStartHookOrDie("start-apiextensions-informers", func(context genericapiserver.PostStartHookContext) error {        s.Informers.Start(context.StopCh)        return nil    })    s.GenericAPIServer.AddPostStartHookOrDie("start-apiextensions-controllers", func(context genericapiserver.PostStartHookContext) error {        // OpenAPIVersionedService and StaticOpenAPISpec are populated in generic apiserver PrepareRun().        // Together they serve the /openapi/v2 endpoint on a generic apiserver. A generic apiserver may        // choose to not enable OpenAPI by having null openAPIConfig, and thus OpenAPIVersionedService        // and StaticOpenAPISpec are both null. In that case we don't run the CRD OpenAPI controller.        if s.GenericAPIServer.OpenAPIVersionedService != nil && s.GenericAPIServer.StaticOpenAPISpec != nil {            go openapiController.Run(s.GenericAPIServer.StaticOpenAPISpec, s.GenericAPIServer.OpenAPIVersionedService, context.StopCh)        }        go namingController.Run(context.StopCh)        go establishingController.Run(context.StopCh)        go nonStructuralSchemaController.Run(5, context.StopCh)        go apiApprovalController.Run(5, context.StopCh)        go finalizingController.Run(5, context.StopCh)        discoverySyncedCh := make(chan struct{})        go discoveryController.Run(context.StopCh, discoverySyncedCh)        select {        case <-context.StopCh:        case <-discoverySyncedCh:        }        return nil    })    // we don't want to report healthy until we can handle all CRDs that have already been registered.  Waiting for the informer    // to sync makes sure that the lister will be valid before we begin.  There may still be races for CRDs added after startup,    // but we won't go healthy until we can handle the ones already present.    s.GenericAPIServer.AddPostStartHookOrDie("crd-informer-synced", func(context genericapiserver.PostStartHookContext) error {        return wait.PollImmediateUntil(100*time.Millisecond, func() (bool, error) {            return s.Informers.Apiextensions().V1().CustomResourceDefinitions().Informer().HasSynced(), nil        }, context.StopCh)    })    return s, nil}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>c.GenericConfig.New</code>来初始化<code>genericapiserver</code>,包裹一些默认链，创建handler</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> delegationTarget DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>GenericAPIServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Serializer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Genericapiserver.New() called with config.Serializer == nil"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>LoopbackClientConfig <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Genericapiserver.New() called with config.LoopbackClientConfig == nil"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> c<span class="token punctuation">.</span>EquivalentResourceRegistry <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Genericapiserver.New() called with config.EquivalentResourceRegistry == nil"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 包裹了DefaultBuildHandlerChain</span>    handlerChainBuilder <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>        <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">BuildHandlerChainFunc</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 创建apiserverhandler</span>    apiServerHandler <span class="token operator">:=</span> <span class="token function">NewAPIServerHandler</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> handlerChainBuilder<span class="token punctuation">,</span> delegationTarget<span class="token punctuation">.</span><span class="token function">UnprotectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token operator">...</span>    <span class="token keyword">return</span> s<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>APIServerHandler</code>包含多种<code>http.Handler</code>类型，包括<code>go-restful</code>以及<code>non-go-restful</code>，以及在以上两者之间选择的<code>Director</code>对象，<code>go-restful</code>用于处理已经注册的handler，<code>non-go-restful用来处理不存在的handler，API URI处理的选择过程为：</code>FullHandlerChain-&gt; Director -&gt;{GoRestfulContainer， NonGoRestfulMux}<code>。</code>NewAPIServerHandler`</p><pre><code>func NewAPIServerHandler(name string, s runtime.NegotiatedSerializer, handlerChainBuilder HandlerChainBuilderFn, notFoundHandler http.Handler) *APIServerHandler {    // non-go-restful路由    nonGoRestfulMux := mux.NewPathRecorderMux(name)    if notFoundHandler != nil {        nonGoRestfulMux.NotFoundHandler(notFoundHandler)    }    // go-resetful路由    gorestfulContainer := restful.NewContainer()    gorestfulContainer.ServeMux = http.NewServeMux()    gorestfulContainer.Router(restful.CurlyRouter{}) // e.g. for proxy/{kind}/{name}/{*}    gorestfulContainer.RecoverHandler(func(panicReason interface{}, httpWriter http.ResponseWriter) {        logStackOnRecover(s, panicReason, httpWriter)    })    gorestfulContainer.ServiceErrorHandler(func(serviceErr restful.ServiceError, request *restful.Request, response *restful.Response) {        serviceErrorHandler(s, serviceErr, request, response)    })    // 选择器, 根据path选择是否执行go-restful，注册过的path执行go-restful    director := director{        name:               name,        goRestfulContainer: gorestfulContainer,        nonGoRestfulMux:    nonGoRestfulMux,    }    return &amp;APIServerHandler{        FullHandlerChain:   handlerChainBuilder(director),        GoRestfulContainer: gorestfulContainer,        NonGoRestfulMux:    nonGoRestfulMux,        Director:           director,    }}</code></pre><p>以上是<code>APIExtensionsServer</code>的初始化流程，初始化Server, 调用<code>s.GenericAPIServer.InstallAPIGroup</code>注册api。此方法的调用链非常深，主要是为了将需要暴露的<code>API Resource</code>注册到 server 中，以便能通过 http 接口进行 resource 的 REST 操作，其他几种 server 在初始化时也都会执行对应的 <code>InstallAPI</code>方法。</p><h3 id="KubeAPIServer初始化"><a href="#KubeAPIServer初始化" class="headerlink" title="KubeAPIServer初始化"></a>KubeAPIServer初始化</h3><p>KubeAPIServer 主要是提供对 API Resource 的操作请求，为 kubernetes 中众多 API 注册路由信息，暴露 RESTful API 并且对外提供 kubernetes service，使集群中以及集群外的服务都可以通过 RESTful API 操作 kubernetes 中的资源。</p><p>与<code>APIExtensionsServer</code>，<code>KubeAPIServer</code>初始化流程如下</p><ol><li><code>CreateKubeAPIServer</code>调用<code>kubeAPIServerConfig.Complete().New</code>来初始化</li><li><code>New</code>函数创建默认的<code>apigroup</code>(pod,deployment等内部资源), 调用<code>InstallAPIs</code>注册</li><li>启动相关controller, 加入到<code>poststarthook</code></li></ol><h3 id="AggregatorServer初始化"><a href="#AggregatorServer初始化" class="headerlink" title="AggregatorServer初始化"></a>AggregatorServer初始化</h3><p><code>Aggregator</code>通过<code>APIServices</code>对象关联到某个<code>Service</code>来进行请求的转发，其关联的<code>Service</code>类型进一步决定了请求转发形式。<code>Aggregator</code>包括一个<code>GenericAPIServer</code>和维护自身状态的<code>Controller</code>。其中 <code>GenericAPIServer</code>主要处理<code>apiregistration.k8s.io</code>组下的<code>APIService</code>资源请求。</p><p><code>Aggregator</code>除了处理资源请求外还包含几个controller：</p><ol><li>apiserviceRegistrationController：负责<code>APIServices</code>中资源的注册与删除；</li><li>availableConditionController：维护<code>APIServices</code>的可用状态，包括其引用<code>Service</code>是否可用等；</li><li>autoRegistrationController：用于保持API中存在的一组特定的<code>APIServices</code>；</li><li>crdRegistrationController：负责将<code>CRD GroupVersions</code>自动注册到<code>APIServices</code>中；</li><li>openAPIAggregationController：将<code>APIServices</code>资源的变化同步至提供的<code>OpenAPI</code>文档；<br>kubernetes中的一些附加组件，比如metrics-server就是通过Aggregator的方式进行扩展的，实际环境中可以通过使用apiserver-builder工具轻松以Aggregator的扩展方式创建自定义资源。</li></ol><p>初始化AggregatorServer的主要逻辑为：</p><ol><li>调用<code>aggregatorConfig.Complete().NewWithDelegate</code>创建<code>aggregatorServer</code></li><li>初始化<code>crdRegistrationController</code>和<code>autoRegistrationController</code>，<code>crdRegistrationController</code>负责注册CRD，<code>autoRegistrationController</code>负责将 CRD 对应的 APIServices自动注册到apiserver中，CRD 创建后可通过<code>$ kubectl get apiservices</code>查看是否注册到 apiservices中</li><li>将<code>autoRegistrationController</code>和<code>crdRegistrationController</code>加入到PostStartHook中</li></ol><p>首先，初始化配置<code>createAggregatorConfig</code></p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">createAggregatorConfig</span><span class="token punctuation">(</span>    kubeAPIServerConfig genericapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">,</span>    commandOptions <span class="token operator">*</span>options<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span>    externalInformers kubeexternalinformers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">,</span>    serviceResolver aggregatorapiserver<span class="token punctuation">.</span>ServiceResolver<span class="token punctuation">,</span>    proxyTransport <span class="token operator">*</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">,</span>    pluginInitializers <span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>aggregatorapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// make a shallow copy to let us twiddle a few things</span>    <span class="token comment" spellcheck="true">// most of the config actually remains the same.  We only need to mess with a couple items related to the particulars of the aggregator</span>    genericConfig <span class="token operator">:=</span> kubeAPIServerConfig    genericConfig<span class="token punctuation">.</span>PostStartHooks <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>genericapiserver<span class="token punctuation">.</span>PostStartHookConfigEntry<span class="token punctuation">{</span><span class="token punctuation">}</span>    genericConfig<span class="token punctuation">.</span>RESTOptionsGetter <span class="token operator">=</span> <span class="token boolean">nil</span>    <span class="token comment" spellcheck="true">// override genericConfig.AdmissionControl with kube-aggregator's scheme,</span>    <span class="token comment" spellcheck="true">// because aggregator apiserver should use its own scheme to convert its own resources.</span>    <span class="token comment" spellcheck="true">// 取消admission的配置，aggregator自行处理请求，不需要admissions</span>    err <span class="token operator">:=</span> commandOptions<span class="token punctuation">.</span>Admission<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>        <span class="token operator">&amp;</span>genericConfig<span class="token punctuation">,</span>        externalInformers<span class="token punctuation">,</span>        genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>        feature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">,</span>        pluginInitializers<span class="token operator">...</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// copy the etcd options so we don't mutate originals.</span>    etcdOptions <span class="token operator">:=</span> <span class="token operator">*</span>commandOptions<span class="token punctuation">.</span>Etcd    etcdOptions<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Paging <span class="token operator">=</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>APIListChunking<span class="token punctuation">)</span>    etcdOptions<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Codec <span class="token operator">=</span> aggregatorscheme<span class="token punctuation">.</span>Codecs<span class="token punctuation">.</span><span class="token function">LegacyCodec</span><span class="token punctuation">(</span>v1beta1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span>    etcdOptions<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>EncodeVersioner <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewMultiGroupVersioner</span><span class="token punctuation">(</span>v1beta1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">,</span> schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> v1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">}</span><span class="token punctuation">)</span>    genericConfig<span class="token punctuation">.</span>RESTOptionsGetter <span class="token operator">=</span> <span class="token operator">&amp;</span>genericoptions<span class="token punctuation">.</span>SimpleRestOptionsFactory<span class="token punctuation">{</span>Options<span class="token punctuation">:</span> etcdOptions<span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// override MergedResourceConfig with aggregator defaults and registry</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> commandOptions<span class="token punctuation">.</span>APIEnablement<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>        <span class="token operator">&amp;</span>genericConfig<span class="token punctuation">,</span>        aggregatorapiserver<span class="token punctuation">.</span><span class="token function">DefaultAPIResourceConfigSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        aggregatorscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 配置proxy证书，用于apiserver与扩展服务的通信，使用requestheader证书签发</span>    <span class="token keyword">var</span> certBytes<span class="token punctuation">,</span> keyBytes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>commandOptions<span class="token punctuation">.</span>ProxyClientCertFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>commandOptions<span class="token punctuation">.</span>ProxyClientKeyFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        certBytes<span class="token punctuation">,</span> err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>commandOptions<span class="token punctuation">.</span>ProxyClientCertFile<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>        keyBytes<span class="token punctuation">,</span> err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>commandOptions<span class="token punctuation">.</span>ProxyClientKeyFile<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    aggregatorConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>aggregatorapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>        GenericConfig<span class="token punctuation">:</span> <span class="token operator">&amp;</span>genericapiserver<span class="token punctuation">.</span>RecommendedConfig<span class="token punctuation">{</span>            Config<span class="token punctuation">:</span>                genericConfig<span class="token punctuation">,</span>            SharedInformerFactory<span class="token punctuation">:</span> externalInformers<span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>        ExtraConfig<span class="token punctuation">:</span> aggregatorapiserver<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">{</span>            ProxyClientCert<span class="token punctuation">:</span> certBytes<span class="token punctuation">,</span>            ProxyClientKey<span class="token punctuation">:</span>  keyBytes<span class="token punctuation">,</span>            ServiceResolver<span class="token punctuation">:</span> serviceResolver<span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// 代理请求的具体实现</span>            ProxyTransport<span class="token punctuation">:</span>  proxyTransport<span class="token punctuation">,</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// we need to clear the poststarthooks so we don't add them multiple times to all the servers (that fails)</span>    <span class="token comment" spellcheck="true">// 加入PostStartHook</span>    aggregatorConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>PostStartHooks <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>genericapiserver<span class="token punctuation">.</span>PostStartHookConfigEntry<span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">return</span> aggregatorConfig<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>createAggregatorServer</code>初始化<code>Aggregator</code></p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">createAggregatorServer</span><span class="token punctuation">(</span>aggregatorConfig <span class="token operator">*</span>aggregatorapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> delegateAPIServer genericapiserver<span class="token punctuation">.</span>DelegationTarget<span class="token punctuation">,</span> apiExtensionInformers apiextensionsinformers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>aggregatorapiserver<span class="token punctuation">.</span>APIAggregator<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 初始化配置，与前面流程相同</span>    aggregatorServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> aggregatorConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NewWithDelegate</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 创建auto-registration controller</span>    apiRegistrationClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> apiregistrationclient<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>aggregatorConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    autoRegistrationController <span class="token operator">:=</span> autoregister<span class="token punctuation">.</span><span class="token function">NewAutoRegisterController</span><span class="token punctuation">(</span>aggregatorServer<span class="token punctuation">.</span>APIRegistrationInformers<span class="token punctuation">.</span><span class="token function">Apiregistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">APIServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> apiRegistrationClient<span class="token punctuation">)</span>    apiServices <span class="token operator">:=</span> <span class="token function">apiServicesToRegister</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">,</span> autoRegistrationController<span class="token punctuation">)</span>    crdRegistrationController <span class="token operator">:=</span> crdregistration<span class="token punctuation">.</span><span class="token function">NewCRDRegistrationController</span><span class="token punctuation">(</span>        apiExtensionInformers<span class="token punctuation">.</span><span class="token function">Apiextensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CustomResourceDefinitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        autoRegistrationController<span class="token punctuation">)</span>    err <span class="token operator">=</span> aggregatorServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPostStartHook</span><span class="token punctuation">(</span><span class="token string">"kube-apiserver-autoregistration"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context genericapiserver<span class="token punctuation">.</span>PostStartHookContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 启动controller</span>        <span class="token keyword">go</span> crdRegistrationController<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// let the CRD controller process the initial set of CRDs before starting the autoregistration controller.</span>            <span class="token comment" spellcheck="true">// this prevents the autoregistration controller's initial sync from deleting APIServices for CRDs that still exist.</span>            <span class="token comment" spellcheck="true">// we only need to do this if CRDs are enabled on this server.  We can't use discovery because we are the source for discovery.</span>            <span class="token keyword">if</span> aggregatorConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>MergedResourceConfig<span class="token punctuation">.</span><span class="token function">AnyVersionForGroupEnabled</span><span class="token punctuation">(</span><span class="token string">"apiextensions.k8s.io"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                crdRegistrationController<span class="token punctuation">.</span><span class="token function">WaitForInitialSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>            autoRegistrationController<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    err <span class="token operator">=</span> aggregatorServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddBootSequenceHealthChecks</span><span class="token punctuation">(</span>        <span class="token function">makeAPIServiceAvailableHealthCheck</span><span class="token punctuation">(</span>            <span class="token string">"autoregister-completion"</span><span class="token punctuation">,</span>            apiServices<span class="token punctuation">,</span>            aggregatorServer<span class="token punctuation">.</span>APIRegistrationInformers<span class="token punctuation">.</span><span class="token function">Apiregistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">APIServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">return</span> aggregatorServer<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>至此，启动步骤以前分析完了，三个组件的流量大体时一样的，通过<code>Complete().New()</code>初始化配置，创建所需的controller, 调用<code>InstallAPIGroup</code>注册<code>apigroup</code>。</p><h2 id="请求分析"><a href="#请求分析" class="headerlink" title="请求分析"></a>请求分析</h2><p>上面我们分析了apiserver的调用链，大体如下<br><code>DefaultHandlerChain-&gt;{handler/crdhandler/proxy}-&gt;admission-&gt;validation-&gt;etcd</code></p><ol><li>请求进入时，会经过<code>defaultchain</code>做一些认证鉴权工作</li><li>然后通过<code>route</code>执行对应的handler，如果为aggration api, 将直接转发请求到对应service</li><li>handler处理完，经过admission与validation，做一些修改和检查，用户在这部分可以自定义webhook</li><li>最后存入etcd</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文大体对apiserver的启动流程，以及初始化过程做了分析，由于apiserver实现复杂，中间一些细节没涉及到，还需要对着代码研究研究。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://juejin.im/post/5c934e5a5188252d7c216981" target="_blank" rel="noopener">https://juejin.im/post/5c934e5a5188252d7c216981</a><br>[2] <a href="https://blog.tianfeiyu.com/2020/02/24/kube_apiserver/" target="_blank" rel="noopener">https://blog.tianfeiyu.com/2020/02/24/kube_apiserver/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;kube-apiserver 共由 3 个组件构成（Aggregator. KubeAPIServer. APIExtensionServer），这些组件依次通过 Delegation 处理请求：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Aggregator：暴露的功能类似于一个七层负载
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="apiserver" scheme="https://qinng.now.sh/tags/apiserver/"/>
    
  </entry>
  
  <entry>
    <title>kube-apiserver鉴权源码分析</title>
    <link href="https://qinng.now.sh/kube-apiserver-authorization-code/"/>
    <id>https://qinng.now.sh/kube-apiserver-authorization-code/</id>
    <published>2020-04-23T08:54:14.000Z</published>
    <updated>2020-04-25T07:01:42.755Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>kube-apiserver中与权限相关的主要有三种机制，即认证、鉴权和准入控制。上节讲到<a href="./kube-apiserver-authentication-code.md">认证流程</a>。</p><p>认证与授权很容易混淆：</p><ul><li>认证(Authentication), 负责检查你是谁，识别user</li><li>授权(Authorization), 你能做什么，是否允许User对资源的操作</li><li>审计(Audit), 负责记录操作信息，方便后续审查</li></ul><p>本文主要分析apiserver的rbac授权流程。</p><h2 id="认证流程分析"><a href="#认证流程分析" class="headerlink" title="认证流程分析"></a>认证流程分析</h2><p>权限相关代码从<code>k8s.io/apiserver/pkg/server/config.go</code>中<code>DefaultBuildHandlerChain</code>函数开始执行</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">DefaultBuildHandlerChain</span><span class="token punctuation">(</span>apiHandler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> c <span class="token operator">*</span>Config<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>    handler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthorization</span><span class="token punctuation">(</span>apiHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithMaxInFlightLimit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>MaxMutatingRequestsInFlight<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithImpersonation</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAudit</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">)</span>    failedHandler <span class="token operator">:=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">Unauthorized</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>SupportsBasicAuth<span class="token punctuation">)</span>    failedHandler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithFailedAuthenticationAudit</span><span class="token punctuation">(</span>failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditBackend<span class="token punctuation">,</span> c<span class="token punctuation">.</span>AuditPolicyChecker<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithAuthentication</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> failedHandler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>APIAudiences<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithCORS</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>CorsAllowedOriginList<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithTimeoutForNonLongRunningRequests</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestTimeout<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithWaitGroup</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>LongRunningFunc<span class="token punctuation">,</span> c<span class="token punctuation">.</span>HandlerChainWaitGroup<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericapifilters<span class="token punctuation">.</span><span class="token function">WithRequestInfo</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestInfoResolver<span class="token punctuation">)</span>    handler <span class="token operator">=</span> genericfilters<span class="token punctuation">.</span><span class="token function">WithPanicRecovery</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span>    <span class="token keyword">return</span> handler<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>DefaultBuildHandlerChain</code>中包含了多种filter（如认证，链接数检验，RBAC权限检验等），授权步骤在<code>WithAuthorization</code>中，如下：</p><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// WithAuthorizationCheck passes all authorized requests on to handler, and returns a forbidden error otherwise.</span><span class="token keyword">func</span> <span class="token function">WithAuthorization</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">,</span> a authorizer<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> s runtime<span class="token punctuation">.</span>NegotiatedSerializer<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 检查是否需要权限校验</span>    <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"Authorization is disabled"</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> handler    <span class="token punctuation">}</span>    <span class="token keyword">return</span> http<span class="token punctuation">.</span><span class="token function">HandlerFunc</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ctx <span class="token operator">:=</span> req<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 用作审计</span>        ae <span class="token operator">:=</span> request<span class="token punctuation">.</span><span class="token function">AuditEventFrom</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// 获取Attribute, 通过reqeust获取到请求的user, resource, verb, 是否为namespace级别的等</span>        attributes<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">GetAuthorizerAttributes</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            responsewriters<span class="token punctuation">.</span><span class="token function">InternalError</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 执行认证流程</span>        authorized<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> err <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token function">Authorize</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true">// an authorizer like RBAC could encounter evaluation errors and still allow the request, so authorizer decision is checked before error here.</span>        <span class="token keyword">if</span> authorized <span class="token operator">==</span> authorizer<span class="token punctuation">.</span>DecisionAllow <span class="token punctuation">{</span>            audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> decisionAnnotationKey<span class="token punctuation">,</span> decisionAllow<span class="token punctuation">)</span>            audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> reasonAnnotationKey<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">// 校验成功，记录信息，转到下一个handler</span>            handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> reasonAnnotationKey<span class="token punctuation">,</span> reasonError<span class="token punctuation">)</span>            responsewriters<span class="token punctuation">.</span><span class="token function">InternalError</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> err<span class="token punctuation">)</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 校验失败返回403，注意认证失败返回的是401</span>        klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Forbidden: %#v, Reason: %q"</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>RequestURI<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>        audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> decisionAnnotationKey<span class="token punctuation">,</span> decisionForbid<span class="token punctuation">)</span>        audit<span class="token punctuation">.</span><span class="token function">LogAnnotation</span><span class="token punctuation">(</span>ae<span class="token punctuation">,</span> reasonAnnotationKey<span class="token punctuation">,</span> reason<span class="token punctuation">)</span>        responsewriters<span class="token punctuation">.</span><span class="token function">Forbidden</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> attributes<span class="token punctuation">,</span> w<span class="token punctuation">,</span> req<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> s<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>授权流程比较清晰，从request获取请求信息，进行鉴权，成功进入后续handler，失败返回403。</p><p><code>Authorize</code>接口有多种实现，通过在apiserver配置<code>--authorization-mode</code>选择鉴权模式，包括：</p><ul><li>ABAC</li><li>RBAC</li><li>Node, 用于kubelet鉴权exec/logs等</li><li>AlwaysAllow</li><li>AlwaysDeny</li><li>Webhook， 用于扩展权限，用户可实现Webhook与其他权限系统集成</li></ul><p>如果选择<code>AlwaysAllow</code>,即不做鉴权, 开启后强制不允许匿名用户</p><pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// ApplyAuthorization will conditionally modify the authentication options based on the authorization options</span><span class="token keyword">func</span> <span class="token punctuation">(</span>o <span class="token operator">*</span>BuiltInAuthenticationOptions<span class="token punctuation">)</span> <span class="token function">ApplyAuthorization</span><span class="token punctuation">(</span>authorization <span class="token operator">*</span>BuiltInAuthorizationOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> o <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> authorization <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> o<span class="token punctuation">.</span>Anonymous <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// authorization ModeAlwaysAllow cannot be combined with AnonymousAuth.</span>    <span class="token comment" spellcheck="true">// in such a case the AnonymousAuth is stomped to false and you get a message</span>    <span class="token keyword">if</span> o<span class="token punctuation">.</span>Anonymous<span class="token punctuation">.</span>Allow <span class="token operator">&amp;&amp;</span> sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span>authorization<span class="token punctuation">.</span>Modes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>authzmodes<span class="token punctuation">.</span>ModeAlwaysAllow<span class="token punctuation">)</span> <span class="token punctuation">{</span>        klog<span class="token punctuation">.</span><span class="token function">Warningf</span><span class="token punctuation">(</span><span class="token string">"AnonymousAuth is not allowed with the AlwaysAllow authorizer. Resetting AnonymousAuth to false. You should use a different authorizer"</span><span class="token punctuation">)</span>        o<span class="token punctuation">.</span>Anonymous<span class="token punctuation">.</span>Allow <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="rbac鉴权"><a href="#rbac鉴权" class="headerlink" title="rbac鉴权"></a>rbac鉴权</h2><p>rbac是常用的鉴权方式，实现<code>Authorize</code>接口, 代码在<a href="https://github.com/kubernetes/kubernetes/blob/92eb072989eba22236d034b56cc2bf159dfb4915/plugin/pkg/auth/authorizer/rbac/rbac.go#L75" target="_blank" rel="noopener">rbac.go</a></p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>RBACAuthorizer<span class="token punctuation">)</span> <span class="token function">Authorize</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> requestAttributes authorizer<span class="token punctuation">.</span>Attributes<span class="token punctuation">)</span> <span class="token punctuation">(</span>authorizer<span class="token punctuation">.</span>Decision<span class="token punctuation">,</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ruleCheckingVisitor <span class="token operator">:=</span> <span class="token operator">&amp;</span>authorizingVisitor<span class="token punctuation">{</span>requestAttributes<span class="token punctuation">:</span> requestAttributes<span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 调用VisitRulesFor来检查是否用权限</span>    r<span class="token punctuation">.</span>authorizationRuleResolver<span class="token punctuation">.</span><span class="token function">VisitRulesFor</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ruleCheckingVisitor<span class="token punctuation">.</span>visit<span class="token punctuation">)</span>    <span class="token keyword">if</span> ruleCheckingVisitor<span class="token punctuation">.</span>allowed <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 成功直接返回</span>        <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionAllow<span class="token punctuation">,</span> ruleCheckingVisitor<span class="token punctuation">.</span>reason<span class="token punctuation">,</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 失败，打印日志返回失败原因</span>    <span class="token comment" spellcheck="true">// Build a detailed log of the denial.</span>    <span class="token comment" spellcheck="true">// Make the whole block conditional so we don't do a lot of string-building we won't use.</span>    <span class="token keyword">if</span> klog<span class="token punctuation">.</span><span class="token function">V</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> operation <span class="token builtin">string</span>        <span class="token keyword">if</span> requestAttributes<span class="token punctuation">.</span><span class="token function">IsResourceRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            b <span class="token operator">:=</span> <span class="token operator">&amp;</span>bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">{</span><span class="token punctuation">}</span>            b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">`"`</span><span class="token punctuation">)</span>            b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetVerb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">`" resource "`</span><span class="token punctuation">)</span>            b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetAPIGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>                b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">`.`</span><span class="token punctuation">)</span>                b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetAPIGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetSubresource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>                b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">`/`</span><span class="token punctuation">)</span>                b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetSubresource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>            b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">`"`</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>                b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">` named "`</span><span class="token punctuation">)</span>                b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>requestAttributes<span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                b<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span><span class="token string">`"`</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>            operation <span class="token operator">=</span> b<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            operation <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%q nonResourceURL %q"</span><span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetVerb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">var</span> scope <span class="token builtin">string</span>        <span class="token keyword">if</span> ns <span class="token operator">:=</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetNamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">len</span><span class="token punctuation">(</span>ns<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>            scope <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"in namespace %q"</span><span class="token punctuation">,</span> ns<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            scope <span class="token operator">=</span> <span class="token string">"cluster-wide"</span>        <span class="token punctuation">}</span>        klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"RBAC DENY: user %q groups %q cannot %s %s"</span><span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestAttributes<span class="token punctuation">.</span><span class="token function">GetUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetGroups</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> operation<span class="token punctuation">,</span> scope<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    reason <span class="token operator">:=</span> <span class="token string">""</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>ruleCheckingVisitor<span class="token punctuation">.</span>errors<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RBAC: %v"</span><span class="token punctuation">,</span> utilerrors<span class="token punctuation">.</span><span class="token function">NewAggregate</span><span class="token punctuation">(</span>ruleCheckingVisitor<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> authorizer<span class="token punctuation">.</span>DecisionNoOpinion<span class="token punctuation">,</span> reason<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Authorize</code>调用了<code>VisitRulesFor</code>来处理具体鉴权操作, 代码在<a href="https://github.com/kubernetes/kubernetes/blob/81e9f21f832f88422f1ccf5b8aa90de7cf822132/pkg/registry/rbac/validation/rule.go#L178" target="_blank" rel="noopener">rule.go</a></p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>DefaultRuleResolver<span class="token punctuation">)</span> <span class="token function">VisitRulesFor</span><span class="token punctuation">(</span>user user<span class="token punctuation">.</span>Info<span class="token punctuation">,</span> namespace <span class="token builtin">string</span><span class="token punctuation">,</span> visitor <span class="token keyword">func</span><span class="token punctuation">(</span>source fmt<span class="token punctuation">.</span>Stringer<span class="token punctuation">,</span> rule <span class="token operator">*</span>rbacv1<span class="token punctuation">.</span>PolicyRule<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 获取所有clusterrolebinding</span>    <span class="token keyword">if</span> clusterRoleBindings<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>clusterRoleBindingLister<span class="token punctuation">.</span><span class="token function">ListClusterRoleBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">visitor</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        sourceDescriber <span class="token operator">:=</span> <span class="token operator">&amp;</span>clusterRoleBindingDescriber<span class="token punctuation">{</span><span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 遍历clusterrolebing</span>        <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> clusterRoleBinding <span class="token operator">:=</span> <span class="token keyword">range</span> clusterRoleBindings <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 检查是否有对应的user</span>            subjectIndex<span class="token punctuation">,</span> applies <span class="token operator">:=</span> <span class="token function">appliesTo</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> clusterRoleBinding<span class="token punctuation">.</span>Subjects<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token operator">!</span>applies <span class="token punctuation">{</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 如果user存在于subject, 获取对应的rules即clusterrole</span>            rules<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">GetRoleReferenceRules</span><span class="token punctuation">(</span>clusterRoleBinding<span class="token punctuation">.</span>RoleRef<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">visitor</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span>                <span class="token punctuation">}</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            sourceDescriber<span class="token punctuation">.</span>binding <span class="token operator">=</span> clusterRoleBinding            sourceDescriber<span class="token punctuation">.</span>subject <span class="token operator">=</span> <span class="token operator">&amp;</span>clusterRoleBinding<span class="token punctuation">.</span>Subjects<span class="token punctuation">[</span>subjectIndex<span class="token punctuation">]</span>            <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> rules <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 调用visitor判断是否需要进入下一步鉴权</span>                <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">visitor</span><span class="token punctuation">(</span>sourceDescriber<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// clusterrole遍历完还没有鉴权成功，接着遍历所在namespace的role，流程同上</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> roleBindings<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span>roleBindingLister<span class="token punctuation">.</span><span class="token function">ListRoleBindings</span><span class="token punctuation">(</span>namespace<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">visitor</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            sourceDescriber <span class="token operator">:=</span> <span class="token operator">&amp;</span>roleBindingDescriber<span class="token punctuation">{</span><span class="token punctuation">}</span>            <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> roleBinding <span class="token operator">:=</span> <span class="token keyword">range</span> roleBindings <span class="token punctuation">{</span>                subjectIndex<span class="token punctuation">,</span> applies <span class="token operator">:=</span> <span class="token function">appliesTo</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> roleBinding<span class="token punctuation">.</span>Subjects<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token operator">!</span>applies <span class="token punctuation">{</span>                    <span class="token keyword">continue</span>                <span class="token punctuation">}</span>                rules<span class="token punctuation">,</span> err <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">GetRoleReferenceRules</span><span class="token punctuation">(</span>roleBinding<span class="token punctuation">.</span>RoleRef<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>                <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">visitor</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">return</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">continue</span>                <span class="token punctuation">}</span>                sourceDescriber<span class="token punctuation">.</span>binding <span class="token operator">=</span> roleBinding                sourceDescriber<span class="token punctuation">.</span>subject <span class="token operator">=</span> <span class="token operator">&amp;</span>roleBinding<span class="token punctuation">.</span>Subjects<span class="token punctuation">[</span>subjectIndex<span class="token punctuation">]</span>                <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> rules <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">visitor</span><span class="token punctuation">(</span>sourceDescriber<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rules<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">return</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>visit</code>函数, 用来判断是否认证成功，成功返回<code>false</code>, 不需要进行下一步鉴权</p><pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>authorizingVisitor<span class="token punctuation">)</span> <span class="token function">visit</span><span class="token punctuation">(</span>source fmt<span class="token punctuation">.</span>Stringer<span class="token punctuation">,</span> rule <span class="token operator">*</span>rbacv1<span class="token punctuation">.</span>PolicyRule<span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> rule <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token function">RuleAllows</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>requestAttributes<span class="token punctuation">,</span> rule<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// allowed用来表示是否认证成功</span>        v<span class="token punctuation">.</span>allowed <span class="token operator">=</span> <span class="token boolean">true</span>        v<span class="token punctuation">.</span>reason <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"RBAC: allowed by %s"</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        v<span class="token punctuation">.</span>errors <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>errors<span class="token punctuation">,</span> err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>rbac的鉴权流程如下:</p><ol><li>通过<code>Request</code>获取<code>Attribute</code>包括用户，资源和对应的操作</li><li><code>Authorize</code>调用<code>VisitRulesFor</code>进行具体的鉴权</li><li>获取所有的ClusterRoleBindings，并对其进行遍历操作</li><li>根据请求User信息，判断该是否被绑定在该ClusterRoleBinding中</li><li>若在将通过函数<code>GetRoleReferenceRules()</code>获取绑定的Role所控制的访问的资源</li><li>将Role所控制的访问的资源，与从API请求中提取出的资源进行比对，若比对成功，即为API请求的调用者有权访问相关资源</li><li>遍历ClusterRoleBinding中，都没有获得鉴权成功的操作，将会判断提取出的信息中是否包括了namespace的信息，若包括了，将会获取该namespace下的所有RoleBindings，类似ClusterRoleBindings</li><li>若在遍历了所有CluterRoleBindings，及该namespace下的所有RoleBingdings之后，仍没有对资源比对成功，则可判断该API请求的调用者没有权限访问相关资源, 鉴权失败</li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文结合RBAC分析了Kubernetes的鉴权流程，整体这部分比较代码清晰。RBAC是Kubernetes比较推荐的鉴权方式，了解完整个流程后，居然所有请求都会先遍历一遍ClusterRoleBindings，这样实现起来比较简单，但随着规模和用户的扩大，这部分是否会有性能问题，需不需要实现能够快速鉴权的方式。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;kube-apiserver中与权限相关的主要有三种机制，即认证、鉴权和准入控制。上节讲到&lt;a href=&quot;./kube-apiserver
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="rbac" scheme="https://qinng.now.sh/tags/rbac/"/>
    
  </entry>
  
  <entry>
    <title>多端口服务的Ingress IP-hash问题</title>
    <link href="https://qinng.now.sh/ingress-ip-hash/"/>
    <id>https://qinng.now.sh/ingress-ip-hash/</id>
    <published>2020-04-15T07:47:09.000Z</published>
    <updated>2020-04-25T03:24:29.432Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>业务反馈使用Ingress的ip-hash, 同一个服务开启了http和websocket分别是两个端口, 但是配置ip-hash后, 同一个client的请求http和websocket不在同一个后端.</p><h2 id="探究"><a href="#探究" class="headerlink" title="探究"></a>探究</h2><p>根据业务Ingress配置,配置如下实例:</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/cors-allow-origin</span><span class="token punctuation">:</span> <span class="token string">'*'</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/enable-cors</span><span class="token punctuation">:</span> <span class="token string">"true"</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-body-size</span><span class="token punctuation">:</span> 200m    <span class="token key atrule">nginx.ingress.kubernetes.io/proxy-read-timeout</span><span class="token punctuation">:</span> <span class="token string">"300"</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/upstream-hash-by</span><span class="token punctuation">:</span> $binary_remote_addr  <span class="token key atrule">name</span><span class="token punctuation">:</span> hellogo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> hellogo.d.xiaomi.net    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> hellogo <span class="token comment" spellcheck="true">#http1, 8080</span>          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /8080      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> hellogo <span class="token comment" spellcheck="true">#http2, 9090</span>          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">9090</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /9090      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> hellogo <span class="token comment" spellcheck="true">#websocket, 8081</span>          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8081</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /ws<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建多个副本</p><pre class="line-numbers language-bash"><code class="language-bash">$ kubectl get po -l app<span class="token operator">=</span>hellogoNAME                       READY   STATUS    RESTARTS   AGEhellogo-699f997454-b5vs4   1/1     Running   0          66mhellogo-699f997454-hm924   1/1     Running   0          66mhellogo-699f997454-mfbqv   1/1     Running   0          66mhellogo-699f997454-qdrwn   1/1     Running   0          66mhellogo-699f997454-srh9b   1/1     Running   0          66mhellogo-699f997454-wlwfh   1/1     Running   0          66m<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试http 8080端口, 请求到pod hellogo-699f997454-qdrwn</p><pre class="line-numbers language-bash"><code class="language-bash">$ curl http://hellogo.d.xiaomi.net/8080hello 8080<span class="token operator">!</span>host hellogo.d.xiaomi.netremoteaddr 10.46.23.1:15340realip 10.232.41.102<span class="token function">hostname</span> hellogo-699f997454-qdrwn $ curl http://hellogo.d.xiaomi.net/8080hello 8080<span class="token operator">!</span>host hellogo.d.xiaomi.netremoteaddr 10.46.23.1:15866realip 10.232.41.102<span class="token function">hostname</span> hellogo-699f997454-qdrwn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>测试http 8080端口, 请求到pod hellogo-699f997454-b5vs4</p><pre class="line-numbers language-bash"><code class="language-bash">$ curl http://hellogo.d.xiaomi.net/9090hello 9090<span class="token operator">!</span>host hellogo.d.xiaomi.netremoteaddr 10.38.200.195:23706realip 10.232.41.102<span class="token function">hostname</span> hellogo-699f997454-b5vs4$ curl http://hellogo.d.xiaomi.net/9090hello 9090<span class="token operator">!</span>host hellogo.d.xiaomi.netremoteaddr 10.38.200.195:23706realip 10.232.41.102<span class="token function">hostname</span> hellogo-699f997454-b5vs4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>猜想是由于获取的nginx server列表顺序不一致导致的, 但是看源码ip list是直接从endpoint获取的, 进入nginx-ingress查看</p><pre class="line-numbers language-bash"><code class="language-bash">$ kubectl <span class="token function">exec</span> -it -n kube-system nginx-ingress-controller-m496n sh<span class="token comment" spellcheck="true"># dbg工具查看nginx后端列表</span>/etc/nginx $ /dbg backends list <span class="token operator">|</span> <span class="token function">grep</span> hellogodefault-hellogo-8080default-hellogo-8081default-hellogo-9090<span class="token comment" spellcheck="true"># 8080端口的列表</span>/etc/nginx $ /dbg backends get default-hellogo-8080<span class="token punctuation">{</span>  <span class="token string">"endpoints"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.12.107"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"8080"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.12.108"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"8080"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.12.109"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"8080"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.23.23"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"8080"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.23.25"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"8080"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.23.29"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"8080"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">]</span>,  <span class="token string">"name"</span><span class="token keyword">:</span> <span class="token string">"default-hellogo-8080"</span>,  <span class="token string">"noServer"</span><span class="token keyword">:</span> false,  <span class="token string">"port"</span><span class="token keyword">:</span> 8080,  <span class="token punctuation">..</span>.<span class="token punctuation">}</span><span class="token comment" spellcheck="true"># 9090端口的列表</span>/etc/nginx $ /dbg backends get default-hellogo-9090<span class="token punctuation">{</span>  <span class="token string">"endpoints"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.12.107"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"9090"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.12.108"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"9090"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.12.109"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"9090"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.23.23"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"9090"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.23.25"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"9090"</span>    <span class="token punctuation">}</span>,    <span class="token punctuation">{</span>      <span class="token string">"address"</span><span class="token keyword">:</span> <span class="token string">"10.46.23.29"</span>,      <span class="token string">"port"</span><span class="token keyword">:</span> <span class="token string">"9090"</span>    <span class="token punctuation">}</span>  <span class="token punctuation">]</span>,  <span class="token string">"name"</span><span class="token keyword">:</span> <span class="token string">"default-hellogo-9090"</span>,  <span class="token string">"noServer"</span><span class="token keyword">:</span> false,  <span class="token string">"port"</span><span class="token keyword">:</span> 9090,  <span class="token punctuation">..</span>.<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对比发现两个端口的列表是一样的,只能看看代码.</p><p>ip-hash代码在<a href="https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/balancer/chash.lua" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/balancer/chash.lua</a></p><pre class="line-numbers language-lua"><code class="language-lua"><span class="token keyword">function</span> _M<span class="token punctuation">.</span><span class="token function">new</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> backend<span class="token punctuation">)</span>  <span class="token keyword">local</span> nodes <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">get_nodes</span><span class="token punctuation">(</span>backend<span class="token punctuation">.</span>endpoints<span class="token punctuation">)</span>  <span class="token keyword">local</span> o <span class="token operator">=</span> <span class="token punctuation">{</span>    instance <span class="token operator">=</span> self<span class="token punctuation">.</span>factory<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span>nodes<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">--获取后端pod ip列表</span>    hash_by <span class="token operator">=</span> backend<span class="token punctuation">[</span><span class="token string">"upstreamHashByConfig"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"upstream-hash-by"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    traffic_shaping_policy <span class="token operator">=</span> backend<span class="token punctuation">.</span>trafficShapingPolicy<span class="token punctuation">,</span>    alternative_backends <span class="token operator">=</span> backend<span class="token punctuation">.</span>alternativeBackends<span class="token punctuation">,</span>  <span class="token punctuation">}</span>  <span class="token function">setmetatable</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> self<span class="token punctuation">)</span>  self<span class="token punctuation">.</span>__index <span class="token operator">=</span> self  <span class="token keyword">return</span> o<span class="token keyword">end</span><span class="token keyword">function</span> _M<span class="token punctuation">.</span><span class="token function">balance</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>  <span class="token keyword">local</span> key <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">lua_ngx_var</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>hash_by<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">--获取需要hash的变量</span>  <span class="token keyword">return</span> self<span class="token punctuation">.</span>instance<span class="token punctuation">:</span><span class="token function">find</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">--计算hash值</span><span class="token keyword">end</span><span class="token keyword">return</span> _M<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>关键是在<code>get_nodes</code>函数,位于<a href="https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util.lua" target="_blank" rel="noopener">https://github.com/kubernetes/ingress-nginx/blob/master/rootfs/etc/nginx/lua/util.lua</a></p><pre class="line-numbers language-lua"><code class="language-lua"><span class="token keyword">function</span> _M<span class="token punctuation">.</span><span class="token function">get_nodes</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">)</span>  <span class="token keyword">local</span> nodes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token keyword">local</span> weight <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment" spellcheck="true">--所有后端weight相同都为1</span>  <span class="token keyword">for</span> _<span class="token punctuation">,</span> endpoint <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">)</span> <span class="token keyword">do</span>    <span class="token keyword">local</span> endpoint_string <span class="token operator">=</span> endpoint<span class="token punctuation">.</span>address <span class="token operator">..</span> <span class="token string">":"</span> <span class="token operator">..</span> endpoint<span class="token punctuation">.</span>port <span class="token comment" spellcheck="true">--endpoint为ip+port</span>    nodes<span class="token punctuation">[</span>endpoint_string<span class="token punctuation">]</span> <span class="token operator">=</span> weight  <span class="token keyword">end</span>  <span class="token keyword">return</span> nodes<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过代码可以看到在<code>ingress-nginx</code>中,实际的后端(upstream)是包含端口的,通过hash计算得到的值也不一样。</p><h2 id="解决建议"><a href="#解决建议" class="headerlink" title="解决建议"></a>解决建议</h2><p>首先确认系统的架构是不是合理，不同的端口提供不同的服务，一般是相互独立的。<br>如果确实有类似需求：</p><ul><li>通过同一个端口提供服务，使用path来区分不同功能</li><li>修改代码，也比较简单</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;业务反馈使用Ingress的ip-hash, 同一个服务开启了http和websocket分别是两个端口, 但是配置ip-hash后, 同一
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="ingress" scheme="https://qinng.now.sh/tags/ingress/"/>
    
      <category term="nginx" scheme="https://qinng.now.sh/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>如何做一个优雅的Pod</title>
    <link href="https://qinng.now.sh/pod-graceful-lifecycle/"/>
    <id>https://qinng.now.sh/pod-graceful-lifecycle/</id>
    <published>2020-04-11T07:54:47.000Z</published>
    <updated>2020-04-15T07:40:30.479Z</updated>
    
    <content type="html"><![CDATA[<p>没有人不想优雅的活着，在这喧闹的生活中过得优雅从容并不容易。但在k8s的世界中，如何做个优雅的Pod还是有套路可循的。</p><h2 id="Pod的生命周期"><a href="#Pod的生命周期" class="headerlink" title="Pod的生命周期"></a>Pod的生命周期</h2><p>在优雅之前，我们先谈谈Pod的一生，大体分为以下几个阶段</p><ol><li>创建，通过kubectl或者api创建pod, apiserver收到请求后存储到etcd</li><li>调度，scheduler检测到pod创建后，通过预选优选为pod选取合适的人家(node)</li><li>启动，kubelet检测到有pod调度到当前节点，开始启动pod</li><li>终止，不同的pod有不同的谢幕方式，有的正常运行结束没有restart就completed，有的被kill就入土为安了，有的被驱逐换种方式重新开始</li></ol><p>今天我们主要讨论3-4阶段，前面部分更多是deployment/daemonset这些pod的父母所决定的。</p><h2 id="优雅的启动"><a href="#优雅的启动" class="headerlink" title="优雅的启动"></a>优雅的启动</h2><h3 id="init-container"><a href="#init-container" class="headerlink" title="init container"></a>init container</h3><p>通常pod有一些初始化操作，创建文件夹，初始化磁盘，检查某些依赖服务是不是正常，这些操作放在代码中会污染代码，写在启动命令中不方便管理，出问题也不方便排查，更优雅的方式是使用k8s的[init container][1]。</p><p><strong>理解 Init 容器</strong><br>Pod 可以包含多个容器，应用运行在这些容器里面，同时 Pod 也可以有一个或多个先于应用容器启动的 Init 容器。</p><p>Init 容器与普通的容器非常像，除了如下两点：</p><ul><li>它们总是运行到完成。</li><li>每个都必须在下一个启动之前成功完成。<br>如果 Pod 的 Init 容器失败，Kubernetes 会不断地重启该 Pod，直到 Init 容器成功为止。然而，如果 Pod 对应的 restartPolicy 值为 Never，它不会重新启动。</li></ul><p>如果为一个 Pod 指定了多个 Init 容器，这些容器会按顺序逐个运行。每个 Init 容器必须运行成功，下一个才能够运行。当所有的 Init 容器运行完成时，Kubernetes 才会为 Pod 初始化应用容器并像平常一样运行。</p><p><strong>Init 容器能做什么？</strong><br>因为 Init 容器具有与应用容器分离的单独镜像，其启动相关代码具有如下优势：</p><ul><li>Init 容器可以包含一些安装过程中应用容器中不存在的实用工具或个性化代码。例如，没有必要仅为了在安装过程中使用类似 sed、 awk、 python 或 dig 这样的工具而去FROM 一个镜像来生成一个新的镜像。</li><li>Init 容器可以安全地运行这些工具，避免这些工具导致应用镜像的安全性降低。<br>应用镜像的创建者和部署者可以各自独立工作，而没有必要联合构建一个单独的应用镜像。<br>Init 容器能以不同于Pod内应用容器的文件系统视图运行。因此，Init容器可具有访问 Secrets 的权限，而应用容器不能够访问。</li><li>由于 Init 容器必须在应用容器启动之前运行完成，因此 Init 容器提供了一种机制来阻塞或延迟应用容器的启动，直到满足了一组先决条件。一旦前置条件满足，Pod内的所有的应用容器会并行启动。</li></ul><p><strong>示例</strong><br>下面的例子定义了一个具有 2 个 Init 容器的简单 Pod。 第一个等待 myservice 启动，第二个等待 mydb 启动。 一旦这两个 Init容器 都启动完成，Pod 将启动spec区域中的应用容器。</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>pod  <span class="token key atrule">labels</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> myapp<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> myapp<span class="token punctuation">-</span>container    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.28</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'echo The app is running! &amp;&amp; sleep 3600'</span><span class="token punctuation">]</span>  <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>myservice    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.28</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">"until nslookup myservice.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done"</span><span class="token punctuation">]</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>mydb    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.28</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">"until nslookup mydb.$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace).svc.cluster.local; do echo waiting for mydb; sleep 2; done"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="readinessProbe"><a href="#readinessProbe" class="headerlink" title="readinessProbe"></a>readinessProbe</h3><p>pod启动后，如果直接加入endpoint，有可能服务还没初始化完成，端口没有就绪，这时候接收流量肯定无法正常处理。如果能判断pod是否ready就好了，当当当，readiness来了，可以通过http，tcp以及执行命令的方式来检查服务情况，检查成功后再将pod状态设置为ready,ready后才会加入到endpoint中。</p><p>下为一个readiness探测，5秒执行一次命令，执行成功则pod变为ready</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>  <span class="token key atrule">exec</span><span class="token punctuation">:</span>    <span class="token key atrule">command</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> cat    <span class="token punctuation">-</span> /tmp/healthy  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>  <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong>注</strong></p><ul><li>http, tcp探针是kubelet执行的，所以无法探测容器中localhost的端口，也无法解析service</li><li>exec则在容器内执行的</li></ul></blockquote><h3 id="ReadinessGates"><a href="#ReadinessGates" class="headerlink" title="ReadinessGates"></a>ReadinessGates</h3><p>ReadinessProbe机制可能无法满足某些复杂应用对容器内服务可用状态的判断，所以kubernetes从1.11版本开始引入了<code>Pod Ready++</code>特性对Readiness探测机制进行扩展，在1.14版本时达到GA稳定版本，称其为<code>Pod Readiness Gates</code>。</p><p>通过Pod Readiness Gates机制，用户可以将自定义的ReadinessProbe探测方式设置在Pod上，辅助kubernetes设置Pod何时达到服务可用状态Ready，为了使自定义的ReadinessProbe生效，用户需要提供一个外部的控制器Controller来设置相应的Condition状态。Pod的Readiness Gates在pod定义中的ReadinessGates字段进行设置，</p><p>如下示例设置了一个类型为<code>www.example.com/feature-1</code>的新Readiness Gates：</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">Kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">readinessGates</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">conditionType</span><span class="token punctuation">:</span> <span class="token string">"www.example.com/feature-1"</span><span class="token key atrule">status</span><span class="token punctuation">:</span>  <span class="token key atrule">conditions</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Ready  <span class="token comment" spellcheck="true"># kubernetes系统内置的名为Ready的Condition</span>      <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"True"</span>      <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token datetime number">2018-01-01T00:00:00Z</span>    <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> <span class="token string">"www.example.com/feature-1"</span>   <span class="token comment" spellcheck="true"># 用户定义的Condition</span>      <span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token string">"False"</span>      <span class="token key atrule">lastProbeTime</span><span class="token punctuation">:</span> <span class="token null important">null</span>      <span class="token key atrule">lastTransitionTime</span><span class="token punctuation">:</span> <span class="token datetime number">2018-01-01T00:00:00Z</span>  <span class="token key atrule">containerStatuses</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">containerID</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>//abcd<span class="token punctuation">...</span>      <span class="token key atrule">ready</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>新增的自定义Condition的状态status将由用户自定义的外部控制器设置，默认值为False，kubernetes将在判断全部readinessGates条件都为True时，才设置pod为服务可用状态（Ready或True）。</p><h3 id="poststart"><a href="#poststart" class="headerlink" title="poststart"></a>poststart</h3><p>另外也可以通过<code>poststart</code>设置hook操作，做一些额外工作。k8s在容器创建后立即发送 postStart 事件。然而，postStart 处理函数的调用不保证早于容器的入口点（entrypoint） 的执行。postStart 处理函数与容器的代码是异步执行的，但 Kubernetes 的容器管理逻辑会一直阻塞等待 postStart 处理函数执行完毕。只有 postStart 处理函数执行完毕，容器的状态才会变成<code>RUNNING</code>。</p><h2 id="优雅的运行"><a href="#优雅的运行" class="headerlink" title="优雅的运行"></a>优雅的运行</h2><h3 id="livenessProbe"><a href="#livenessProbe" class="headerlink" title="livenessProbe"></a>livenessProbe</h3><p>同readinessProbe探针，livenessProbe是用来检查pod运行状态是否正常，如果探测失败，pod被kill掉，重启启动pod。</p><h3 id="restartpolicy"><a href="#restartpolicy" class="headerlink" title="restartpolicy"></a>restartpolicy</h3><p>如果pod运行时意外退出(程序故障)，kubelet会根据restart policy来判断是否重启pod，可能的值为 Always、OnFailure 和 Never。默认为 Always，如果容器退出会再再启动，pod启动次数加1。</p><h2 id="优雅的结束"><a href="#优雅的结束" class="headerlink" title="优雅的结束"></a>优雅的结束</h2><p>首先谈下pod的删除流程：</p><ol><li>用户发送命令删除 Pod，使用的是默认的宽限期（grace period 30秒）</li><li>apiserver中的 Pod 会随着宽限期规定的时间进行更新，过了这个时间 Pod 就会被认为已”dead”</li><li>当使用客户端命令查询 Pod 状态时，Pod 显示为 “Terminating”</li><li>（和第 3 步同步进行）当 Kubelet 看到 Pod 由于步骤 2 中设置的时间而被标记为 terminating 状态时，它就开始执行关闭 Pod 流程<ul><li>如果 Pod 定义了 preStop 钩子，就在 Pod 内部调用它。如果宽限期结束了，但是 preStop 钩子还在运行，那么就用小的（2 秒）扩展宽限期调用步骤 2。</li><li>给 Pod 内的进程发送 <code>TERM</code> 信号(即<code>kill</code>, <code>kill -15</code>)。请注意，并不是所有 Pod 中的容器都会同时收到 TERM 信号，如果它们关闭的顺序很重要，则每个容器可能都需要一个 preStop 钩子。</li></ul></li><li>（和第 3 步同步进行）从服务的<code>endpoint</code>列表中删除 Pod，Pod 也不再被视为副本控制器的运行状态的 Pod 集的一部分。因为负载均衡器（如服务代理）会将其从轮换中删除，所以缓慢关闭的 Pod 无法继续为流量提供服务。</li><li>当宽限期到期时，仍在 Pod 中运行的所有进程都会被<code>SIGKILL</code>(即<code>kill -9</code>)信号杀死。</li></ol><h3 id="捕捉SIGTERM"><a href="#捕捉SIGTERM" class="headerlink" title="捕捉SIGTERM"></a>捕捉SIGTERM</h3><p>如果pod没有捕捉<code>SIGTERM</code>信号就直接退出，有些请求还没处理完，这势必影响服务质量，所以需要优雅退出，很多库都提供了类似的功能，当接受到退出信号时，清理空闲链接，等待当前请求处理完后再退出。如果善后工作较长，比较适当增加<code>terminationGracePeriodSeconds</code>的时间。</p><h3 id="prestop"><a href="#prestop" class="headerlink" title="prestop"></a>prestop</h3><p>另外也可以通过<code>prestop</code>设置hook操作，做一些额外的清理工作，</p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle<span class="token punctuation">-</span>demo<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lifecycle<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>container    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>      <span class="token key atrule">preStop</span><span class="token punctuation">:</span>        <span class="token key atrule">exec</span><span class="token punctuation">:</span>          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"nginx -s quit; while killall -0 nginx; do sleep 1; done"</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>命令 preStop 负责优雅地终止 nginx 服务。当因为失效而导致容器终止时，这一处理方式很有用。</p><blockquote><p><strong>注</strong><br>  Kubernetes 只有在 Pod 结束（Terminated） 的时候才会发送 preStop 事件，这意味着在 Pod 完成（Completed） 时 preStop 的事件处理逻辑不会被触发。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>优雅就不要怕麻烦，来我们总结下优雅的秘诀：</p><ol><li>需要初始化的操作使用initcontainer来做</li><li>就绪检查，探活检查少不了,必要时也可以配置ReadinessGates</li><li>优雅退出要处理<code>SIGTERM</code></li><li>需要时也可以设置下poststart, prestop</li><li>其他的，设置limit/reqeust也是必须的</li></ol><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>[1] <a href="https://kubernetes.io/zh/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/concepts/workloads/pods/init-containers/</a><br>[2] <a href="https://kubernetes.io/zh/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;没有人不想优雅的活着，在这喧闹的生活中过得优雅从容并不容易。但在k8s的世界中，如何做个优雅的Pod还是有套路可循的。&lt;/p&gt;
&lt;h2 id=&quot;Pod的生命周期&quot;&gt;&lt;a href=&quot;#Pod的生命周期&quot; class=&quot;headerlink&quot; title=&quot;Pod的生命周期&quot;
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
  </entry>
  
  <entry>
    <title>nginx ingress controller 最后的倔强: admission webhook</title>
    <link href="https://qinng.now.sh/ingress-nginx-controller-admission-webhook/"/>
    <id>https://qinng.now.sh/ingress-nginx-controller-admission-webhook/</id>
    <published>2020-04-03T10:48:04.000Z</published>
    <updated>2020-04-07T07:57:26.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>k8s中大多使用nginx-ingress-controller来实现ingress, 但是脆弱的nginx-controller通过ingress解析出nginx配置, 对于某些annotation会reload nignx配置失败, 然后controller就卡死了, 不断重启, 除非删除对应的ingress.</p><h3 id="问题复现"><a href="#问题复现" class="headerlink" title="问题复现"></a>问题复现</h3><p>创建有问题的<code>ingress</code></p><pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream</span><span class="token punctuation">:</span> <span class="token string">"false"</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-tls-verify-client</span><span class="token punctuation">:</span> optional    <span class="token key atrule">nginx.ingress.kubernetes.io/auth-tls-verify-depth</span><span class="token punctuation">:</span> <span class="token string">"1"</span>    <span class="token key atrule">nginx.ingress.kubernetes.io/configuration-snippet</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">      proxy_set_header Host $targethost;      proxy_buffering     off;      proxy_pass          http://$targetbackend;      proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;      proxy_redirect      off;      proxy_set_header    X-SSL-Client-Verify $ssl_client_verify;      proxy_set_header    X-SSL-Client-DN $ssl_client_s_dn;      proxy_set_header    X-Real-IP       $remote_addr;      proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span>  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2020-03-23T04:57:22Z"</span>  <span class="token key atrule">generation</span><span class="token punctuation">:</span> <span class="token number">1</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>ingress  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">"57681168"</span>  <span class="token key atrule">selfLink</span><span class="token punctuation">:</span> /apis/extensions/v1beta1/namespaces/kube<span class="token punctuation">-</span>system/ingresses/example<span class="token punctuation">-</span>ingress  <span class="token key atrule">uid</span><span class="token punctuation">:</span> c7f66385<span class="token punctuation">-</span>6cc2<span class="token punctuation">-</span>11ea<span class="token punctuation">-</span>b6a8<span class="token punctuation">-</span>246e96d4b538<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> example.com    <span class="token key atrule">http</span><span class="token punctuation">:</span>      <span class="token key atrule">paths</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>svc          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8008</span>        <span class="token key atrule">path</span><span class="token punctuation">:</span> /  <span class="token key atrule">tls</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> example.com    <span class="token key atrule">secretName</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>tls<span class="token key atrule">status</span><span class="token punctuation">:</span>  <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看<code>nginx-ingress-controller</code>状态全部为<code>CrashLoopBackOff</code></p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># kubectl get po -n kube-system -owide |grep ingress</span>nginx-ingress-controller-ftfbg                        1/2     CrashLoopBackOff   6          8m27snginx-ingress-controller-hp4pf                        1/2     CrashLoopBackOff   11         24m  nginx-ingress-controller-qlb4l                        1/2     CrashLoopBackOff   11         24m   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>查看<code>nginx-ingress-controller</code>日志, 显示reload失败<code>&quot;proxy_pass&quot; directive is duplicate in /tmp/nginx-cfg911768424:822</code></p><pre class="line-numbers language-bash"><code class="language-bash">-------------------------------------------------------------------------------W0403 10:26:14.716246       1 queue.go:130<span class="token punctuation">]</span> requeuing kube-system/nginx-ingress-controller-4txfk, err -------------------------------------------------------------------------------Error: <span class="token keyword">exit</span> status 12020/04/03 10:26:14 <span class="token punctuation">[</span>notice<span class="token punctuation">]</span> 137<span class="token comment" spellcheck="true">#137: ModSecurity-nginx v1.0.0</span>2020/04/03 10:26:14 <span class="token punctuation">[</span>warn<span class="token punctuation">]</span> 137<span class="token comment" spellcheck="true">#137: duplicate value "error" in /tmp/nginx-cfg911768424:815</span>nginx: <span class="token punctuation">[</span>warn<span class="token punctuation">]</span> duplicate value <span class="token string">"error"</span> <span class="token keyword">in</span> /tmp/nginx-cfg911768424:8152020/04/03 10:26:14 <span class="token punctuation">[</span>warn<span class="token punctuation">]</span> 137<span class="token comment" spellcheck="true">#137: duplicate value "timeout" in /tmp/nginx-cfg911768424:815</span>nginx: <span class="token punctuation">[</span>warn<span class="token punctuation">]</span> duplicate value <span class="token string">"timeout"</span> <span class="token keyword">in</span> /tmp/nginx-cfg911768424:8152020/04/03 10:26:14 <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> 137<span class="token comment" spellcheck="true">#137: "proxy_pass" directive is duplicate in /tmp/nginx-cfg911768424:822</span>nginx: <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> <span class="token string">"proxy_pass"</span> directive is duplicate <span class="token keyword">in</span> /tmp/nginx-cfg911768424:822nginx: configuration <span class="token function">file</span> /tmp/nginx-cfg911768424 <span class="token function">test</span> failed-------------------------------------------------------------------------------W0403 10:26:16.998897       1 nginx_status.go:207<span class="token punctuation">]</span> unexpected error obtaining nginx status info: unexpected error scraping nginx status page: unexpected error scraping nginx <span class="token keyword">:</span> Get http://0.0.0.0:18080/nginx_status: dial tcp 0.0.0.0:18080: connect: connection refusedI0403 10:26:17.526801       1 main.go:167<span class="token punctuation">]</span> Received SIGTERM, shutting downI0403 10:26:17.526827       1 nginx.go:364<span class="token punctuation">]</span> Shutting down controller queuesI0403 10:26:17.526845       1 status.go:200<span class="token punctuation">]</span> updating status of Ingress rules <span class="token punctuation">(</span>remove<span class="token punctuation">)</span>I0403 10:26:17.537511       1 status.go:219<span class="token punctuation">]</span> removing address from ingress status <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>I0403 10:26:17.537593       1 nginx.go:372<span class="token punctuation">]</span> Stopping NGINX process2020/04/03 10:26:17 <span class="token punctuation">[</span>notice<span class="token punctuation">]</span> 141<span class="token comment" spellcheck="true">#141: signal process started</span>I0403 10:26:20.547669       1 nginx.go:385<span class="token punctuation">]</span> NGINX process has stoppedI0403 10:26:20.547692       1 main.go:175<span class="token punctuation">]</span> Handled quit, awaiting Pod deletionI0403 10:26:30.547824       1 main.go:178<span class="token punctuation">]</span> Exiting with 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>创建一个有问题的ingress, 会影响所有新创建的ingress规则, 又一个集群级别的Bug诞生了.那么有没有办法, 提前检验ingress配置, 有问题就不去reload. 那验证步骤肯定要在请求到达nginx-controller之前来做, 是不是想到了<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noopener">k8s-admission-webhook</a>, 可以在apiserver持久化对象前拦截请求, 去实现自定义的验证规则. 好在新版本的nginx-ingress-controller(v0.25.0+)已经实现了相关的功能, 只需开启对应配置就行.</p><h3 id="ApiServer配置"><a href="#ApiServer配置" class="headerlink" title="ApiServer配置"></a>ApiServer配置</h3><p>Apiserver开启webhook相关配置, 必须包含<code>MutatingAdmissionWebhook</code>与<code>ValidatingAdmissionWebhook</code></p><pre><code>--admission-control=MutatingAdmissionWebhook,ValidatingAdmissionWebhook</code></pre><h3 id="创建webhook相关配置"><a href="#创建webhook相关配置" class="headerlink" title="创建webhook相关配置"></a>创建webhook相关配置</h3><p>启用ValidatingAdmissionWebhook必须使用https, 需要配置对应证书</p><ul><li>手动生成:<pre class="line-numbers language-bash"><code class="language-bash">openssl req -x509 -newkey rsa:2048 -keyout certificate.pem -out key.pem -days 365 -nodes -subj <span class="token string">"/CN=ingress-validation-webhook.ingress-nginx.svc"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>CertificateSigningRequest<br>通过k8s <code>CertificateSigningRequest</code>来创建(controller-manager需要开启<code>--cluster-signing-cert-file</code>与<code>--cluster-signing-key-file</code>)<br>可通过如下脚本创建, namespace与service替换成自己的</p><pre class="line-numbers language-bash"><code class="language-bash">SERVICE_NAME<span class="token operator">=</span>ingress-nginxNAMESPACE<span class="token operator">=</span>ingress-nginxTEMP_DIRECTORY<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>mktemp -d<span class="token variable">)</span></span><span class="token keyword">echo</span> <span class="token string">"creating certs in directory <span class="token variable">${TEMP_DIRECTORY}</span>"</span><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">>></span> <span class="token variable">${TEMP_DIRECTORY}</span>/csr.conf<span class="token punctuation">[</span>req<span class="token punctuation">]</span>req_extensions <span class="token operator">=</span> v3_reqdistinguished_name <span class="token operator">=</span> req_distinguished_name<span class="token punctuation">[</span>req_distinguished_name<span class="token punctuation">]</span><span class="token punctuation">[</span> v3_req <span class="token punctuation">]</span>basicConstraints <span class="token operator">=</span> CA:FALSEkeyUsage <span class="token operator">=</span> nonRepudiation, digitalSignature, keyEnciphermentextendedKeyUsage <span class="token operator">=</span> serverAuthsubjectAltName <span class="token operator">=</span> @alt_names<span class="token punctuation">[</span>alt_names<span class="token punctuation">]</span>DNS.1 <span class="token operator">=</span> <span class="token variable">${SERVICE_NAME}</span>DNS.2 <span class="token operator">=</span> <span class="token variable">${SERVICE_NAME}</span><span class="token keyword">.</span><span class="token variable">${NAMESPACE}</span>DNS.3 <span class="token operator">=</span> <span class="token variable">${SERVICE_NAME}</span><span class="token keyword">.</span><span class="token variable">${NAMESPACE}</span>.svcEOFopenssl genrsa -out <span class="token variable">${TEMP_DIRECTORY}</span>/server-key.pem 2048openssl req -new -key <span class="token variable">${TEMP_DIRECTORY}</span>/server-key.pem \    -subj <span class="token string">"/CN=<span class="token variable">${SERVICE_NAME}</span>.<span class="token variable">${NAMESPACE}</span>.svc"</span> \    -out <span class="token variable">${TEMP_DIRECTORY}</span>/server.csr \    -config <span class="token variable">${TEMP_DIRECTORY}</span>/csr.conf<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> kubectl create -f -apiVersion: certificates.k8s.io/v1beta1kind: CertificateSigningRequestmetadata:  name: <span class="token variable">${SERVICE_NAME}</span><span class="token keyword">.</span><span class="token variable">${NAMESPACE}</span>.svcspec:  request: <span class="token punctuation">$(</span>cat <span class="token variable">${TEMP_DIRECTORY}</span>/server.csr <span class="token operator">|</span> base64 <span class="token operator">|</span> <span class="token function">tr</span> -d <span class="token string">'\n'</span><span class="token punctuation">)</span>  usages:  - digital signature  - key encipherment  - server authEOFkubectl certificate approve <span class="token variable">${SERVICE_NAME}</span><span class="token keyword">.</span><span class="token variable">${NAMESPACE}</span>.svc<span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> 10<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>    SERVER_CERT<span class="token operator">=</span><span class="token punctuation">$(</span>kubectl get csr <span class="token variable">${SERVICE_NAME}</span><span class="token keyword">.</span><span class="token variable">${NAMESPACE}</span>.svc -o jsonpath<span class="token operator">=</span><span class="token string">'{.status.certificate}'</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${SERVER_CERT}</span> <span class="token operator">!=</span> <span class="token string">''</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>        <span class="token keyword">break</span>    <span class="token keyword">fi</span>    <span class="token function">sleep</span> 1<span class="token keyword">done</span><span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token variable">${SERVER_CERT}</span> <span class="token operator">==</span> <span class="token string">''</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    <span class="token keyword">echo</span> <span class="token string">"ERROR: After approving csr <span class="token variable">${SERVICE_NAME}</span>.<span class="token variable">${NAMESPACE}</span>.svc, the signed certificate did not appear on the resource. Giving up after 10 attempts."</span> <span class="token operator">></span><span class="token operator">&amp;</span>2    <span class="token keyword">exit</span> 1<span class="token keyword">fi</span><span class="token keyword">echo</span> <span class="token variable">${SERVER_CERT}</span> <span class="token operator">|</span> openssl base64 -d -A -out <span class="token variable">${TEMP_DIRECTORY}</span>/server-cert.pemkubectl create secret generic ingress-nginx.svc \    --from-file<span class="token operator">=</span>key.pem<span class="token operator">=</span><span class="token variable">${TEMP_DIRECTORY}</span>/server-key.pem \    --from-file<span class="token operator">=</span>cert.pem<span class="token operator">=</span><span class="token variable">${TEMP_DIRECTORY}</span>/server-cert.pem \    -n <span class="token variable">${NAMESPACE}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="配置ingress-controller"><a href="#配置ingress-controller" class="headerlink" title="配置ingress controller"></a>配置ingress controller</h3><p>ingress controller需要启用如下参数, 挂载需要的tls证书</p><table><thead><tr><th>flag</th><th>description</th><th>example usage</th></tr></thead><tbody><tr><td><code>--validating-webhook</code></td><td>admission webhook的地址</td><td><code>:8080</code></td></tr><tr><td><code>--validating-webhook-certificate</code></td><td>webhook证书</td><td><code>/usr/local/certificates/validating-webhook.pem</code></td></tr><tr><td><code>--validating-webhook-key</code></td><td>webhook私钥</td><td><code>/usr/local/certificates/validating-webhook-key.pem</code></td></tr></tbody></table><h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>更新后, 创建有问题的ingress则会拦截, 符合预期</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># kubectl apply -f ing.yaml</span>Error from server: error when creating <span class="token string">"ing.yaml"</span><span class="token keyword">:</span> admission webhook <span class="token string">"validate.nginx.ingress.kubernetes.io"</span> denied the request: -------------------------------------------------------------------------------Error: <span class="token keyword">exit</span> status 12020/04/02 10:26:04 <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> 331<span class="token comment" spellcheck="true">#331: directive "proxy_pass" is not terminated by ";" in /tmp/nginx-cfg461116913:2165</span>nginx: <span class="token punctuation">[</span>emerg<span class="token punctuation">]</span> directive <span class="token string">"proxy_pass"</span> is not terminated by <span class="token string">";"</span> <span class="token keyword">in</span> /tmp/nginx-cfg461116913:2165nginx: configuration <span class="token function">file</span> /tmp/nginx-cfg461116913 <span class="token function">test</span> failed<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><ul><li><a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers/</a></li><li><a href="https://kubernetes.github.io/ingress-nginx/deploy/validating-webhook/" target="_blank" rel="noopener">https://kubernetes.github.io/ingress-nginx/deploy/validating-webhook/</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;k8s中大多使用nginx-ingress-controller来实现ingress, 但是脆弱的nginx-controller通过ing
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="ingress" scheme="https://qinng.now.sh/tags/ingress/"/>
    
  </entry>
  
  <entry>
    <title>pod sandbox 创建失败</title>
    <link href="https://qinng.now.sh/pod-sandbox-recreated/"/>
    <id>https://qinng.now.sh/pod-sandbox-recreated/</id>
    <published>2020-03-18T10:22:05.000Z</published>
    <updated>2020-03-19T03:48:44.052Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>今天在k8s更新服务时,发现pod启动失败,报错<code>failed to start sandbox container</code>,如下所示:</p><pre class="line-numbers language-bash"><code class="language-bash">Events:  Type     Reason                  Age                     From                                           Message  ----     ------                  ----                    ----                                           -------  Normal   Scheduled               28m                     default-scheduler                              Successfully assigned kube-system/k8s-proxy-7wkt4 to tj1-staging-com-ocean007-201812.kscn  Warning  FailedCreatePodSandBox  28m <span class="token punctuation">(</span>x13 over 28m<span class="token punctuation">)</span>      kubelet, tj1-staging-com-ocean007-201812.kscn  Failed create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to start sandbox container <span class="token keyword">for</span> pod <span class="token string">"k8s-proxy-7wkt4"</span><span class="token keyword">:</span> Error response from daemon: OCI runtime create failed: container_linux.go:345: starting container process caused <span class="token string">"process_linux.go:297: getting the final child's pid from pipe caused \"EOF\""</span><span class="token keyword">:</span> unknown  Normal   SandboxChanged          3m19s <span class="token punctuation">(</span>x1364 over 28m<span class="token punctuation">)</span>  kubelet, tj1-staging-com-ocean007-201812.kscn  Pod sandbox changed, it will be killed and re-created.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>sandbox 创建失败只是表象,是宿主机其他异常导致的,一般是(cpu,diskio,mem)导致的.</p><p>首先,上节点看kubelet,docker有无异常,日志没有明显错误,通过<code>top</code>看到docker cpu占用非常高</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@tj1-staging-com-ocean007-201812 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># top</span><span class="token function">top</span> - 17:55:00 up 265 days,  3:41,  1 user,  load average: 10.71, 11.34, 10.76Tasks: 816 total,   5 running, 811 sleeping,   0 stopped,   0 zombie%Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>: 24.0 us, 34.5 sy,  0.0 ni, 41.4 id,  0.0 wa,  0.0 hi,  0.1 si,  0.0 stKiB Mem <span class="token keyword">:</span> 65746380 total, 20407940 free, 11007040 used, 34331400 buff/cacheKiB Swap:        0 total,        0 free,        0 used. 49134416 avail Mem     PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                                       115483 root      20   0 3965212 273188  34564 S 489.7  0.4 382260:40 dockerd                                                                                                                                      1367523 root      20   0   18376   2972   2716 R  66.9  0.0  20163:45 <span class="token function">bash</span>                                                                                                                                         1367487 root      20   0   11856   5616   4512 S  54.0  0.0  16748:26 containerd-shim                                                                                                                              3200169 root      20   0    1300      4      0 R  53.3  0.0  14913:49 sh                                                                                                                                           2429952 root      20   0    1300      4      0 S  49.3  0.0   9620:56 sh                                                                                                                                           3200130 root      20   0    9392   4756   3884 S  47.7  0.0  13417:30 containerd-shim                                                                                                                              3718475 root      20   0    1300      4      0 R  47.4  0.0   8600:20 sh                                                                                                                                           3718440 root      20   0   10736   5516   4512 S  42.1  0.0   7575:31 containerd-shim                                                                                                                              2429917 root      20   0   11856   5556   4512 S  40.1  0.0   8313:22 containerd-shim                                                                                                                              3205493 root      20   0 3775924 230996  66704 S  18.9  0.4   2559:07 kubelet                                                                                                                                            1 root      20   0  195240 157000   3932 S   7.9  0.2   1417:46 systemd                                                                                                                                          804 dbus      20   0   30308   6460   2464 S   1.7  0.0 462:18.84 dbus-daemon                                                                                                                                  1011737 root      20   0  277656 122788  18428 S   1.3  0.2 768:03.00 cadvisor                                                                                                                                      115508 root      20   0 7139200  32896  24288 S   1.0  0.1 662:25.27 containerd                                                                                                                                       806 root      20   0   24572   3060   2480 S   0.7  0.0 171:22.52 systemd-logind                                                                                                                                511080 root       0 -20 2751348  52552  15744 S   0.7  0.1 178:27.51 sagent                                                                                                                                       1102507 root      20   0   11792   7292   4512 S   0.7  0.0  23:36.37 containerd-shim                                                                                                                              1272223 root      20   0  164800   5296   3824 R   0.7  0.0   0:00.38 <span class="token function">top</span>                                                                                                                                          2866292 root      20   0 5045000 1.983g   3080 S   0.7  3.2 230:09.47 redis<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>同时, cpu system异常高.</p><pre class="line-numbers language-bash"><code class="language-bash">%Cpu<span class="token punctuation">(</span>s<span class="token punctuation">)</span>: 24.0 us, 34.5 sy,  0.0 ni, 41.4 id,  0.0 wa,  0.0 hi,  0.1 si,  0.0 st<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>按照以前的经验,一般是由某些容器引起的,通过<code>top</code>看到个别<code>sh</code>进程占用cpu较高.</p><p>通过<code>ps</code>看到进程居然是个死循环</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@tj1-staging-com-ocean007-201812 ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ps -ef |grep 1367523</span>root     1287628 1247781  0 17:55 pts/1    00:00:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto 1367523root     1367523 1367504 72 Feb28 ?        14-00:04:17 /bin/bash -c <span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token keyword">echo</span> hello<span class="token punctuation">;</span> <span class="token keyword">done</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>通过<code>/proc/pid/cgroup</code>找到对应容器</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># cat /proc/1367523/cgroup</span>11:freezer:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd10:devices:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd9:hugetlb:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd8:blkio:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd7:memory:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd6:perf_event:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd5:cpuset:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd4:pids:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd3:net_cls,net_prio:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd2:cpu,cpuacct:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd1:name<span class="token operator">=</span>systemd:/kubepods/besteffort/pod55d3adf2-67f7-11ea-93f2-246e968203b8/29842d5544b701dbb5ff647dba19bb4ebec821edc6ee1ffbd7aeee58fa5038fd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>找到对应容器</p><pre class="line-numbers language-bash"><code class="language-bash">docker <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> 29842d554<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>清理完相关pod后,系统恢复正常</p><pre><code>top - 18:25:57 up 265 days,  4:12,  1 user,  load average: 1.05, 1.24, 4.02Tasks: 769 total,   1 running, 768 sleeping,   0 stopped,   0 zombie%Cpu(s):  1.7 us,  0.9 sy,  0.0 ni, 97.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 stKiB Mem : 65746380 total, 22106960 free, 10759860 used, 32879560 buff/cacheKiB Swap:        0 total,        0 free,        0 used. 49401576 avail Mem     PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND                                                                                                                                      3205493 root      20   0 3775924 229844  66704 S   9.9  0.3   2563:18 kubelet                                                                                                                                       115483 root      20   0 3965468 249124  34564 S   7.9  0.4 382323:36 dockerd                                                                                                                                            1 root      20   0  195240 157000   3932 S   6.3  0.2   1419:48 systemd                                                                                                                                          804 dbus      20   0   30308   6460   2464 S   2.0  0.0 462:51.51 dbus-daemon                                                                                                                                  3085322 root      20   0 12.045g 1.578g  19028 S   1.3  2.5 767:51.19 java                                                                                                                                          115508 root      20   0 7139200  32264  24288 S   1.0  0.0 662:42.18 containerd                                                                                                                                    511080 root       0 -20 2751348  42116  15744 S   1.0  0.1 178:44.79 sagent                                                                                                                                       1011737 root      20   0  277656 111836  18428 S   1.0  0.2 768:49.01 cadvisor                                                                                                                                     1523167 root      20   0  164800   5436   4012 R   0.7  0.0   0:00.04 top                                                                                                                                          3199459 root      20   0 1554708  43668   9496 S   0.7  0.1  28:50.60 falcon-agent                                                                                                                                       7 root      20   0       0      0      0 S   0.3  0.0 619:07.64 rcu_sched                                                                                                                                        806 root      20   0   24572   3060   2480 S   0.3  0.0 171:33.69 systemd-logind                                                                                                                                 11921 root      20   0   94820  20480   5840 S   0.3  0.0   1402:42 consul                                                                                                                                        575838 root      20   0  411464  17092   7364 S   0.3  0.0  15:16.25 python                                                                                                                                        856593 root      20   0 1562392  37912   9612 S   0.3  0.1  21:34.23 falcon-agent                                                                                                                                  931957 33        20   0   90728   3392   1976 S   0.3  0.0   0:51.23 nginx                                                                                                                                        1212186 root      20   0       0      0      0 S   0.3  0.0   0:01.12 kworker/14:1                                                                                                                                 1726228 root      20   0    9392   4496   3808 S   0.3  0.0   0:00.67 containerd-shim                                                                                                                              1887128 root      20   0  273160   7932   3128 S   0.3  0.0  46:05.23 redis-server                                                                                                                                 2788111 root      20   0  273160   6300   3080 S   0.3  0.0  25:18.55 redis-server                                                                                                                                 3199297 root      20   0 1563160  44812   9624 S   0.3  0.1  31:13.73 falcon-agent     </code></pre><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>sandox创建失败的原因是各种各样的, 如[memory设置错误触发的异常][1],[dockerd异常][2].</p><p>针对此处问题是由于某些测试pod通过<code>while true; do echo hello; done</code>启动,死循环一直<code>echo hello</code>产生大量<code>read()</code>系统调用,所在cpu飙升.多个类似pod导致系统非常繁忙,无法正常处理其他请求.</p><p>此类问题不容易在pod创建时直接检测到,只能通过添加物理节点相关报警(dockerd cpu使用率, node cpu.sys使用率)及时发现问题.</p><h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>[1] <a href="https://github.com/kubernetes/kubernetes/issues/56996" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/issues/56996</a><br>[2] <a href="https://plugaru.org/2018/05/21/pod-sandbox-changed-it-will-be-killed-and-re-created/" target="_blank" rel="noopener">https://plugaru.org/2018/05/21/pod-sandbox-changed-it-will-be-killed-and-re-created/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;今天在k8s更新服务时,发现pod启动失败,报错&lt;code&gt;failed to start sandbox container&lt;/code&gt;
      
    
    </summary>
    
      <category term="cloud" scheme="https://qinng.now.sh/categories/cloud/"/>
    
    
      <category term="k8s" scheme="https://qinng.now.sh/tags/k8s/"/>
    
      <category term="docker" scheme="https://qinng.now.sh/tags/docker/"/>
    
  </entry>
  
</feed>
