<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="kube-apiserver启动流程分析, Qinng">
    <meta name="description" content="Coding, Reading and Daydreaming">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>kube-apiserver启动流程分析 | Qinng</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/medias/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/jquery/jquery.min.js"></script>

<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/medias/favicon.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Qinng</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/medias/favicon.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Qinng</div>
        <div class="logo-desc">
            
            Coding, Reading and Daydreaming
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/medias/featureimages/18.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">kube-apiserver启动流程分析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        background: #fff !important;
        opacity: 0.8;
    }

    #floating-toc-btn .btn-floating i {
        color: #1f4d71;
        font-size: 1rem;
    }

    #floating-toc-btn .after {
        color: #000;
        font-size: 1rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/k8s/">
                                <span class="chip bg-color">k8s</span>
                            </a>
                        
                            <a href="/tags/apiserver/">
                                <span class="chip bg-color">apiserver</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/cloud/" class="post-category">
                                cloud
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-04-24
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    804
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    3 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>kube-apiserver 共由 3 个组件构成（Aggregator. KubeAPIServer. APIExtensionServer），这些组件依次通过 Delegation 处理请求：</p>
<ul>
<li>Aggregator：暴露的功能类似于一个七层负载均衡，将来自用户的请求拦截转发给其他服务器，并且负责整个 APIServer 的 Discovery 功能；也负责处理ApiService，注册对应的扩展api。</li>
<li>KubeAPIServer ：负责对请求的一些通用处理，认证. 鉴权等，以及处理各个内建资源的 REST 服务；</li>
<li>APIExtensionServer：主要处理 CustomResourceDefinition（CRD）和 CustomResource（CR）的 REST 请求，也是 Delegation 的最后一环，如果对应 CR 不能被处理的话则会返回 404。</li>
</ul>
<h2 id="kube-apiserver启动流程"><a href="#kube-apiserver启动流程" class="headerlink" title="kube-apiserver启动流程"></a>kube-apiserver启动流程</h2><p>Apiserver通过<code>Run</code>方法启动, 主要逻辑为：</p>
<ol>
<li>调用<code>CreateServerChain</code>构建服务调用链并判断是否启动非安全的<code>httpserver</code>，<code>httpserver</code>链中包含 apiserver要启动的三个server，以及为每个server注册对应资源的路由；</li>
<li>调用<code>server.PrepareRun</code>进行服务运行前的准备，该方法主要完成了健康检查. 存活检查和OpenAPI路由的注册工作；</li>
<li><p>调用<code>prepared.Run</code>启动server；</p>
<pre class="line-numbers language-golang"><code class="language-golang">// Run runs the specified APIServer.  This should never exit.
func Run(completeOptions completedServerRunOptions, stopCh <-chan struct{}) error {
 // To help debugging, immediately log version
 klog.Infof("Version: %+v", version.Get())

// 创建调用链
 server, err := CreateServerChain(completeOptions, stopCh)
 if err != nil {
     return err
 }

// 进行一些准备工作， 注册一些hander，执行hook等
 prepared, err := server.PrepareRun()
 if err != nil {
     return err
 }

// 开始执行
 return prepared.Run(stopCh)
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<p>执行具体的<code>Run</code>方法</p>
<pre class="line-numbers language-golang"><code class="language-golang">// Run spawns the secure http server. It only returns if stopCh is closed
// or the secure port cannot be listened on initially.
func (s preparedGenericAPIServer) Run(stopCh <-chan struct{}) error {
    delayedStopCh := make(chan struct{})

    go func() {
        defer close(delayedStopCh)

        <-stopCh

        // As soon as shutdown is initiated, /readyz should start returning failure.
        // This gives the load balancer a window defined by ShutdownDelayDuration to detect that /readyz is red
        // and stop sending traffic to this server.
        // 当终止时，关闭readiness
        close(s.readinessStopCh)

        time.Sleep(s.ShutdownDelayDuration)
    }()

    // 执行非阻塞Run
    // close socket after delayed stopCh
    err := s.NonBlockingRun(delayedStopCh)
    if err != nil {
        return err
    }

    <-stopCh

    // run shutdown hooks directly. This includes deregistering from the kubernetes endpoint in case of kube-apiserver.
    // 关闭前执行一些hook操作
    err = s.RunPreShutdownHooks()
    if err != nil {
        return err
    }

    // wait for the delayed stopCh before closing the handler chain (it rejects everything after Wait has been called).
    <-delayedStopCh

    // 等待所有请求执行完
    // Wait for all requests to finish, which are bounded by the RequestTimeout variable.
    s.HandlerChainWaitGroup.Wait()

    return nil
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行<code>NonBlockingRun</code><br><code>k8s.io/kubernetes/staging/src/k8s.io/apiserver/pkg/server/genericapiserver.go:351</code></p>
<pre class="line-numbers language-golang"><code class="language-golang">func (s preparedGenericAPIServer) NonBlockingRun(stopCh <-chan struct{}) error {
    auditStopCh := make(chan struct{})

    // 1. 判断是否要启动审计日志
    if s.AuditBackend != nil {
        if err := s.AuditBackend.Run(auditStopCh); err != nil {
            return fmt.Errorf("failed to run the audit backend: %v", err)
        }
    }

    // 2. 启动 https server
    internalStopCh := make(chan struct{})
    var stoppedCh <-chan struct{}
    if s.SecureServingInfo != nil && s.Handler != nil {
        var err error
        stoppedCh, err = s.SecureServingInfo.Serve(s.Handler, s.ShutdownTimeout, internalStopCh)
        if err != nil {
            close(internalStopCh)
            close(auditStopCh)
            return err
        }
    }

    go func() {
        <-stopCh
        close(s.readinessStopCh)
        close(internalStopCh)
        if stoppedCh != nil {
            <-stoppedCh
        }
        s.HandlerChainWaitGroup.Wait()
        close(auditStopCh)
    }()

    // 3. 执行 postStartHooks
    s.RunPostStartHooks(stopCh)

    // 4. 向 systemd 发送 ready 信号
    if _, err := systemd.SdNotify(true, "READY=1\n"); err != nil {
        klog.Errorf("Unable to send systemd daemon successful start message: %v\n", err)
    }

    return nil
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="调用链分析"><a href="#调用链分析" class="headerlink" title="调用链分析"></a>调用链分析</h2><p>上一节简单分析了Apiserver的启动流程，通过初始化各种配置，封装调用链，启动Server。这节主要分析调用链。</p>
<p>初始化阶段, 通过<code>CreateServerChain</code>创建调用链， 代码在<a href="https://github.com/kubernetes/kubernetes/blob/1d057da2f73118893b5cc27c15d59ff03beb271e/cmd/kube-apiserver/app/server.go#L169" target="_blank" rel="noopener">server.go</a></p>
<pre class="line-numbers language-golang"><code class="language-golang">// CreateServerChain creates the apiservers connected via delegation.
func CreateServerChain(completedOptions completedServerRunOptions, stopCh <-chan struct{}) (*aggregatorapiserver.APIAggregator, error) {
  // nodetunneler与node通信，proxy实现代理功能，转发请求给其他apiservice
  // apiserver到cluster的通信可以通过三种方法
  // apiserver到kubelet的endpoint，用于logs功能，exec功能，port-forward功能
  // HTTP连接，即使可以用HTTPS也不做任何其他校验，并不安全
  // ssh tunnel，不推荐使用

  nodeTunneler, proxyTransport, err := CreateNodeDialer(completedOptions)
    // 1. 为 kubeAPIServer 创建配置
    kubeAPIServerConfig, insecureServingInfo, serviceResolver, pluginInitializer, admissionPostStartHook, err :=                                         CreateKubeAPIServerConfig(completedOptions, nodeTunneler, proxyTransport)
    if err != nil {
        return nil, err
    }

    // 2. 判断是否配置了 APIExtensionsServer，创建 apiExtensionsConfig 
    apiExtensionsConfig, err := createAPIExtensionsConfig(*kubeAPIServerConfig.GenericConfig, kubeAPIServerConfig.ExtraConfig.VersionedInformers,        pluginInitializer, completedOptions.ServerRunOptions, completedOptions.MasterCount,vc
        serviceResolver, webhook.NewDefaultAuthenticationInfoResolverWrapper(proxyTransport, kubeAPIServerConfig.GenericConfig.LoopbackClientConfig))
    if err != nil {
        return nil, err
    }

    // 3. 初始化 APIExtensionsServer, 通过一个空的delegate初始化
    apiExtensionsServer, err := createAPIExtensionsServer(apiExtensionsConfig, genericapiserver.NewEmptyDelegate())
    if err != nil {
        return nil, err
    }

    // 4. 初始化 KubeAPIServer
    kubeAPIServer, err := CreateKubeAPIServer(kubeAPIServerConfig, apiExtensionsServer.GenericAPIServer, admissionPostStartHook)
    if err != nil {
        return nil, err
    }

    // 5. 创建 AggregatorConfig
    aggregatorConfig, err := createAggregatorConfig(*kubeAPIServerConfig.GenericConfig, completedOptions.ServerRunOptions, kubeAPIServerConfig.          ExtraConfig.VersionedInformers, serviceResolver, proxyTransport, pluginInitializer)
    if err != nil {
        return nil, err
    }

    // 6. 初始化 AggregatorServer
    aggregatorServer, err := createAggregatorServer(aggregatorConfig, kubeAPIServer.GenericAPIServer, apiExtensionsServer.Informers)
    if err != nil {
        return nil, err
    }

    // 7. 判断是否启动非安全端口的 http server
    if insecureServingInfo != nil {
        insecureHandlerChain := kubeserver.BuildInsecureHandlerChain(aggregatorServer.GenericAPIServer.UnprotectedHandler(), kubeAPIServerConfig.GenericConfig)
        if err := insecureServingInfo.Serve(insecureHandlerChain, kubeAPIServerConfig.GenericConfig.RequestTimeout, stopCh); err != nil {
            return nil, err
        }
    }
    return aggregatorServer, nil
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建过程主要有以下步骤：</p>
<ol>
<li>根据配置构造apiserver的配置，调用方法<code>CreateKubeAPIServerConfig</code></li>
<li>根据配置构造扩展的apiserver的配置，调用方法为<code>createAPIExtensionsConfig</code></li>
<li>创建server，包括扩展的apiserver和原生的apiserver，调用方法为<code>createAPIExtensionsServer</code>和<code>CreateKubeAPIServer</code>。主要就是将各个handler的路由方法注册到Container中去，完全遵循go-restful的设计模式，即将处理方法注册到Route中去，同一个根路径下的Route注册到WebService中去，WebService注册到Container中，Container负责分发。访问的过程为<code>Container--&gt;WebService--&gt;Route</code></li>
<li>聚合server的配置和和创建。主要就是将原生的apiserver和扩展的apiserver的访问进行整合，添加后续的一些处理接口。调用方法为<code>createAggregatorConfig</code>和<code>createAggregatorServer</code></li>
<li>创建完成，返回配置的server信息</li>
</ol>
<p>以上几个步骤，最核心的就是apiserver如何创建，即如何按照go-restful的模式，添加路由和相应的处理方法。</p>
<h3 id="配置初始化"><a href="#配置初始化" class="headerlink" title="配置初始化"></a>配置初始化</h3><p>先看apiserver配置的创建<code>CreateKubeAPIServerConfig-&gt;buildGenericConfig-&gt;genericapiserver.NewConfig</code></p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token comment" spellcheck="true">// BuildGenericConfig takes the master server options and produces the genericapiserver.Config associated with it</span>
<span class="token keyword">func</span> <span class="token function">buildGenericConfig</span><span class="token punctuation">(</span>
    s <span class="token operator">*</span>options<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span>
    proxyTransport <span class="token operator">*</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span>
    genericConfig <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">,</span>
    versionedInformers clientgoinformers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">,</span>
    insecureServingInfo <span class="token operator">*</span>genericapiserver<span class="token punctuation">.</span>DeprecatedInsecureServingInfo<span class="token punctuation">,</span>
    serviceResolver aggregatorapiserver<span class="token punctuation">.</span>ServiceResolver<span class="token punctuation">,</span>
    pluginInitializers <span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">,</span>
    admissionPostStartHook genericapiserver<span class="token punctuation">.</span>PostStartHookFunc<span class="token punctuation">,</span>
    storageFactory <span class="token operator">*</span>serverstorage<span class="token punctuation">.</span>DefaultStorageFactory<span class="token punctuation">,</span>
    lastErr <span class="token builtin">error</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 创建genericConfig,其中包括DefaultBuildHandlerChain，一系列认证授权的中间件</span>
    genericConfig <span class="token operator">=</span> genericapiserver<span class="token punctuation">.</span><span class="token function">NewConfig</span><span class="token punctuation">(</span>legacyscheme<span class="token punctuation">.</span>Codecs<span class="token punctuation">)</span>
    genericConfig<span class="token punctuation">.</span>MergedResourceConfig <span class="token operator">=</span> master<span class="token punctuation">.</span><span class="token function">DefaultAPIResourceConfigSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 初始化各种配置</span>
    <span class="token keyword">if</span> lastErr <span class="token operator">=</span> s<span class="token punctuation">.</span>GenericServerRunOptions<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>genericConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> lastErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>

    genericConfig<span class="token punctuation">.</span>OpenAPIConfig <span class="token operator">=</span> genericapiserver<span class="token punctuation">.</span><span class="token function">DefaultOpenAPIConfig</span><span class="token punctuation">(</span>generatedopenapi<span class="token punctuation">.</span>GetOpenAPIDefinitions<span class="token punctuation">,</span> openapinamer<span class="token punctuation">.</span><span class="token function">NewDefinitionNamer</span><span class="token punctuation">(</span>legacyscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> extensionsapiserver<span class="token punctuation">.</span>Scheme<span class="token punctuation">,</span> aggregatorscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">)</span>
    genericConfig<span class="token punctuation">.</span>OpenAPIConfig<span class="token punctuation">.</span>Info<span class="token punctuation">.</span>Title <span class="token operator">=</span> <span class="token string">"Kubernetes"</span>
    <span class="token comment" spellcheck="true">// 长连接请求</span>
    genericConfig<span class="token punctuation">.</span>LongRunningFunc <span class="token operator">=</span> filters<span class="token punctuation">.</span><span class="token function">BasicLongRunningRequestCheck</span><span class="token punctuation">(</span>
        sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span><span class="token string">"watch"</span><span class="token punctuation">,</span> <span class="token string">"proxy"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span><span class="token string">"attach"</span><span class="token punctuation">,</span> <span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token string">"proxy"</span><span class="token punctuation">,</span> <span class="token string">"log"</span><span class="token punctuation">,</span> <span class="token string">"portforward"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    kubeVersion <span class="token operator">:=</span> version<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    genericConfig<span class="token punctuation">.</span>Version <span class="token operator">=</span> <span class="token operator">&amp;</span>kubeVersion

    <span class="token comment" spellcheck="true">// 初始化storageFactory， 用来连接etcd</span>
    storageFactoryConfig <span class="token operator">:=</span> kubeapiserver<span class="token punctuation">.</span><span class="token function">NewStorageFactoryConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    storageFactoryConfig<span class="token punctuation">.</span>APIResourceConfig <span class="token operator">=</span> genericConfig<span class="token punctuation">.</span>MergedResourceConfig
    completedStorageFactoryConfig<span class="token punctuation">,</span> err <span class="token operator">:=</span> storageFactoryConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Etcd<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        lastErr <span class="token operator">=</span> err
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    storageFactory<span class="token punctuation">,</span> lastErr <span class="token operator">=</span> completedStorageFactoryConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> lastErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> genericConfig<span class="token punctuation">.</span>EgressSelector <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        storageFactory<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Transport<span class="token punctuation">.</span>EgressLookup <span class="token operator">=</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">.</span>Lookup
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> lastErr <span class="token operator">=</span> s<span class="token punctuation">.</span>Etcd<span class="token punctuation">.</span><span class="token function">ApplyWithStorageFactoryTo</span><span class="token punctuation">(</span>storageFactory<span class="token punctuation">,</span> genericConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> lastErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Use protobufs for self-communication.</span>
    <span class="token comment" spellcheck="true">// Since not every generic apiserver has to support protobufs, we</span>
    <span class="token comment" spellcheck="true">// cannot default to it in generic apiserver and need to explicitly</span>
    <span class="token comment" spellcheck="true">// set it in kube-apiserver.</span>
    <span class="token comment" spellcheck="true">// 内部使用protobufs通信</span>
    genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">.</span>ContentConfig<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"application/vnd.kubernetes.protobuf"</span>
    <span class="token comment" spellcheck="true">// Disable compression for self-communication, since we are going to be</span>
    <span class="token comment" spellcheck="true">// on a fast local network</span>
    genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">.</span>DisableCompression <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token comment" spellcheck="true">// clientset初始化</span>
    kubeClientConfig <span class="token operator">:=</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig
    clientgoExternalClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> clientgoclientset<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>kubeClientConfig<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create real external clientset: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    versionedInformers <span class="token operator">=</span> clientgoinformers<span class="token punctuation">.</span><span class="token function">NewSharedInformerFactory</span><span class="token punctuation">(</span>clientgoExternalClient<span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">// 初始化认证实例，支持多种认证方式：requestheader,token, tls等</span>
    genericConfig<span class="token punctuation">.</span>Authentication<span class="token punctuation">.</span>Authenticator<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>OpenAPIConfig<span class="token punctuation">.</span>SecurityDefinitions<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">BuildAuthenticator</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> clientgoExternalClient<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid authentication config: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 初始化鉴权配置</span>
    genericConfig<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Authorizer<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>RuleResolver<span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token function">BuildAuthorizer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid authorization config: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>sets<span class="token punctuation">.</span><span class="token function">NewString</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>Authorization<span class="token punctuation">.</span>Modes<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Has</span><span class="token punctuation">(</span>modes<span class="token punctuation">.</span>ModeRBAC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        genericConfig<span class="token punctuation">.</span>DisabledPostStartHooks<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>rbacrest<span class="token punctuation">.</span>PostStartHookName<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 初始化admission webhook的配置</span>
    admissionConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>kubeapiserveradmission<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
        ExternalInformers<span class="token punctuation">:</span>    versionedInformers<span class="token punctuation">,</span>
        LoopbackClientConfig<span class="token punctuation">:</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>
        CloudConfigFile<span class="token punctuation">:</span>      s<span class="token punctuation">.</span>CloudProvider<span class="token punctuation">.</span>CloudConfigFile<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    serviceResolver <span class="token operator">=</span> <span class="token function">buildServiceResolver</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>EnableAggregatorRouting<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>

    authInfoResolverWrapper <span class="token operator">:=</span> webhook<span class="token punctuation">.</span><span class="token function">NewDefaultAuthenticationInfoResolverWrapper</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>

    lastErr <span class="token operator">=</span> s<span class="token punctuation">.</span>Audit<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>
        genericConfig<span class="token punctuation">,</span>
        genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>
        versionedInformers<span class="token punctuation">,</span>
        serveroptions<span class="token punctuation">.</span><span class="token function">NewProcessInfo</span><span class="token punctuation">(</span><span class="token string">"kube-apiserver"</span><span class="token punctuation">,</span> <span class="token string">"kube-system"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>serveroptions<span class="token punctuation">.</span>WebhookOptions<span class="token punctuation">{</span>
            AuthInfoResolverWrapper<span class="token punctuation">:</span> authInfoResolverWrapper<span class="token punctuation">,</span>
            ServiceResolver<span class="token punctuation">:</span>         serviceResolver<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> lastErr <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 初始化注入插件</span>
    pluginInitializers<span class="token punctuation">,</span> admissionPostStartHook<span class="token punctuation">,</span> err <span class="token operator">=</span> admissionConfig<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>proxyTransport<span class="token punctuation">,</span> genericConfig<span class="token punctuation">.</span>EgressSelector<span class="token punctuation">,</span> serviceResolver<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create admission plugin initializer: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    err <span class="token operator">=</span> s<span class="token punctuation">.</span>Admission<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>
        genericConfig<span class="token punctuation">,</span>
        versionedInformers<span class="token punctuation">,</span>
        kubeClientConfig<span class="token punctuation">,</span>
        feature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">,</span>
        pluginInitializers<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        lastErr <span class="token operator">=</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to initialize admission: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>genericfeatures<span class="token punctuation">.</span>APIPriorityAndFairness<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span>GenericServerRunOptions<span class="token punctuation">.</span>EnablePriorityAndFairness <span class="token punctuation">{</span>
        genericConfig<span class="token punctuation">.</span>FlowControl <span class="token operator">=</span> <span class="token function">BuildPriorityAndFairness</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> clientgoExternalClient<span class="token punctuation">,</span> versionedInformers<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="APIExtensionsServer初始化"><a href="#APIExtensionsServer初始化" class="headerlink" title="APIExtensionsServer初始化"></a>APIExtensionsServer初始化</h3><p><code>APIExtensionsServer</code>最先初始化，在调用链的末尾, 处理CR、CRD相关资源.</p>
<p>其中包含的 controller 以及功能如下所示：</p>
<ol>
<li>openapiController：将 crd 资源的变化同步至提供的 OpenAPI 文档，可通过访问 /openapi/v2 进行查看；</li>
<li>crdController：负责将 crd 信息注册到 apiVersions 和 apiResources 中，两者的信息可通过 $ kubectl api-versions 和 $ kubectl api-resources 查看；</li>
<li>namingController：检查 crd obj 中是否有命名冲突，可在 crd .status.conditions 中查看；</li>
<li>establishingController：检查 crd 是否处于正常状态，可在 crd .status.conditions 中查看；</li>
<li>nonStructuralSchemaController：检查 crd obj 结构是否正常，可在 crd .status.conditions 中查看；</li>
<li>apiApprovalController：检查 crd 是否遵循 kubernetes API 声明策略，可在 crd .status.conditions 中查看；</li>
<li>finalizingController：类似于 finalizes 的功能，与 CRs 的删除有关；</li>
</ol>
<p><code>createAPIExtensionsServer</code>调用<code>apiextensionsConfig.Complete().New(delegateAPIServer)</code></p>
<p><code>k8s.io/kubernetes/staging/src/k8s.io/apiextensions-apiserver/pkg/apiserver/apiserver.go:132</code></p>
<pre class="line-numbers language-golang"><code class="language-golang">/ New returns a new instance of CustomResourceDefinitions from the given config.
func (c completedConfig) New(delegationTarget genericapiserver.DelegationTarget) (*CustomResourceDefinitions, error) {
    // 初始化 genericServer
    genericServer, err := c.GenericConfig.New("apiextensions-apiserver", delegationTarget)
    if err != nil {
        return nil, err
    }

    s := &CustomResourceDefinitions{
        GenericAPIServer: genericServer,
    }

    // 初始化apigroup, 即需要暴露的api，这里extension apiserver只注册了cr于crd相关的
    apiResourceConfig := c.GenericConfig.MergedResourceConfig
    apiGroupInfo := genericapiserver.NewDefaultAPIGroupInfo(apiextensions.GroupName, Scheme, metav1.ParameterCodec, Codecs)
    if apiResourceConfig.VersionEnabled(v1beta1.SchemeGroupVersion) {
        storage := map[string]rest.Storage{}
        // customresourcedefinitions
        customResourceDefintionStorage := customresourcedefinition.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)
        storage["customresourcedefinitions"] = customResourceDefintionStorage
        storage["customresourcedefinitions/status"] = customresourcedefinition.NewStatusREST(Scheme, customResourceDefintionStorage)

        apiGroupInfo.VersionedResourcesStorageMap[v1beta1.SchemeGroupVersion.Version] = storage
    }
    if apiResourceConfig.VersionEnabled(v1.SchemeGroupVersion) {
        storage := map[string]rest.Storage{}
        // customresourcedefinitions
        customResourceDefintionStorage := customresourcedefinition.NewREST(Scheme, c.GenericConfig.RESTOptionsGetter)
        storage["customresourcedefinitions"] = customResourceDefintionStorage
        storage["customresourcedefinitions/status"] = customresourcedefinition.NewStatusREST(Scheme, customResourceDefintionStorage)

        apiGroupInfo.VersionedResourcesStorageMap[v1.SchemeGroupVersion.Version] = storage
    }

    // 注册apigroup
    if err := s.GenericAPIServer.InstallAPIGroup(&apiGroupInfo); err != nil {
        return nil, err
    }

    // clientset创建
    crdClient, err := clientset.NewForConfig(s.GenericAPIServer.LoopbackClientConfig)
    if err != nil {
        // it's really bad that this is leaking here, but until we can fix the test (which I'm pretty sure isn't even testing what it wants to test),
        // we need to be able to move forward
        return nil, fmt.Errorf("failed to create clientset: %v", err)
    }
    s.Informers = externalinformers.NewSharedInformerFactory(crdClient, 5*time.Minute)

    // 创建各种handler
    delegateHandler := delegationTarget.UnprotectedHandler()
    if delegateHandler == nil {
        delegateHandler = http.NotFoundHandler()
    }

    versionDiscoveryHandler := &versionDiscoveryHandler{
        discovery: map[schema.GroupVersion]*discovery.APIVersionHandler{},
        delegate:  delegateHandler,
    }
    groupDiscoveryHandler := &groupDiscoveryHandler{
        discovery: map[string]*discovery.APIGroupHandler{},
        delegate:  delegateHandler,
    }
    establishingController := establish.NewEstablishingController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())
    crdHandler, err := NewCustomResourceDefinitionHandler(
        versionDiscoveryHandler,
        groupDiscoveryHandler,
        s.Informers.Apiextensions().V1().CustomResourceDefinitions(),
        delegateHandler,
        c.ExtraConfig.CRDRESTOptionsGetter,
        c.GenericConfig.AdmissionControl,
        establishingController,
        c.ExtraConfig.ServiceResolver,
        c.ExtraConfig.AuthResolverWrapper,
        c.ExtraConfig.MasterCount,
        s.GenericAPIServer.Authorizer,
        c.GenericConfig.RequestTimeout,
        time.Duration(c.GenericConfig.MinRequestTimeout)*time.Second,
        apiGroupInfo.StaticOpenAPISpec,
        c.GenericConfig.MaxRequestBodyBytes,
    )
    if err != nil {
        return nil, err
    }
    s.GenericAPIServer.Handler.NonGoRestfulMux.Handle("/apis", crdHandler)
    s.GenericAPIServer.Handler.NonGoRestfulMux.HandlePrefix("/apis/", crdHandler)

    discoveryController := NewDiscoveryController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), versionDiscoveryHandler, groupDiscoveryHandler)
    namingController := status.NewNamingConditionController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())
    nonStructuralSchemaController := nonstructuralschema.NewConditionController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())
    apiApprovalController := apiapproval.NewKubernetesAPIApprovalPolicyConformantConditionController(s.Informers.Apiextensions().V1().CustomResourceDefinitions(), crdClient.ApiextensionsV1())
    finalizingController := finalizer.NewCRDFinalizer(
        s.Informers.Apiextensions().V1().CustomResourceDefinitions(),
        crdClient.ApiextensionsV1(),
        crdHandler,
    )
    openapiController := openapicontroller.NewController(s.Informers.Apiextensions().V1().CustomResourceDefinitions())

    // 加入到启动hook中
    s.GenericAPIServer.AddPostStartHookOrDie("start-apiextensions-informers", func(context genericapiserver.PostStartHookContext) error {
        s.Informers.Start(context.StopCh)
        return nil
    })
    s.GenericAPIServer.AddPostStartHookOrDie("start-apiextensions-controllers", func(context genericapiserver.PostStartHookContext) error {
        // OpenAPIVersionedService and StaticOpenAPISpec are populated in generic apiserver PrepareRun().
        // Together they serve the /openapi/v2 endpoint on a generic apiserver. A generic apiserver may
        // choose to not enable OpenAPI by having null openAPIConfig, and thus OpenAPIVersionedService
        // and StaticOpenAPISpec are both null. In that case we don't run the CRD OpenAPI controller.
        if s.GenericAPIServer.OpenAPIVersionedService != nil && s.GenericAPIServer.StaticOpenAPISpec != nil {
            go openapiController.Run(s.GenericAPIServer.StaticOpenAPISpec, s.GenericAPIServer.OpenAPIVersionedService, context.StopCh)
        }

        go namingController.Run(context.StopCh)
        go establishingController.Run(context.StopCh)
        go nonStructuralSchemaController.Run(5, context.StopCh)
        go apiApprovalController.Run(5, context.StopCh)
        go finalizingController.Run(5, context.StopCh)

        discoverySyncedCh := make(chan struct{})
        go discoveryController.Run(context.StopCh, discoverySyncedCh)
        select {
        case <-context.StopCh:
        case <-discoverySyncedCh:
        }

        return nil
    })
    // we don't want to report healthy until we can handle all CRDs that have already been registered.  Waiting for the informer
    // to sync makes sure that the lister will be valid before we begin.  There may still be races for CRDs added after startup,
    // but we won't go healthy until we can handle the ones already present.
    s.GenericAPIServer.AddPostStartHookOrDie("crd-informer-synced", func(context genericapiserver.PostStartHookContext) error {
        return wait.PollImmediateUntil(100*time.Millisecond, func() (bool, error) {
            return s.Informers.Apiextensions().V1().CustomResourceDefinitions().Informer().HasSynced(), nil
        }, context.StopCh)
    })

    return s, nil
}
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>c.GenericConfig.New</code>来初始化<code>genericapiserver</code>,包裹一些默认链，创建handler</p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c completedConfig<span class="token punctuation">)</span> <span class="token function">New</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> delegationTarget DelegationTarget<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>GenericAPIServer<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>Serializer <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Genericapiserver.New() called with config.Serializer == nil"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>LoopbackClientConfig <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Genericapiserver.New() called with config.LoopbackClientConfig == nil"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> c<span class="token punctuation">.</span>EquivalentResourceRegistry <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Genericapiserver.New() called with config.EquivalentResourceRegistry == nil"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 包裹了DefaultBuildHandlerChain</span>
    handlerChainBuilder <span class="token operator">:=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>handler http<span class="token punctuation">.</span>Handler<span class="token punctuation">)</span> http<span class="token punctuation">.</span>Handler <span class="token punctuation">{</span>
        <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">BuildHandlerChainFunc</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Config<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 创建apiserverhandler</span>
    apiServerHandler <span class="token operator">:=</span> <span class="token function">NewAPIServerHandler</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Serializer<span class="token punctuation">,</span> handlerChainBuilder<span class="token punctuation">,</span> delegationTarget<span class="token punctuation">.</span><span class="token function">UnprotectedHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token operator">...</span>

    <span class="token keyword">return</span> s<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>APIServerHandler</code>包含多种<code>http.Handler</code>类型，包括<code>go-restful</code>以及<code>non-go-restful</code>，以及在以上两者之间选择的<code>Director</code>对象，<code>go-restful</code>用于处理已经注册的handler，<code>non-go-restful用来处理不存在的handler，API URI处理的选择过程为：</code>FullHandlerChain-&gt; Director -&gt;{GoRestfulContainer， NonGoRestfulMux}<code>。</code>NewAPIServerHandler`</p>
<pre><code>func NewAPIServerHandler(name string, s runtime.NegotiatedSerializer, handlerChainBuilder HandlerChainBuilderFn, notFoundHandler http.Handler) *APIServerHandler {
    // non-go-restful路由
    nonGoRestfulMux := mux.NewPathRecorderMux(name)
    if notFoundHandler != nil {
        nonGoRestfulMux.NotFoundHandler(notFoundHandler)
    }

    // go-resetful路由
    gorestfulContainer := restful.NewContainer()
    gorestfulContainer.ServeMux = http.NewServeMux()
    gorestfulContainer.Router(restful.CurlyRouter{}) // e.g. for proxy/{kind}/{name}/{*}
    gorestfulContainer.RecoverHandler(func(panicReason interface{}, httpWriter http.ResponseWriter) {
        logStackOnRecover(s, panicReason, httpWriter)
    })
    gorestfulContainer.ServiceErrorHandler(func(serviceErr restful.ServiceError, request *restful.Request, response *restful.Response) {
        serviceErrorHandler(s, serviceErr, request, response)
    })

    // 选择器, 根据path选择是否执行go-restful，注册过的path执行go-restful
    director := director{
        name:               name,
        goRestfulContainer: gorestfulContainer,
        nonGoRestfulMux:    nonGoRestfulMux,
    }

    return &amp;APIServerHandler{
        FullHandlerChain:   handlerChainBuilder(director),
        GoRestfulContainer: gorestfulContainer,
        NonGoRestfulMux:    nonGoRestfulMux,
        Director:           director,
    }
}
</code></pre><p>以上是<code>APIExtensionsServer</code>的初始化流程，初始化Server, 调用<code>s.GenericAPIServer.InstallAPIGroup</code>注册api。此方法的调用链非常深，主要是为了将需要暴露的<code>API Resource</code>注册到 server 中，以便能通过 http 接口进行 resource 的 REST 操作，其他几种 server 在初始化时也都会执行对应的 <code>InstallAPI</code>方法。</p>
<h3 id="KubeAPIServer初始化"><a href="#KubeAPIServer初始化" class="headerlink" title="KubeAPIServer初始化"></a>KubeAPIServer初始化</h3><p>KubeAPIServer 主要是提供对 API Resource 的操作请求，为 kubernetes 中众多 API 注册路由信息，暴露 RESTful API 并且对外提供 kubernetes service，使集群中以及集群外的服务都可以通过 RESTful API 操作 kubernetes 中的资源。</p>
<p>与<code>APIExtensionsServer</code>，<code>KubeAPIServer</code>初始化流程如下</p>
<ol>
<li><code>CreateKubeAPIServer</code>调用<code>kubeAPIServerConfig.Complete().New</code>来初始化</li>
<li><code>New</code>函数创建默认的<code>apigroup</code>(pod,deployment等内部资源), 调用<code>InstallAPIs</code>注册</li>
<li>启动相关controller, 加入到<code>poststarthook</code></li>
</ol>
<h3 id="AggregatorServer初始化"><a href="#AggregatorServer初始化" class="headerlink" title="AggregatorServer初始化"></a>AggregatorServer初始化</h3><p><code>Aggregator</code>通过<code>APIServices</code>对象关联到某个<code>Service</code>来进行请求的转发，其关联的<code>Service</code>类型进一步决定了请求转发形式。<code>Aggregator</code>包括一个<code>GenericAPIServer</code>和维护自身状态的<code>Controller</code>。其中 <code>GenericAPIServer</code>主要处理<code>apiregistration.k8s.io</code>组下的<code>APIService</code>资源请求。</p>
<p><code>Aggregator</code>除了处理资源请求外还包含几个controller：</p>
<ol>
<li>apiserviceRegistrationController：负责<code>APIServices</code>中资源的注册与删除；</li>
<li>availableConditionController：维护<code>APIServices</code>的可用状态，包括其引用<code>Service</code>是否可用等；</li>
<li>autoRegistrationController：用于保持API中存在的一组特定的<code>APIServices</code>；</li>
<li>crdRegistrationController：负责将<code>CRD GroupVersions</code>自动注册到<code>APIServices</code>中；</li>
<li>openAPIAggregationController：将<code>APIServices</code>资源的变化同步至提供的<code>OpenAPI</code>文档；<br>kubernetes中的一些附加组件，比如metrics-server就是通过Aggregator的方式进行扩展的，实际环境中可以通过使用apiserver-builder工具轻松以Aggregator的扩展方式创建自定义资源。</li>
</ol>
<p>初始化AggregatorServer的主要逻辑为：</p>
<ol>
<li>调用<code>aggregatorConfig.Complete().NewWithDelegate</code>创建<code>aggregatorServer</code></li>
<li>初始化<code>crdRegistrationController</code>和<code>autoRegistrationController</code>，<code>crdRegistrationController</code>负责注册CRD，<code>autoRegistrationController</code>负责将 CRD 对应的 APIServices自动注册到apiserver中，CRD 创建后可通过<code>$ kubectl get apiservices</code>查看是否注册到 apiservices中</li>
<li>将<code>autoRegistrationController</code>和<code>crdRegistrationController</code>加入到PostStartHook中</li>
</ol>
<p>首先，初始化配置<code>createAggregatorConfig</code></p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">createAggregatorConfig</span><span class="token punctuation">(</span>
    kubeAPIServerConfig genericapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">,</span>
    commandOptions <span class="token operator">*</span>options<span class="token punctuation">.</span>ServerRunOptions<span class="token punctuation">,</span>
    externalInformers kubeexternalinformers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">,</span>
    serviceResolver aggregatorapiserver<span class="token punctuation">.</span>ServiceResolver<span class="token punctuation">,</span>
    proxyTransport <span class="token operator">*</span>http<span class="token punctuation">.</span>Transport<span class="token punctuation">,</span>
    pluginInitializers <span class="token punctuation">[</span><span class="token punctuation">]</span>admission<span class="token punctuation">.</span>PluginInitializer<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>aggregatorapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// make a shallow copy to let us twiddle a few things</span>
    <span class="token comment" spellcheck="true">// most of the config actually remains the same.  We only need to mess with a couple items related to the particulars of the aggregator</span>
    genericConfig <span class="token operator">:=</span> kubeAPIServerConfig
    genericConfig<span class="token punctuation">.</span>PostStartHooks <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>genericapiserver<span class="token punctuation">.</span>PostStartHookConfigEntry<span class="token punctuation">{</span><span class="token punctuation">}</span>
    genericConfig<span class="token punctuation">.</span>RESTOptionsGetter <span class="token operator">=</span> <span class="token boolean">nil</span>

    <span class="token comment" spellcheck="true">// override genericConfig.AdmissionControl with kube-aggregator's scheme,</span>
    <span class="token comment" spellcheck="true">// because aggregator apiserver should use its own scheme to convert its own resources.</span>
    <span class="token comment" spellcheck="true">// 取消admission的配置，aggregator自行处理请求，不需要admissions</span>
    err <span class="token operator">:=</span> commandOptions<span class="token punctuation">.</span>Admission<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>genericConfig<span class="token punctuation">,</span>
        externalInformers<span class="token punctuation">,</span>
        genericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">,</span>
        feature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">,</span>
        pluginInitializers<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// copy the etcd options so we don't mutate originals.</span>
    etcdOptions <span class="token operator">:=</span> <span class="token operator">*</span>commandOptions<span class="token punctuation">.</span>Etcd
    etcdOptions<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Paging <span class="token operator">=</span> utilfeature<span class="token punctuation">.</span>DefaultFeatureGate<span class="token punctuation">.</span><span class="token function">Enabled</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span>APIListChunking<span class="token punctuation">)</span>
    etcdOptions<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>Codec <span class="token operator">=</span> aggregatorscheme<span class="token punctuation">.</span>Codecs<span class="token punctuation">.</span><span class="token function">LegacyCodec</span><span class="token punctuation">(</span>v1beta1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">,</span> v1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">)</span>
    etcdOptions<span class="token punctuation">.</span>StorageConfig<span class="token punctuation">.</span>EncodeVersioner <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">NewMultiGroupVersioner</span><span class="token punctuation">(</span>v1beta1<span class="token punctuation">.</span>SchemeGroupVersion<span class="token punctuation">,</span> schema<span class="token punctuation">.</span>GroupKind<span class="token punctuation">{</span>Group<span class="token punctuation">:</span> v1beta1<span class="token punctuation">.</span>GroupName<span class="token punctuation">}</span><span class="token punctuation">)</span>
    genericConfig<span class="token punctuation">.</span>RESTOptionsGetter <span class="token operator">=</span> <span class="token operator">&amp;</span>genericoptions<span class="token punctuation">.</span>SimpleRestOptionsFactory<span class="token punctuation">{</span>Options<span class="token punctuation">:</span> etcdOptions<span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// override MergedResourceConfig with aggregator defaults and registry</span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> commandOptions<span class="token punctuation">.</span>APIEnablement<span class="token punctuation">.</span><span class="token function">ApplyTo</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>genericConfig<span class="token punctuation">,</span>
        aggregatorapiserver<span class="token punctuation">.</span><span class="token function">DefaultAPIResourceConfigSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        aggregatorscheme<span class="token punctuation">.</span>Scheme<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 配置proxy证书，用于apiserver与扩展服务的通信，使用requestheader证书签发</span>
    <span class="token keyword">var</span> certBytes<span class="token punctuation">,</span> keyBytes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>commandOptions<span class="token punctuation">.</span>ProxyClientCertFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>commandOptions<span class="token punctuation">.</span>ProxyClientKeyFile<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token punctuation">{</span>
        certBytes<span class="token punctuation">,</span> err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>commandOptions<span class="token punctuation">.</span>ProxyClientCertFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
        keyBytes<span class="token punctuation">,</span> err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>commandOptions<span class="token punctuation">.</span>ProxyClientKeyFile<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    aggregatorConfig <span class="token operator">:=</span> <span class="token operator">&amp;</span>aggregatorapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">{</span>
        GenericConfig<span class="token punctuation">:</span> <span class="token operator">&amp;</span>genericapiserver<span class="token punctuation">.</span>RecommendedConfig<span class="token punctuation">{</span>
            Config<span class="token punctuation">:</span>                genericConfig<span class="token punctuation">,</span>
            SharedInformerFactory<span class="token punctuation">:</span> externalInformers<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        ExtraConfig<span class="token punctuation">:</span> aggregatorapiserver<span class="token punctuation">.</span>ExtraConfig<span class="token punctuation">{</span>
            ProxyClientCert<span class="token punctuation">:</span> certBytes<span class="token punctuation">,</span>
            ProxyClientKey<span class="token punctuation">:</span>  keyBytes<span class="token punctuation">,</span>
            ServiceResolver<span class="token punctuation">:</span> serviceResolver<span class="token punctuation">,</span>
            <span class="token comment" spellcheck="true">// 代理请求的具体实现</span>
            ProxyTransport<span class="token punctuation">:</span>  proxyTransport<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// we need to clear the poststarthooks so we don't add them multiple times to all the servers (that fails)</span>
    <span class="token comment" spellcheck="true">// 加入PostStartHook</span>
    aggregatorConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>PostStartHooks <span class="token operator">=</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>genericapiserver<span class="token punctuation">.</span>PostStartHookConfigEntry<span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token keyword">return</span> aggregatorConfig<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>createAggregatorServer</code>初始化<code>Aggregator</code></p>
<pre class="line-numbers language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">createAggregatorServer</span><span class="token punctuation">(</span>aggregatorConfig <span class="token operator">*</span>aggregatorapiserver<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> delegateAPIServer genericapiserver<span class="token punctuation">.</span>DelegationTarget<span class="token punctuation">,</span> apiExtensionInformers apiextensionsinformers<span class="token punctuation">.</span>SharedInformerFactory<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>aggregatorapiserver<span class="token punctuation">.</span>APIAggregator<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 初始化配置，与前面流程相同</span>
    aggregatorServer<span class="token punctuation">,</span> err <span class="token operator">:=</span> aggregatorConfig<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">NewWithDelegate</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 创建auto-registration controller</span>
    apiRegistrationClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> apiregistrationclient<span class="token punctuation">.</span><span class="token function">NewForConfig</span><span class="token punctuation">(</span>aggregatorConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>LoopbackClientConfig<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    autoRegistrationController <span class="token operator">:=</span> autoregister<span class="token punctuation">.</span><span class="token function">NewAutoRegisterController</span><span class="token punctuation">(</span>aggregatorServer<span class="token punctuation">.</span>APIRegistrationInformers<span class="token punctuation">.</span><span class="token function">Apiregistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">APIServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> apiRegistrationClient<span class="token punctuation">)</span>
    apiServices <span class="token operator">:=</span> <span class="token function">apiServicesToRegister</span><span class="token punctuation">(</span>delegateAPIServer<span class="token punctuation">,</span> autoRegistrationController<span class="token punctuation">)</span>
    crdRegistrationController <span class="token operator">:=</span> crdregistration<span class="token punctuation">.</span><span class="token function">NewCRDRegistrationController</span><span class="token punctuation">(</span>
        apiExtensionInformers<span class="token punctuation">.</span><span class="token function">Apiextensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CustomResourceDefinitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        autoRegistrationController<span class="token punctuation">)</span>

    err <span class="token operator">=</span> aggregatorServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddPostStartHook</span><span class="token punctuation">(</span><span class="token string">"kube-apiserver-autoregistration"</span><span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>context genericapiserver<span class="token punctuation">.</span>PostStartHookContext<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 启动controller</span>
        <span class="token keyword">go</span> crdRegistrationController<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
        <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// let the CRD controller process the initial set of CRDs before starting the autoregistration controller.</span>
            <span class="token comment" spellcheck="true">// this prevents the autoregistration controller's initial sync from deleting APIServices for CRDs that still exist.</span>
            <span class="token comment" spellcheck="true">// we only need to do this if CRDs are enabled on this server.  We can't use discovery because we are the source for discovery.</span>
            <span class="token keyword">if</span> aggregatorConfig<span class="token punctuation">.</span>GenericConfig<span class="token punctuation">.</span>MergedResourceConfig<span class="token punctuation">.</span><span class="token function">AnyVersionForGroupEnabled</span><span class="token punctuation">(</span><span class="token string">"apiextensions.k8s.io"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                crdRegistrationController<span class="token punctuation">.</span><span class="token function">WaitForInitialSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            autoRegistrationController<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>StopCh<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    err <span class="token operator">=</span> aggregatorServer<span class="token punctuation">.</span>GenericAPIServer<span class="token punctuation">.</span><span class="token function">AddBootSequenceHealthChecks</span><span class="token punctuation">(</span>
        <span class="token function">makeAPIServiceAvailableHealthCheck</span><span class="token punctuation">(</span>
            <span class="token string">"autoregister-completion"</span><span class="token punctuation">,</span>
            apiServices<span class="token punctuation">,</span>
            aggregatorServer<span class="token punctuation">.</span>APIRegistrationInformers<span class="token punctuation">.</span><span class="token function">Apiregistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">V1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">APIServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> aggregatorServer<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>至此，启动步骤以前分析完了，三个组件的流量大体时一样的，通过<code>Complete().New()</code>初始化配置，创建所需的controller, 调用<code>InstallAPIGroup</code>注册<code>apigroup</code>。</p>
<h2 id="请求分析"><a href="#请求分析" class="headerlink" title="请求分析"></a>请求分析</h2><p>上面我们分析了apiserver的调用链，大体如下<br><code>DefaultHandlerChain-&gt;{handler/crdhandler/proxy}-&gt;admission-&gt;validation-&gt;etcd</code></p>
<ol>
<li>请求进入时，会经过<code>defaultchain</code>做一些认证鉴权工作</li>
<li>然后通过<code>route</code>执行对应的handler，如果为aggration api, 将直接转发请求到对应service</li>
<li>handler处理完，经过admission与validation，做一些修改和检查，用户在这部分可以自定义webhook</li>
<li>最后存入etcd</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文大体对apiserver的启动流程，以及初始化过程做了分析，由于apiserver实现复杂，中间一些细节没涉及到，还需要对着代码研究研究。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[1] <a href="https://juejin.im/post/5c934e5a5188252d7c216981" target="_blank" rel="noopener">https://juejin.im/post/5c934e5a5188252d7c216981</a><br>[2] <a href="https://blog.tianfeiyu.com/2020/02/24/kube_apiserver/" target="_blank" rel="noopener">https://blog.tianfeiyu.com/2020/02/24/kube_apiserver/</a></p>

            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/k8s/">
                                    <span class="chip bg-color">k8s</span>
                                </a>
                            
                                <a href="/tags/apiserver/">
                                    <span class="chip bg-color">apiserver</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="wechat,weibo" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/libs/gitalk/gitalk.min.js">

<div class="card gitalk-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'a705189dfc18ec59a7d0',
        clientSecret: '17415910b55e24cdb8c1c8d72bc992a0457f193b',
        repo: 'qingwave.github.io',
        owner: 'qingwave',
        admin: "qingwave",
        id: '2020-04-24T15-28-16',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/kube-apiserver-aggretation-api/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/medias/featureimages/9.jpg" class="responsive-img" alt="kubernetes扩展apiserver实现分析">
                        
                        <span class="card-title">kubernetes扩展apiserver实现分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Kubernetes提供了丰富的扩展功能，实现自定义资源有两种方式CRD与Aggregation API。相对于CRD，扩展API功能更丰富，可以实现单独的存储。今天来聊一聊，k8s是如是实现扩展api的，它与apiserver之间又是如何
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-04-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/cloud/" class="post-category">
                                    cloud
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/k8s/">
                        <span class="chip bg-color">k8s</span>
                    </a>
                    
                    <a href="/tags/apiserver/">
                        <span class="chip bg-color">apiserver</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/kube-apiserver-authorization-code/">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/medias/featureimages/1.jpg" class="responsive-img" alt="kube-apiserver鉴权源码分析">
                        
                        <span class="card-title">kube-apiserver鉴权源码分析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            简介kube-apiserver中与权限相关的主要有三种机制，即认证、鉴权和准入控制。上节讲到认证流程。
认证与授权很容易混淆：

认证(Authentication), 负责检查你是谁，识别user
授权(Authorization), 
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-04-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/cloud/" class="post-category">
                                    cloud
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/k8s/">
                        <span class="chip bg-color">k8s</span>
                    </a>
                    
                    <a href="/tags/rbac/">
                        <span class="chip bg-color">rbac</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-mini waves-effect bnt-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="center-align">
            Copyright&nbsp;&copy;
            <span id="year">2018</span>
            <a href="https://qinng.now.sh" target="_blank">Qinng</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;&nbsp;<span
                >49.9k</span>&nbsp;
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_pv"
                    ></span>&nbsp;
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;&nbsp;<span id="busuanzi_value_site_uv"
                    ></span>&nbsp;
            </span>
            
            <br>
            
            <br>
            
        </div>
        <!-- <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/qingwave" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:isguory@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>

















    <a href="https://www.douban.com/people/69458430"
       target="_blank" data-tooltip="关注我的豆瓣: 69458430" data-position="top"
       data-delay="50">
        <i class="fa fa-inverse">豆</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div> -->
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/search.xml", 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-mini waves-effect" href="#!">
        <!-- <i class="fas fa-caret-up"></i> -->
        <!-- <i class="fas fa-chevron-up"></i> -->
        <i class="fas fa-angle-double-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    

    

    

    
    <script src="https://cdn.jsdelivr.net/gh/qingwave/qingwave.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
